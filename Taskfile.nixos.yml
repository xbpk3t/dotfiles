version: '3'

# Linux ä¸“ç”¨ä»»åŠ¡

vars:
  HOSTNAME:
    sh: hostname | tr '[:upper:]' '[:lower:]'

tasks:
  # ==================== NixOS æ¨¡æ¿ä»»åŠ¡ ====================

  update-input:
    desc: "Update specific flake input (usage: task nix:update-input INPUT=nixpkgs)"
    cmds:
      - nix flake lock --update-input "{{.INPUT}}" ./nix
    requires:
      vars: [INPUT]


  check-config:
    internal: true
    desc: "Check nix-darwin configuration syntax"
    cmds:
      - echo "ğŸ” Checking configuration syntax..."
      - nix flake check .
      - echo "âœ… Configuration syntax is valid"

  pin:
    cmds:
      - nix profile list # å·²ç» pin çš„åŒ…
      # nix profile add nixpkgs#<package-name>

  syntax-verify:
    desc: åˆ¤æ–­nixè¯­æ³•æ˜¯å¦æ­£ç¡® # nix-instantiate --parse /Users/luck/Desktop/dotfiles/nix/home/bash.nix > /dev/null && echo "Bash.nix syntax is valid
    cmd: nix-instantiate --parse {{.CLI_ARGS}} > /dev/null && echo "Bash.nix syntax is valid


  # ä» Justfile ç§»æ¤çš„é€šç”¨ Nix ä»»åŠ¡
  test:
    desc: "è¿è¡Œ eval æµ‹è¯•"
    cmds:
      - echo "ğŸ§ª æ­£åœ¨è¿è¡Œ eval æµ‹è¯•..."
      - nix eval .#evalTests --show-trace --print-build-logs --verbose

  repair-store:
    desc: "ä¿®å¤ Nix Store å¯¹è±¡"
    vars:
      paths: '{{.paths}}'
    cmds:
      - 'echo "ğŸ”§ æ­£åœ¨ä¿®å¤ Nix Store å¯¹è±¡: {{.paths}}"'
      - nix store repair {{.paths}}

  up-nix:
    desc: "æ›´æ–°æ‰€æœ‰ Nixpkgs è¾“å…¥"
    cmds:
      - echo "ğŸ“¦ æ­£åœ¨æ›´æ–°æ‰€æœ‰ Nixpkgs è¾“å…¥..."
      - nix flake update nixpkgs nixpkgs-stable nixpkgs-unstable nixpkgs-darwin nixpkgs-ollama
      - echo "âœ… æ‰€æœ‰ Nixpkgs è¾“å…¥æ›´æ–°å®Œæˆ"


  dev-shell:
    desc: "è¿›å…¥å¼€å‘ç¯å¢ƒ shell"
    cmds:
      - echo "ğŸš æ­£åœ¨è¿›å…¥å¼€å‘ç¯å¢ƒ..."
      - |
        if [[ "{{.OS}}" == "Darwin" ]]; then
          nix shell nixpkgs#git nixpkgs#neovim
        else
          nix shell nixpkgs#git nixpkgs#neovim nixpkgs#deploy-rs
        fi

  verify-store:
    desc: "éªŒè¯ Nix Store å®Œæ•´æ€§ï¼Œæ£€æŸ¥æŸåçš„ store å¯¹è±¡"
    cmds:
      - echo "ğŸ” æ­£åœ¨éªŒè¯ Nix Store å®Œæ•´æ€§..."
      - nix store verify --all
      - echo "âœ… Nix Store éªŒè¯å®Œæˆ"

  gcroot:
    desc: "æ˜¾ç¤ºæ‰€æœ‰è‡ªåŠ¨ GC æ ¹ç›®å½•"
    cmds:
      - echo "ğŸ“‚ Nix Store è‡ªåŠ¨ GC æ ¹ç›®å½•ï¼š"
      - ls -al /nix/var/nix/gcroots/auto/


  nixos-switch-template:
    desc: "NixOS åˆ‡æ¢æ¨¡æ¿ä»»åŠ¡ (ä½¿ç”¨ nixos-cli)"
    vars:
      name: '{{.name}}'
      mode: '{{.mode | default "default"}}'
    cmds:
      - echo "nixos-switch '{{.name}}' in '{{.mode}}' mode..."
      - echo "$(printf '=%.0s' {1..50})"
      - |
        if [[ "{{.mode}}" == "debug" ]]; then
          # Debug æ¨¡å¼ï¼šä½¿ç”¨è¯¦ç»†è¾“å‡º
          sudo nixos apply --verbose --show-trace
        else
          # é»˜è®¤æ¨¡å¼ï¼šä½¿ç”¨ nixos-cli
          sudo nixos switch
        fi



  # ==================== Linux ç³»ç»Ÿä»»åŠ¡ ====================

  shell:
    desc: "è¿›å…¥å¼€å‘ç¯å¢ƒ shell"
    cmds:
      - echo "ğŸš æ­£åœ¨è¿›å…¥å¼€å‘ç¯å¢ƒ..."
      - nix shell nixpkgs#git nixpkgs#neovim nixpkgs#deploy-rs

  deploy-list:
    desc: "åˆ—å‡º deploy-rs èŠ‚ç‚¹"
    cmds:
      - 'nix eval --raw .#deploy.nodes --apply "x: builtins.concatStringsSep \"\\n\" (builtins.attrNames x)"'

  deploy:
    desc: "deploy-rs éƒ¨ç½²ï¼ˆæ”¯æŒå¤šé€‰ï¼‰"
    cmds:
      - |
        hosts="$(nix eval --raw .#deploy.nodes --apply "x: builtins.concatStringsSep \"\\n\" (builtins.attrNames x)" | gum choose --no-limit --header "é€‰æ‹©èŠ‚ç‚¹ï¼ˆå¯å¤šé€‰ï¼‰")"
        if [[ -z "$hosts" ]]; then
          echo "No node selected"
          exit 1
        fi
        while IFS= read -r host; do
          nix run github:serokell/deploy-rs -- ".#${host}"
        done <<< "$hosts"

  deploy-profile:
    desc: "deploy-rs éƒ¨ç½²æŒ‡å®š profile"
    vars:
      HOST:
        sh: 'nix eval --raw .#deploy.nodes --apply "x: builtins.concatStringsSep \"\\n\" (builtins.attrNames x)" | gum choose --header "é€‰æ‹©èŠ‚ç‚¹"'
      PROFILE:
        sh: 'gum input --prompt "Profile åç§° (é»˜è®¤ system): "'
    cmds:
      - |
        profile="{{.PROFILE}}"
        if [[ -z "$profile" ]]; then
          nix run github:serokell/deploy-rs -- .#{{.HOST}}
        else
          nix run github:serokell/deploy-rs -- .#{{.HOST}}."$profile"
        fi
