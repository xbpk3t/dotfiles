version: '3'

# Linux ä¸“ç”¨ä»»åŠ¡

vars:
  HOSTNAME:
    sh: hostname | tr '[:upper:]' '[:lower:]'

tasks:
  # ==================== NixOS æ¨¡æ¿ä»»åŠ¡ ====================


  update:
    desc: "æ›´æ–°æ‰€æœ‰ flake åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œå¹¶æŸ¥çœ‹æ›´æ–°å†…å®¹"
    cmds:
      # - task: upgrade
      - nix flake update # nix flake update --flake ./nix
      - nix flake show


  update-input:
    desc: "Update specific flake input (usage: task nix:update-input INPUT=nixpkgs)"
    cmds:
      - nix flake lock --update-input "{{.INPUT}}" ./nix
    requires:
      vars: [INPUT]


  check-config:
    internal: true
    desc: "Check nix-darwin configuration syntax"
    cmds:
      - echo "ğŸ” Checking configuration syntax..."
      - nix flake check .
      - echo "âœ… Configuration syntax is valid"

  pin:
    cmds:
      - nix profile list # å·²ç» pin çš„åŒ…
      # nix profile add nixpkgs#<package-name>

  syntax-verify:
    desc: åˆ¤æ–­nixè¯­æ³•æ˜¯å¦æ­£ç¡® # nix-instantiate --parse /Users/luck/Desktop/dotfiles/nix/home/bash.nix > /dev/null && echo "Bash.nix syntax is valid
    cmd: nix-instantiate --parse {{.CLI_ARGS}} > /dev/null && echo "Bash.nix syntax is valid


  # ä» Justfile ç§»æ¤çš„é€šç”¨ Nix ä»»åŠ¡
  test:
    desc: "è¿è¡Œ eval æµ‹è¯•"
    cmds:
      - echo "ğŸ§ª æ­£åœ¨è¿è¡Œ eval æµ‹è¯•..."
      - nix eval .#evalTests --show-trace --print-build-logs --verbose

  repair-store:
    desc: "ä¿®å¤ Nix Store å¯¹è±¡"
    vars:
      paths: '{{.paths}}'
    cmds:
      - 'echo "ğŸ”§ æ­£åœ¨ä¿®å¤ Nix Store å¯¹è±¡: {{.paths}}"'
      - nix store repair {{.paths}}

  up-nix:
    desc: "æ›´æ–°æ‰€æœ‰ Nixpkgs è¾“å…¥"
    cmds:
      - echo "ğŸ“¦ æ­£åœ¨æ›´æ–°æ‰€æœ‰ Nixpkgs è¾“å…¥..."
      - nix flake update nixpkgs nixpkgs-stable nixpkgs-unstable nixpkgs-darwin nixpkgs-ollama
      - echo "âœ… æ‰€æœ‰ Nixpkgs è¾“å…¥æ›´æ–°å®Œæˆ"


  dev-shell:
    desc: "è¿›å…¥å¼€å‘ç¯å¢ƒ shell"
    cmds:
      - echo "ğŸš æ­£åœ¨è¿›å…¥å¼€å‘ç¯å¢ƒ..."
      - |
        if [[ "{{.OS}}" == "Darwin" ]]; then
          nix shell nixpkgs#git nixpkgs#neovim
        else
          nix shell nixpkgs#git nixpkgs#neovim nixpkgs#deploy-rs
        fi

  verify-store:
    desc: "éªŒè¯ Nix Store å®Œæ•´æ€§ï¼Œæ£€æŸ¥æŸåçš„ store å¯¹è±¡"
    cmds:
      - echo "ğŸ” æ­£åœ¨éªŒè¯ Nix Store å®Œæ•´æ€§..."
      - nix store verify --all
      - echo "âœ… Nix Store éªŒè¯å®Œæˆ"

  gcroot:
    desc: "æ˜¾ç¤ºæ‰€æœ‰è‡ªåŠ¨ GC æ ¹ç›®å½•"
    cmds:
      - echo "ğŸ“‚ Nix Store è‡ªåŠ¨ GC æ ¹ç›®å½•ï¼š"
      - ls -al /nix/var/nix/gcroots/auto/


  nixos-switch-template:
    desc: "NixOS åˆ‡æ¢æ¨¡æ¿ä»»åŠ¡ (ä½¿ç”¨ nixos-cli)"
    vars:
      name: '{{.name}}'
      mode: '{{.mode | default "default"}}'
    cmds:
      - echo "nixos-switch '{{.name}}' in '{{.mode}}' mode..."
      - echo "$(printf '=%.0s' {1..50})"
      - |
        if [[ "{{.mode}}" == "debug" ]]; then
          # Debug æ¨¡å¼ï¼šä½¿ç”¨è¯¦ç»†è¾“å‡º
          sudo nixos apply --verbose --show-trace
        else
          # é»˜è®¤æ¨¡å¼ï¼šä½¿ç”¨ nixos-cli
          sudo nixos switch
        fi



  # ==================== Linux ç³»ç»Ÿä»»åŠ¡ ====================

  shell:
    desc: "è¿›å…¥å¼€å‘ç¯å¢ƒ shell"
    cmds:
      - echo "ğŸš æ­£åœ¨è¿›å…¥å¼€å‘ç¯å¢ƒ..."
      - nix shell nixpkgs#git nixpkgs#neovim nixpkgs#deploy-rs

  deploy-list:
    desc: "åˆ—å‡º deploy-rs èŠ‚ç‚¹"
    cmds:
      - 'nix eval --raw .#deploy.nodes --apply "x: builtins.concatStringsSep \"\\n\" (builtins.attrNames x)"'

  deploy:
    desc: "deploy-rs éƒ¨ç½²ï¼ˆé»˜è®¤ system profileï¼‰"
    vars:
      HOST:
        sh: 'nix eval --raw .#deploy.nodes --apply "x: builtins.concatStringsSep \"\\n\" (builtins.attrNames x)" | gum choose --header "é€‰æ‹©èŠ‚ç‚¹"'
    cmds:
      - nix run github:serokell/deploy-rs -- .#{{.HOST}}

  deploy-profile:
    desc: "deploy-rs éƒ¨ç½²æŒ‡å®š profile"
    vars:
      HOST:
        sh: 'nix eval --raw .#deploy.nodes --apply "x: builtins.concatStringsSep \"\\n\" (builtins.attrNames x)" | gum choose --header "é€‰æ‹©èŠ‚ç‚¹"'
      PROFILE:
        sh: 'gum input --prompt "Profile åç§° (é»˜è®¤ system): "'
    cmds:
      - |
        profile="{{.PROFILE}}"
        if [[ -z "$profile" ]]; then
          nix run github:serokell/deploy-rs -- .#{{.HOST}}
        else
          nix run github:serokell/deploy-rs -- .#{{.HOST}}."$profile"
        fi




#  ç”¨é€”ï¼šè·Ÿè¸ªæŸä¸ªåº”ç”¨ç¨‹åºçš„æ–‡ä»¶è®¿é—®è¡Œä¸ºã€‚
#  åˆ†æï¼š
#  ä½¿ç”¨ strace å·¥å…·è·Ÿè¸ªæŒ‡å®šåº”ç”¨ï¼ˆ{{.app}}ï¼‰çš„æ–‡ä»¶ç›¸å…³ç³»ç»Ÿè°ƒç”¨ï¼Œç»“åˆå‚æ•°ï¼ˆ{{.args}}ï¼‰ã€‚
#  è¿‡æ»¤æ‰æ— å…³è·¯å¾„ï¼ˆå¦‚ /nix/storeã€/newrootã€/procï¼‰ï¼Œæå–å¹¶æ•´ç†è®¿é—®çš„æ–‡ä»¶è·¯å¾„ï¼ˆå»é‡å¹¶æ’åºï¼‰ã€‚
#  ä½¿ç”¨åœºæ™¯ï¼šè°ƒè¯•æˆ–åˆ†æç¨‹åºçš„æ–‡ä»¶ä¾èµ–ï¼Œæ£€æŸ¥å“ªäº›æ–‡ä»¶è¢«ç¨‹åºå®é™…è®¿é—®ï¼ˆä¾‹å¦‚ï¼Œæ’æŸ¥é…ç½®ç¼ºå¤±æˆ–æƒé™é—®é¢˜ï¼‰ã€‚
#  ç¤ºä¾‹ï¼šè¿è¡Œ trace-access app=notepad args="--file test.txt" å¯ä»¥æŸ¥çœ‹ Notepad è®¿é—®äº†å“ªäº›æ–‡ä»¶ã€‚
  trace-access:
    desc: "è·Ÿè¸ªæ–‡ä»¶è®¿é—®"
    vars:
      app: '{{.app}}'
      args: '{{.args | default ""}}'
    cmds:
      - strace -f -t -e trace=file {{.app}} {{.args}} | complete | grep -v -E "(/nix/store|/newroot|/proc)" | grep -o '"(/.*)"' | sort | uniq

#  ç”¨é€”ï¼šæŸ¥çœ‹æŒ‡å®šè¿›ç¨‹çš„ç¯å¢ƒå˜é‡ã€‚
#  åˆ†æï¼š
#
#  é€šè¿‡è¯»å– /proc/{{.pid}}/environ æ–‡ä»¶ï¼Œè·å–æŒ‡å®šè¿›ç¨‹ IDï¼ˆ{{.pid}}ï¼‰çš„ç¯å¢ƒå˜é‡ï¼Œå¹¶å°†ç»“æœæ ¼å¼åŒ–ï¼ˆå°†ç©ºå­—ç¬¦ \0 æ›¿æ¢ä¸ºæ¢è¡Œç¬¦ \nï¼‰ã€‚
#  éœ€è¦ sudo æƒé™ä»¥è®¿é—® /proc ä¸‹çš„æ–‡ä»¶ã€‚
#  ä½¿ç”¨åœºæ™¯ï¼šè°ƒè¯•è¿›ç¨‹è¿è¡Œç¯å¢ƒï¼Œæ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®è®¾ç½®ï¼ˆä¾‹å¦‚ï¼Œæ’æŸ¥ PATH æˆ–è‡ªå®šä¹‰å˜é‡é—®é¢˜ï¼‰ã€‚
#  ç¤ºä¾‹ï¼šè¿è¡Œ penvof pid=1234 å¯ä»¥åˆ—å‡º PID ä¸º 1234 çš„è¿›ç¨‹çš„æ‰€æœ‰ç¯å¢ƒå˜é‡ã€‚
  penvof:
    desc: "æŸ¥çœ‹è¿›ç¨‹ç¯å¢ƒå˜é‡"
    vars:
      pid: '{{.pid}}'
    cmds:
      - sudo cat "/proc/{{.pid}}/environ" | tr '\0' '\n'
