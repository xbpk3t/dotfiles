version: '3'

vars:
  # 配置：统一的 SOPS secrets 源文件（唯一真相）
  SOPS_FILE: secrets.yaml
  # 配置：age 私钥文件路径，可通过环境变量 SOPS_AGE_KEY_FILE 覆盖
  AGE_KEY_FILE: '{{.SOPS_AGE_KEY_FILE | default "age.key"}}'
  # 配置：Kubernetes Secret 名称
  K8S_SECRET_NAME: cluster-secrets
  # 配置：Kubernetes 命名空间
  K8S_NAMESPACE: flux-system
  # 配置：生成的集群 Secret 输出目录
  OUTPUT_DIR: ../manifests/config/secrets
  # 配置：生成的集群 Secret 输出文件
  OUTPUT_FILE: '{{.OUTPUT_DIR}}/cluster-secrets.sops.yaml'
  # 配置：SOPS 加密字段匹配规则
  SOPS_ENCRYPTED_REGEX: '^(data|stringData)$'

tasks:
  default:
    desc: "生成集群用的 SOPS Secret（入口任务）"
    deps:
      - k8s:generate

  k8s:check:
    desc: "检查 secrets 与 age 私钥是否存在"
    preconditions:
      - sh: test -f "{{.SOPS_FILE}}"
        msg: "找不到 SOPS 文件: {{.SOPS_FILE}}"
      - sh: test -f "{{.AGE_KEY_FILE}}"
        msg: "找不到 age 私钥文件: {{.AGE_KEY_FILE}}（可通过环境变量 SOPS_AGE_KEY_FILE 指定）"
      - sh: command -v sops >/dev/null 2>&1
        msg: "缺少依赖：sops"
      - sh: command -v yq >/dev/null 2>&1
        msg: "缺少依赖：yq"
      - sh: command -v jq >/dev/null 2>&1
        msg: "缺少依赖：jq"
      - sh: command -v age-keygen >/dev/null 2>&1
        msg: "缺少依赖：age-keygen"

  k8s:ensure-output-dir:
    desc: "确保输出目录存在"
    cmds:
      - 'mkdir -p "{{.OUTPUT_DIR}}"'

  k8s:generate:
    desc: "渲染并加密集群 Secret"
    deps:
      - k8s:check
      - k8s:ensure-output-dir
    vars:
      # 配置：由私钥派生的 age 公钥（用于加密输出）
      AGE_PUBLIC_KEY:
        sh: 'age-keygen -y "{{.AGE_KEY_FILE}}"'
    sources:
      - '{{.SOPS_FILE}}'
      - '{{.AGE_KEY_FILE}}'
    generates:
      - '{{.OUTPUT_FILE}}'
    cmds:
      - |
          set -euo pipefail

          SOPS_AGE_KEY_FILE="{{.AGE_KEY_FILE}}" sops -d "{{.SOPS_FILE}}" | \
            yq eval -o=json '.' - | \
            jq -c '
              del(.sops) as $s |
              {
                apiVersion: "v1",
                kind: "Secret",
                metadata: {
                  name: "{{.K8S_SECRET_NAME}}",
                  namespace: "{{.K8S_NAMESPACE}}"
                },
                stringData: (
                  [ $s | paths(scalars) as $p
                    | { ( $p | map(tostring) | join("_") | ascii_upcase ):
                        ( $s | getpath($p) // "" | tostring )
                      }
                  ] | add
                )
              }
            ' | \
            yq eval -o=yaml - | \
            SOPS_CONFIG=/dev/null sops --encrypt --age "{{.AGE_PUBLIC_KEY}}" --encrypted-regex '{{.SOPS_ENCRYPTED_REGEX}}' \
              --input-type yaml --output-type yaml /dev/stdin > "{{.OUTPUT_FILE}}"

          echo "已生成: {{.OUTPUT_FILE}}"
