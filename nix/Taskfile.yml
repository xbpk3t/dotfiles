version: '3'

includes:
  nix-lint: ./Taskfile.nix.yml
  age: ./secrets/Taskfile.yml


# Nix-Darwin management tasks
# Converted from rich-demo Justfile with additional migration functionality

vars:
  NIX_DIR: '.'
  HOSTNAME:
    sh: scutil --get ComputerName | tr ' ' '-' | tr '[:upper:]' '[:lower:]'
  SYSTEM:
    sh: |
      if [[ $(uname -m) == "arm64" ]]; then
        echo "aarch64-darwin"
      else
        echo "x86_64-darwin"
      fi
  OS:
    sh: uname
  USERNAME:
    sh: whoami
  # Default cleanup days for maintenance tasks
  CLEANUP_DAYS: '{{.CLEANUP_DAYS | default "1"}}'
  # Nix store path
  NIX_STORE_PATH: '/nix/store'
  # System profile path
  SYSTEM_PROFILE: '/nix/var/nix/profiles/system'
  # Colors for output
  GREEN: '\033[1;32m'
  YELLOW: '\033[1;33m'
  RED: '\033[1;31m'
  NC: '\033[0m'


tasks:
  default:
    desc: "æ„å»ºå¹¶åˆ‡æ¢åˆ°å½“å‰ç³»ç»Ÿé…ç½®"
    cmds:
      - task: build-switch

  # === æ ¸å¿ƒæ„å»ºä»»åŠ¡ ===
  build:
    desc: "æ„å»ºç³»ç»Ÿé…ç½®ï¼ˆä¸åˆ‡æ¢ï¼‰"
    dir: '{{.NIX_DIR}}'
    cmds:
      - echo -e "{{.YELLOW}}æ­£åœ¨ä¸º {{.HOSTNAME}} ({{.SYSTEM}}) æ„å»º {{.OS}} é…ç½®...{{.NC}}"
      - |
        if [[ "{{.OS}}" == "Darwin" ]]; then
          nix build .#darwinConfigurations.{{.HOSTNAME}}.system --extra-experimental-features 'nix-command flakes'
        else
          nix build .#nixosConfigurations.{{.HOSTNAME}}.config.system.build.toplevel --extra-experimental-features 'nix-command flakes'
        fi
      - echo -e "{{.GREEN}}æ„å»ºå®Œæˆï¼{{.NC}}"

  build-switch:
    desc: "æ„å»ºå¹¶åˆ‡æ¢åˆ°æ–°é…ç½®"
    dir: '{{.NIX_DIR}}'
    cmds:
      - echo -e "{{.YELLOW}}æ­£åœ¨æ„å»ºå¹¶åˆ‡æ¢ {{.OS}} é…ç½®...{{.NC}}"
      - |
        if [[ "{{.OS}}" == "Darwin" ]]; then
          sudo darwin-rebuild switch --flake .#{{.HOSTNAME}}
        else
          sudo nixos-rebuild switch --flake .#{{.HOSTNAME}}
        fi
      - echo -e "{{.GREEN}}åˆ‡æ¢åˆ°æ–°é…ç½®å®Œæˆï¼{{.NC}}"

  # === é…ç½®è®¾ç½® ===
  apply:
    desc: "äº¤äº’å¼ç”¨æˆ·é…ç½®è®¾ç½®ï¼ˆæ›¿ä»£ apps/applyï¼‰"
    dir: '{{.NIX_DIR}}'
    interactive: true
    cmds:
      - echo "=== Nix Configuration Setup ==="
      - task: check-prerequisites
      - task: build-switch
      - echo "Configuration applied successfully!"

  check-prerequisites:
    desc: "æ£€æŸ¥ç³»ç»Ÿå…ˆå†³æ¡ä»¶"
    internal: true
    cmds:
      - echo "Checking prerequisites..."
      - git config --get user.name || echo "Git user.name not configured"
      - git config --get user.email || echo "Git user.email not configured"
      - which nix || echo "Nix not found in PATH"
      - echo "Prerequisites check complete"


  darwin:
    desc: "æ„å»ºå¹¶åˆ‡æ¢åˆ° nix-darwin é…ç½®"
    dir: '{{.NIX_DIR}}'
    cmds:
      - echo -e "{{.YELLOW}}ğŸš€ æ­£åœ¨ä¸º {{.HOSTNAME}} ({{.SYSTEM}}) æ„å»º nix-darwin é…ç½®...{{.NC}}"
      - nix build .#darwinConfigurations.{{.HOSTNAME}}.system --extra-experimental-features 'nix-command flakes'
      - echo -e "{{.YELLOW}}ğŸ”„ æ­£åœ¨åˆ‡æ¢åˆ°æ–°é…ç½®...{{.NC}}"
      - sudo darwin-rebuild switch --flake .#{{.HOSTNAME}}
      - echo -e "{{.GREEN}}âœ… nix-darwin é…ç½®åº”ç”¨æˆåŠŸï¼{{.NC}}"

  darwin-debug:
    desc: "ä½¿ç”¨è¯¦ç»†è¾“å‡ºæ„å»ºå¹¶åˆ‡æ¢ï¼ˆç”¨äºè°ƒè¯•ï¼‰"
    dir: '{{.NIX_DIR}}'
    cmds:
      - echo -e "{{.YELLOW}}ğŸ› æ­£åœ¨ä½¿ç”¨è°ƒè¯•è¾“å‡ºæ„å»º nix-darwin é…ç½®...{{.NC}}"
      - nix build .#darwinConfigurations.{{.HOSTNAME}}.system --show-trace --verbose --extra-experimental-features 'nix-command flakes'
      - echo -e "{{.YELLOW}}ğŸ”„ æ­£åœ¨ä½¿ç”¨è°ƒè¯•è¾“å‡ºåˆ‡æ¢...{{.NC}}"
      - sudo darwin-rebuild switch --flake .#{{.HOSTNAME}} --show-trace --verbose

  # Migration tasks (from apply-migration.sh)
  migrate:
    desc: "Apply nix-darwin migration and cleanup Homebrew packages"
    deps: [darwin]
    cmds:
      - task: cleanup-homebrew
      - task: verify-migration

  cleanup-homebrew:
    desc: "Remove packages that have been migrated to nix"
    vars:
      PACKAGES_TO_REMOVE: "go gum helm neovim fzf atuin git"
    cmds:
      - echo "ğŸ§¹ Cleaning up migrated Homebrew packages..."
      - for: {var: PACKAGES_TO_REMOVE, split: ' '}
        cmd: |
          if brew list --formula | grep -q "^{{.ITEM}}$"; then
            echo "  Removing {{.ITEM}}..."
            brew uninstall "{{.ITEM}}" || echo "    Warning: Could not uninstall {{.ITEM}}"
          else
            echo "  {{.ITEM}} not installed, skipping"
          fi
      - echo "âœ… Homebrew cleanup completed"

  verify-migration:
    desc: "Verify that migrated packages are working"
    vars:
      COMMANDS_TO_CHECK: "go gum helm nvim fzf atuin git"
    cmds:
      - echo "ğŸ” Verifying migration results..."
      - echo "Checking nix packages:"
      - for: {var: COMMANDS_TO_CHECK, split: ' '}
        cmd: |
          if command -v "{{.ITEM}}" >/dev/null 2>&1; then
            echo "  âœ… {{.ITEM}}: $(which "{{.ITEM}}")"
          else
            echo "  âŒ {{.ITEM}}: not found"
          fi
      - task: verify-shell-config
      - task: verify-system-config

  verify-shell-config:
    desc: "Verify shell configuration"
    internal: true
    cmds:
      - echo "Checking shell configuration:"
      - echo "  Current shell:" "$SHELL"
      - echo "  zsh version:" "$(zsh --version 2>/dev/null || echo 'not found')"

  verify-system-config:
    desc: "Verify system configuration"
    internal: true
    cmds:
      - echo "Checking system configuration:"
      - echo "  Dock icon size:" "$(defaults read com.apple.dock tilesize 2>/dev/null || echo 'not set')"
      - echo "  Finder show hidden files:" "$(defaults read com.apple.finder AppleShowAllFiles 2>/dev/null || echo 'not set')"

  # Nix related commands
  update:
    desc: "Update all flake inputs"
    dir: '{{.NIX_DIR}}'
    cmds:
      - nix flake update

  update-input:
    desc: "Update specific flake input (usage: task nix:update-input INPUT=nixpkgs)"
    dir: '{{.NIX_DIR}}'
    cmds:
      - nix flake update "{{.INPUT}}"
    requires:
      vars: [INPUT]

  history:
    desc: "List all generations of the system profile"
    cmds:
      - nix profile history --profile /nix/var/nix/profiles/system

  repl:
    desc: "Open a nix repl with the flake"
    dir: '{{.NIX_DIR}}'
    cmds:
      - nix repl -f flake:nixpkgs

  clean:
    desc: "Remove system generations older than specified days (default: 7)"
    cmds:
      - echo "ğŸ§¹ Cleaning old system generations (older than {{.CLEANUP_DAYS}} days)..."
      - sudo nix profile wipe-history --profile "{{.SYSTEM_PROFILE}}" --older-than "{{.CLEANUP_DAYS}}d"
      - echo "âœ… System generations cleaned"

  clean-home:
    desc: "Clean home-manager generations"
    internal: true
    cmds:
      - echo "ğŸ§¹ Cleaning home-manager generations..."
      - nix profile wipe-history --profile ~/.local/state/nix/profiles/home-manager --older-than "{{.CLEANUP_DAYS}}d" 2>/dev/null || echo "No home-manager profile found"

  gc:
    desc: "Garbage collect unused nix store entries"
    cmds:
      - echo "ğŸ—‘ï¸  Running garbage collection (older than {{.CLEANUP_DAYS}} days)..."
      # - sudo nix-collect-garbage --delete-older-than "{{.CLEANUP_DAYS}}d"
      - nix-collect-garbage --delete-older-than "{{.CLEANUP_DAYS}}d"
      - echo "âœ… Garbage collection completed"

  optimize:
    desc: "Optimize nix store to save disk space"
    cmds:
      - echo "ğŸ”§ Optimizing Nix store..."
      - nix store optimise
      - echo "âœ… Store optimization completed"

  disk-usage:
    desc: "Show disk usage information"
    cmds:
      - echo "ğŸ’¾ Disk Usage Information:"
      - echo "Nix store size:"
      - du -sh "{{.NIX_STORE_PATH}}" 2>/dev/null || echo "  Could not read nix store size"
      - echo "Home directory size:"
      - du -sh ~ 2>/dev/null || echo "  Could not read home directory size"

  maintenance:
    desc: "Run full maintenance (clean + gc + optimize)"
    deps: [disk-usage]
    cmds:
      - echo "ğŸ› ï¸  Running full maintenance..."
      - task: clean
      - task: clean-home
      - task: gc
      - task: optimize
      - task: disk-usage
      - echo "âœ… Full maintenance completed"

  fmt:
    desc: "Format nix files in the repository"
    dir: '{{.NIX_DIR}}'
    cmds:
      - nix fmt

  gcroot:
    desc: "Show all auto gc roots in the nix store"
    cmds:
      - ls -al /nix/var/nix/gcroots/auto/

  # Utility tasks
  info:
    desc: "Show system information"
    cmds:
      - echo "System Information:"
      - echo "  Hostname:" "{{.HOSTNAME}}"
      - echo "  System:" "{{.SYSTEM}}"
      - echo "  Nix Dir:" "{{.NIX_DIR}}"
      - echo "  Current User:" "$(whoami)"
      - echo "  macOS Version:" "$(sw_vers -productVersion)"
      - echo "  Nix Version:" "$(nix --version 2>/dev/null || echo 'not found')"

  check-config:
    desc: "Check nix-darwin configuration syntax"
    dir: '{{.NIX_DIR}}'
    cmds:
      - echo "ğŸ” Checking configuration syntax..."
      - nix flake check
      - echo "âœ… Configuration syntax is valid"

  lint:
    desc: "è¿è¡Œæ‰€æœ‰ Nix linting å·¥å…·"
    cmds:
      - echo "ğŸ” è¿è¡Œ Nix linting å·¥å…·..."
      - task: nix-lint:lint
      - echo "âœ… Nix linting å®Œæˆ"

#  status:
#    desc: "Show comprehensive system status"
#    silent: true
#    cmds:
#      - task: info
#      - task: disk-usage
#      - echo "Recent system generations:"
#      - nix profile history --profile "{{.SYSTEM_PROFILE}}" | head -10 || echo "  Could not read system profile history"
