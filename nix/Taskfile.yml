version: '3'

includes:
  lint: ./Taskfile.lint.yml
  sk: ./secrets/Taskfile.yml


# Nix-Darwin management tasks
# Converted from rich-demo Justfile with additional migration functionality

vars:
  NIX_DIR: './nix'
  HOSTNAME:
    sh: scutil --get ComputerName | tr ' ' '-' | tr '[:upper:]' '[:lower:]'
  SYSTEM:
    sh: |
      if [[ $(uname -m) == "arm64" ]]; then
        echo "aarch64-darwin"
      else
        echo "x86_64-darwin"
      fi
  OS:
    sh: uname
  USERNAME:
    sh: whoami
  # Default cleanup days for maintenance tasks
  CLEANUP_DAYS: '{{.CLEANUP_DAYS | default "3"}}'
  # Nix store path
  NIX_STORE_PATH: '/nix/store'
  # System profile path
  SYSTEM_PROFILE: '/nix/var/nix/profiles/system'
  # GitHub token pulled from gh CLI for GitHub API rate limits
  GITHUB_TOKEN:
    sh: gh auth token 2>/dev/null || echo ""

env:
  NIX_CONFIG: 'access-tokens = github.com={{.GITHUB_TOKEN}}'


tasks:
  default:
    desc: "ÊûÑÂª∫Âπ∂ÂàáÊç¢Âà∞ÂΩìÂâçÁ≥ªÁªüÈÖçÁΩÆ"
    cmds:
      - task: build-switch

  # === Ê†∏ÂøÉÊûÑÂª∫‰ªªÂä° ===
  build:
    desc: "ÊûÑÂª∫Á≥ªÁªüÈÖçÁΩÆÔºà‰∏çÂàáÊç¢Ôºâ"
    cmds:
      - echo "Ê≠£Âú®‰∏∫ {{.HOSTNAME}} ({{.SYSTEM}}) ÊûÑÂª∫ {{.OS}} ÈÖçÁΩÆ..."
      - |
        if [[ "{{.OS}}" == "Darwin" ]]; then
          nix build ./nix#darwinConfigurations.{{.HOSTNAME}}.system --extra-experimental-features 'nix-command flakes'
        else
          nix build ./nix#nixosConfigurations.{{.HOSTNAME}}.config.system.build.toplevel --extra-experimental-features 'nix-command flakes'
        fi
      - echo "ÊûÑÂª∫ÂÆåÊàêÔºÅ"

  build-switch:
    desc: "ÊûÑÂª∫Âπ∂ÂàáÊç¢Âà∞Êñ∞ÈÖçÁΩÆ"
    cmds:
      - echo "Ê≠£Âú®ÊûÑÂª∫Âπ∂ÂàáÊç¢ {{.OS}} ÈÖçÁΩÆ..."
      - |
        if [[ "{{.OS}}" == "Darwin" ]]; then
          sudo darwin-rebuild switch --flake ./nix#{{.HOSTNAME}}
        else
          sudo nixos-rebuild switch --flake ./nix#{{.HOSTNAME}}
        fi
      - echo "ÂàáÊç¢Âà∞Êñ∞ÈÖçÁΩÆÂÆåÊàêÔºÅ"


  darwin:
    desc: "ÊûÑÂª∫Âπ∂ÂàáÊç¢Âà∞ nix-darwin ÈÖçÁΩÆ"
    cmds:
      - echo "üöÄ Ê≠£Âú®‰∏∫ {{.HOSTNAME}} ({{.SYSTEM}}) ÊûÑÂª∫ nix-darwin ÈÖçÁΩÆ..."
      - nix build ./nix#darwinConfigurations.{{.HOSTNAME}}.system --extra-experimental-features 'nix-command flakes'
      - echo "üîÑ Ê≠£Âú®ÂàáÊç¢Âà∞Êñ∞ÈÖçÁΩÆ..."
      - sudo darwin-rebuild switch --flake ./nix#{{.HOSTNAME}}
      - echo "‚úÖ nix-darwin ÈÖçÁΩÆÂ∫îÁî®ÊàêÂäüÔºÅ"

  darwin-debug:
    desc: "‰ΩøÁî®ËØ¶ÁªÜËæìÂá∫ÊûÑÂª∫Âπ∂ÂàáÊç¢ÔºàÁî®‰∫éË∞ÉËØïÔºâ"
    cmds:
      - echo "üêõ Ê≠£Âú®‰ΩøÁî®Ë∞ÉËØïËæìÂá∫ÊûÑÂª∫ nix-darwin ÈÖçÁΩÆ..."
      - nix build ./nix#darwinConfigurations.{{.HOSTNAME}}.system --show-trace --verbose --extra-experimental-features 'nix-command flakes'
      - echo "üîÑ Ê≠£Âú®‰ΩøÁî®Ë∞ÉËØïËæìÂá∫ÂàáÊç¢..."
      - sudo darwin-rebuild switch --flake ./nix#{{.HOSTNAME}} --show-trace --verbose

  # Nix related commands
  update:
    desc: "Êõ¥Êñ∞ÊâÄÊúâ flake Âà∞ÊúÄÊñ∞ÁâàÊú¨ÔºåÂπ∂Êü•ÁúãÊõ¥Êñ∞ÂÜÖÂÆπ"
    cmds:
      - task: upgrade-nix
      - nix flake update # nix flake update --flake ./nix
      - nix flake show


  upgrade-nix:
    cmd: nix upgrade-nix

  update-input:
    desc: "Update specific flake input (usage: task nix:update-input INPUT=nixpkgs)"
    cmds:
      - nix flake lock --update-input "{{.INPUT}}" ./nix
    requires:
      vars: [INPUT]

  history:
    desc: "List all generations of the system profile"
    cmds:
      - nix profile history --profile /nix/var/nix/profiles/system

  repl:
    desc: "Open a nix repl with the flake"
    cmds:
      - bash -lc 'cd nix && nix repl -f flake:nixpkgs'

  fmt:
    desc: "Format nix files in the repository"
    dir: './nix'
    cmds:
      - nix fmt

  check-config:
    desc: "Check nix-darwin configuration syntax"
    cmds:
      - echo "üîç Checking configuration syntax..."
      - nix flake check ./nix
      - echo "‚úÖ Configuration syntax is valid"


  prune:
    desc:
    cmds:
      - task: clean
      - task: clean-home
      - task: gc


  clean:
    internal: true
    interactive: true
    silent: true
    desc: "Remove system generations older than specified days (default: 7)"
    cmds:
      - echo "üßπ Cleaning old system generations (older than {{.CLEANUP_DAYS}} days)..."
      - sudo nix profile wipe-history --profile "{{.SYSTEM_PROFILE}}" --older-than "{{.CLEANUP_DAYS}}d"
      - echo "‚úÖ System generations cleaned"

  clean-home:
    internal: true
    interactive: true
    silent: true
    desc: "Clean home-manager generations"
    cmds:
      - echo "üßπ Cleaning home-manager generations..."
      - nix profile wipe-history --profile ~/.local/state/nix/profiles/home-manager --older-than "{{.CLEANUP_DAYS}}d" 2>/dev/null || echo "No home-manager profile found"

  gc:
    internal: true
    interactive: true
    silent: true
    desc: "Garbage collect unused nix store entries"
    cmds:
      - echo "üóëÔ∏è  Running garbage collection (older than {{.CLEANUP_DAYS}} days)..."
      # - sudo nix-collect-garbage --delete-older-than "{{.CLEANUP_DAYS}}d"
      - nix-collect-garbage --delete-older-than "{{.CLEANUP_DAYS}}d"
      - echo "‚úÖ Garbage collection completed"


#  status:
#    desc: "Show comprehensive system status"
#    silent: true
#    cmds:
#      - task: info
#      - task: disk-usage
#      - echo "Recent system generations:"
#      - nix profile history --profile "{{.SYSTEM_PROFILE}}" | head -10 || echo "  Could not read system profile history"
