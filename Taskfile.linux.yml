version: '3'

# Linux ä¸“ç”¨ä»»åŠ¡

vars:
  HOSTNAME:
    sh: hostname | tr '[:upper:]' '[:lower:]'

tasks:
  # ==================== NixOS æ¨¡æ¿ä»»åŠ¡ ====================

  nixos-switch-template:
    desc: "NixOS åˆ‡æ¢æ¨¡æ¿ä»»åŠ¡"
    vars:
      name: '{{.name}}'
      mode: '{{.mode | default "default"}}'
    cmds:
      - echo "nixos-switch '{{.name}}' in '{{.mode}}' mode..."
      - echo "$(printf '=%.0s' {1..50})"
      - |
        if [[ "{{.mode}}" == "debug" ]]; then
          nom build "./nix#nixosConfigurations.{{.name}}.config.system.build.toplevel" --show-trace --verbose
          nixos-rebuild switch --sudo --flake "./nix#{{.name}}" --show-trace --verbose
        else
          nixos-rebuild switch --sudo --flake "./nix#{{.name}}"
        fi

  # ==================== Linux ç³»ç»Ÿä»»åŠ¡ ====================

  shell:
    desc: "è¿›å…¥å¼€å‘ç¯å¢ƒ shell"
    cmds:
      - echo "ğŸš æ­£åœ¨è¿›å…¥å¼€å‘ç¯å¢ƒ..."
      - nix shell nixpkgs#git nixpkgs#neovim nixpkgs#colmena

  trace-access:
    desc: "è·Ÿè¸ªæ–‡ä»¶è®¿é—®"
    vars:
      app: '{{.app}}'
      args: '{{.args | default ""}}'
    cmds:
      - strace -f -t -e trace=file {{.app}} {{.args}} | complete | grep -v -E "(/nix/store|/newroot|/proc)" | grep -o '"(/.*)"' | sort | uniq

  penvof:
    desc: "æŸ¥çœ‹è¿›ç¨‹ç¯å¢ƒå˜é‡"
    vars:
      pid: '{{.pid}}'
    cmds:
      - sudo cat "/proc/{{.pid}}/environ" | tr '\0' '\n'

  list-inactive:
    desc: "åˆ—å‡ºéæ´»è·ƒç³»ç»ŸæœåŠ¡"
    cmds:
      - systemctl list-units -all --state=inactive

  list-failed:
    desc: "åˆ—å‡ºå¤±è´¥çš„ç³»ç»ŸæœåŠ¡"
    cmds:
      - systemctl list-units -all --state=failed

  list-systemd:
    desc: "åˆ—å‡º systemd ç›¸å…³æœåŠ¡"
    cmds:
      - systemctl list-units systemd-*

  # ==================== Nixpkgs Review ä»»åŠ¡ ====================

  pkg-review:
    desc: "è¿è¡Œ nixpkgs-review å¯¹ PR"
    vars:
      pr: '{{.pr}}'
    cmds:
      - echo "ğŸ“¦ æ­£åœ¨è¿è¡Œ nixpkgs-review for PR #{{.pr}}..."
      - gh workflow run review.yml --repo ryan4yin/nixpkgs-review-gha -f x86_64-darwin=no -f post-result=true -f pr={{.pr}}

  pkg-test:
    desc: "è¿è¡ŒåŒ…æµ‹è¯•å¯¹ PR"
    vars:
      pr: '{{.pr}}'
      pname: '{{.pname}}'
    cmds:
      - echo "ğŸ§ª æ­£åœ¨è¿è¡ŒåŒ…æµ‹è¯• for PR #{{.pr}}: {{.pname}}..."
      - gh workflow run review.yml --repo ryan4yin/nixpkgs-review-gha -f x86_64-darwin=no -f post-result=true -f pr={{.pr}} -f extra-args="-p {{.pname}}.passthru.tests"

  pkg-summary:
    desc: "æŸ¥çœ‹ nixpkgs-review å·¥ä½œæµæ‘˜è¦"
    cmds:
      - echo "ğŸ“‹ æ­£åœ¨æŸ¥çœ‹ nixpkgs-review å·¥ä½œæµæ‘˜è¦..."
      - gh workflow view review.yml --repo ryan4yin/nixpkgs-review-gha
