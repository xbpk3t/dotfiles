---
# https://learn.netdata.cloud/docs/netdata-agent/installation/docker

name: netdata

services:
  netdata:
    image: netdata/netdata
    container_name: netdata
    pid: host
    network_mode: host
    restart: unless-stopped
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
    volumes:
      - netdataconfig:/etc/netdata
      - netdatalib:/var/lib/netdata
      - netdatacache:/var/cache/netdata
      - /:/host/root:ro,rslave
      - /etc/passwd:/host/etc/passwd:ro
      - /etc/group:/host/etc/group:ro
      - /etc/localtime:/etc/localtime:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /etc/os-release:/host/etc/os-release:ro
      - /var/log:/host/var/log:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /run/dbus:/run/dbus:ro

volumes:
  netdataconfig:
  netdatalib:
  netdatacache:




#{
#  config,
#  lib,
#  pkgs,
#  mylib,
#  ...
#}:
#with lib; let
#  cfg = config.modules.services.netdata;
#  listenPortStr = toString cfg.listenPort;
#in {
#  options.modules.services.netdata = {
#    enable = mkEnableOption "Netdata metrics collector";
#
#    listenAddress = mkOption {
#      type = types.str;
#      default = "127.0.0.1";
#      description = "Address Netdata binds to (defaults to localhost so it is only reachable via the reverse proxy).";
#    };
#
#    listenPort = mkOption {
#      type = types.port;
#      default = 19999;
#      description = "TCP port Netdata listens on.";
#    };
#
#    openFirewall = mkOption {
#      type = types.bool;
#      default = false;
#      description = "Also open the Netdata port on the host firewall.";
#    };
#
#    settings = mkOption {
#      type = types.attrs;
#      default = {};
#      description = "Pass-through options merged into services.netdata.* (except enable).";
#    };
#
#    ingress = mkOption {
#      type = types.nullOr (mylib.ingressOption "Netdata");
#      default = null;
#      description = "Expose Netdata through the shared reverse proxy.";
#    };
#  };
#
#  config = mkMerge [
#    (mkIf cfg.enable {
#      services.netdata =
#        (({
#          enable = true;
#          package = pkgs.netdata.override {withCloudUi = true;};
#
#          config = {
#            global = {
#              "history" = "86400";
#              "update every" = "1";
#              "memory mode" = "ram";
#              "error log" = "syslog";
#              "access log" = "none";
#              "debug flags" = "0x0000000000000000";
#              "hostname" = config.networking.hostName;
#            };
#
#            web = {
#              "mode" = "static-threaded";
#              "listen backlog" = "4096";
#              "default port" = listenPortStr;
#              "bind to" = "${cfg.listenAddress}:${listenPortStr}";
#              "disconnect idle clients after seconds" = "60";
#              "timeout for first request" = "60";
#              "accept a streaming request every seconds" = "0";
#              "respect do not track policy" = "no";
#              "x-frame-options response header" = "";
#              "access log" = "none";
#              "cors allowed origins" = "*";
#              "allow cross domain requests from" = "*";
#              "web files owner" = "root";
#              "web files group" = "root";
#              "web root path" = "${pkgs.netdata}/share/netdata/web";
#              "allow connections from" = "localhost *";
#              "allow dashboard from" = "localhost *";
#              "allow management from" = "localhost";
#              "allow badges from" = "*";
#              "allow streaming from" = "*";
#              "allow netdata.conf from" = "localhost";
#              "allow connections by dns" = "heuristic";
#              "allow dashboard by dns" = "heuristic";
#              "allow management by dns" = "no";
#              "enable gzip compression" = "yes";
#              "gzip compression strategy" = "default";
#              "gzip compression level" = "3";
#            };
#          };
#
#          plugins = {
#            go = {
#              enable = true;
#              extraPackages = ps:
#                with ps; [
#                  go
#                  go-tools
#                ];
#            };
#
#            python = {
#              enable = true;
#              extraPackages = ps:
#                with ps; [
#                  psutil
#                  pyyaml
#                ];
#            };
#
#            apps.enable = true;
#
#            node = {
#              enable = true;
#              extraPackages = ps:
#                with ps; [
#                  nodejs_20
#                ];
#            };
#
#            charts = {
#              enable = false;
#            };
#
#            ebpf = {
#              enable = true;
#              blacklist = [
#                "swap"
#              ];
#            };
#
#            go.d = {
#              enable = true;
#              configDir = {
#                "go.d.conf" = pkgs.writeText "go.d.conf" ''
#                  enabled: yes
#                  default_run: yes
#
#                  docker: yes
#                  systemd: yes
#                  nginx: no
#                  apache: no
#                '';
#              };
#            };
#
#            python.d = {
#              enable = true;
#              configDir = {
#                "python.d.conf" = pkgs.writeText "python.d.conf" ''
#                  enabled: yes
#                  default_run: yes
#
#                  nginx: no
#                  apache: no
#                  mysql: no
#                  postgres: no
#                  redis: no
#                  mongodb: no
#                '';
#              };
#            };
#
#            charts.d = {
#              enable = false;
#            };
#          };
#        }
#        // cfg.settings)
#        // {enable = true;};
#
#      networking.firewall.allowedTCPPorts =
#        mkIf cfg.openFirewall [cfg.listenPort];
#
#      users.users.netdata.extraGroups = ["docker" "systemd-journal"];
#
#      systemd.services.netdata = {
#        serviceConfig = {
#          Restart = "on-failure";
#          RestartSec = "30s";
#          LimitNOFILE = mkForce 30000;
#          PrivateTmp = true;
#          ProtectHome = "read-only";
#          ProtectSystem = "full";
#          AmbientCapabilities = [
#            "CAP_DAC_READ_SEARCH"
#            "CAP_SYS_PTRACE"
#          ];
#          CapabilityBoundingSet = [
#            "CAP_DAC_READ_SEARCH"
#            "CAP_SYS_PTRACE"
#            "CAP_SETUID"
#          ];
#        };
#      };
#    })
#
#    (mkIf (mylib.ingressEnabled cfg.ingress)
#      (mylib.mkReverseProxyIngress {
#        modulePath = "modules.services.netdata";
#        ingress = cfg.ingress;
#      })
#    )
#  ];
#}
_: {}
