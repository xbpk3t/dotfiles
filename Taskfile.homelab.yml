version: '3'

# Homelab & Kubernetes 相关任务

tasks:
  # ==================== Virtual Machines 模板任务 ====================

  upload-vm-template:
    desc: "上传 VM 镜像模板任务"
    vars:
      name: '{{.name}}'
      mode: '{{.mode | default "default"}}'
    cmds:
      - echo "upload-vm '{{.name}}' in '{{.mode}}' mode..."
      - echo "$(printf '=%.0s' {1..50})"
      - |
        TARGET="./nix#{{.name}}"
        if [[ "{{.mode}}" == "debug" ]]; then
          nom build $TARGET --show-trace --verbose
        else
          nix build $TARGET
        fi
      - rsync -avz --progress --copy-links --checksum result "ryan@rakushun:/data/caddy/fileserver/vms/kubevirt-{{.name}}.qcow2"

  # ==================== Colmena 远程部署 ====================

  col:
    desc: "Colmena 远程部署"
    vars:
      tag: '{{.tag}}'
    cmds:
      - echo "🚀 正在通过 Colmena 部署到标签 '{{.tag}}'..."
      - colmena apply --on '@{{tag}}' --verbose --show-trace

  upload-vm:
    desc: "上传 VM 镜像"
    vars:
      name: '{{.name}}'
      mode: '{{.mode | default "default"}}'
    cmds:
      - task: upload-vm-template
        vars: {name: "{{.name}}", mode: "{{.mode}}"}

  # ==================== KubeVirt 节点部署 ====================

  lab:
    desc: "部署所有 KubeVirt 节点"
    cmds:
      - echo "🏗️ 正在部署所有 KubeVirt 节点..."
      - colmena apply --on '@virt-*' --verbose --show-trace

  shoryu:
    desc: "部署 shoryu 节点"
    cmds:
      - echo "⚡ 正在部署 shoryu 节点..."
      - colmena apply --on '@kubevirt-shoryu' --verbose --show-trace

  shushou:
    desc: "部署 shushou 节点"
    cmds:
      - echo "🛡️ 正在部署 shushou 节点..."
      - colmena apply --on '@kubevirt-shushou' --verbose --show-trace

  youko:
    desc: "部署 youko 节点"
    cmds:
      - echo "🎯 正在部署 youko 节点..."
      - colmena apply --on '@kubevirt-youko' --verbose --show-trace

  # ==================== 其他 VM 节点部署 ====================

  aqua:
    desc: "部署 aqua 节点"
    cmds:
      - echo "💧 正在部署 aqua 节点..."
      - colmena apply --on '@aqua' --verbose --show-trace

  ruby:
    desc: "部署 ruby 节点"
    cmds:
      - echo "💎 正在部署 ruby 节点..."
      - colmena apply --on '@ruby' --verbose --show-trace

  kana:
    desc: "部署 kana 节点"
    cmds:
      - echo "🌸 正在部署 kana 节点..."
      - colmena apply --on '@kana' --verbose --show-trace

  # ==================== K3s 集群管理 ====================

  upload-k3s-prod:
    desc: "上传 K3s 生产环境 VM 镜像"
    vars:
      mode: '{{.mode | default "default"}}'
    cmds:
      - echo "🚀 正在上传 K3s 生产环境 VM 镜像..."
      - task: upload-vm-template
        vars: {name: "k3s-prod-1-master-1", mode: "{{.mode}}"}
      - task: upload-vm-template
        vars: {name: "k3s-prod-1-master-2", mode: "{{.mode}}"}
      - task: upload-vm-template
        vars: {name: "k3s-prod-1-master-3", mode: "{{.mode}}"}
      - task: upload-vm-template
        vars: {name: "k3s-prod-1-worker-1", mode: "{{.mode}}"}
      - task: upload-vm-template
        vars: {name: "k3s-prod-1-worker-2", mode: "{{.mode}}"}
      - task: upload-vm-template
        vars: {name: "k3s-prod-1-worker-3", mode: "{{.mode}}"}

  upload-k3s-test:
    desc: "上传 K3s 测试环境 VM 镜像"
    vars:
      mode: '{{.mode | default "default"}}'
    cmds:
      - echo "🧪 正在上传 K3s 测试环境 VM 镜像..."
      - task: upload-vm-template
        vars: {name: "k3s-test-1-master-1", mode: "{{.mode}}"}
      - task: upload-vm-template
        vars: {name: "k3s-test-1-master-2", mode: "{{.mode}}"}
      - task: upload-vm-template
        vars: {name: "k3s-test-1-master-3", mode: "{{.mode}}"}

  k3s-prod:
    desc: "部署 K3s 生产环境"
    cmds:
      - echo "🏭 正在部署 K3s 生产环境..."
      - colmena apply --on '@k3s-prod-*' --verbose --show-trace

  k3s-test:
    desc: "部署 K3s 测试环境"
    cmds:
      - echo "🧪 正在部署 K3s 测试环境..."
      - colmena apply --on '@k3s-test-*' --verbose --show-trace

  # ==================== Kubernetes 工具 ====================

  del-failed:
    desc: "删除所有失败的 Pod"
    cmds:
      - echo "🗑️ 正在删除所有失败的 Pod..."
      - kubectl delete pod --all-namespaces --field-selector="status.phase==Failed"

  # ==================== 批量任务 ====================

  upload-idols:
    desc: "上传 idols VM 镜像"
    vars:
      mode: '{{.mode | default "default"}}'
    cmds:
      - echo "🌟 正在上传 idols VM 镜像..."
      - task: upload-vm-template
        vars: {name: "aquamarine", mode: "{{.mode}}"}
      - task: upload-vm-template
        vars: {name: "ruby", mode: "{{.mode}}"}
      - task: upload-vm-template
        vars: {name: "kana", mode: "{{.mode}}"}