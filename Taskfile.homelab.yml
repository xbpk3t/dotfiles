version: '3'

# Homelab & Kubernetes ç›¸å…³ä»»åŠ¡

tasks:
  # ==================== Virtual Machines æ¨¡æ¿ä»»åŠ¡ ====================

  upload-vm-template:
    desc: "ä¸Šä¼  VM é•œåƒæ¨¡æ¿ä»»åŠ¡"
    vars:
      name: '{{.name}}'
      mode: '{{.mode | default "default"}}'
    cmds:
      - echo "upload-vm '{{.name}}' in '{{.mode}}' mode..."
      - echo "$(printf '=%.0s' {1..50})"
      - |
        TARGET="./nix#{{.name}}"
        if [[ "{{.mode}}" == "debug" ]]; then
          nom build $TARGET --show-trace --verbose
        else
          nix build $TARGET
        fi
      - rsync -avz --progress --copy-links --checksum result "ryan@rakushun:/data/caddy/fileserver/vms/kubevirt-{{.name}}.qcow2"

  # ==================== Colmena è¿œç¨‹éƒ¨ç½² ====================

  col:
    desc: "Colmena è¿œç¨‹éƒ¨ç½²"
    vars:
      tag: '{{.tag}}'
    cmds:
      - echo "ğŸš€ æ­£åœ¨é€šè¿‡ Colmena éƒ¨ç½²åˆ°æ ‡ç­¾ '{{.tag}}'..."
      - colmena apply --on '@{{tag}}' --verbose --show-trace

  upload-vm:
    desc: "ä¸Šä¼  VM é•œåƒ"
    vars:
      name: '{{.name}}'
      mode: '{{.mode | default "default"}}'
    cmds:
      - task: upload-vm-template
        vars: {name: "{{.name}}", mode: "{{.mode}}"}

  # ==================== KubeVirt èŠ‚ç‚¹éƒ¨ç½² ====================

  lab:
    desc: "éƒ¨ç½²æ‰€æœ‰ KubeVirt èŠ‚ç‚¹"
    cmds:
      - echo "ğŸ—ï¸ æ­£åœ¨éƒ¨ç½²æ‰€æœ‰ KubeVirt èŠ‚ç‚¹..."
      - colmena apply --on '@virt-*' --verbose --show-trace

  shoryu:
    desc: "éƒ¨ç½² shoryu èŠ‚ç‚¹"
    cmds:
      - echo "âš¡ æ­£åœ¨éƒ¨ç½² shoryu èŠ‚ç‚¹..."
      - colmena apply --on '@kubevirt-shoryu' --verbose --show-trace

  shushou:
    desc: "éƒ¨ç½² shushou èŠ‚ç‚¹"
    cmds:
      - echo "ğŸ›¡ï¸ æ­£åœ¨éƒ¨ç½² shushou èŠ‚ç‚¹..."
      - colmena apply --on '@kubevirt-shushou' --verbose --show-trace

  youko:
    desc: "éƒ¨ç½² youko èŠ‚ç‚¹"
    cmds:
      - echo "ğŸ¯ æ­£åœ¨éƒ¨ç½² youko èŠ‚ç‚¹..."
      - colmena apply --on '@kubevirt-youko' --verbose --show-trace

  # ==================== å…¶ä»– VM èŠ‚ç‚¹éƒ¨ç½² ====================

  aqua:
    desc: "éƒ¨ç½² aqua èŠ‚ç‚¹"
    cmds:
      - echo "ğŸ’§ æ­£åœ¨éƒ¨ç½² aqua èŠ‚ç‚¹..."
      - colmena apply --on '@aqua' --verbose --show-trace

  ruby:
    desc: "éƒ¨ç½² ruby èŠ‚ç‚¹"
    cmds:
      - echo "ğŸ’ æ­£åœ¨éƒ¨ç½² ruby èŠ‚ç‚¹..."
      - colmena apply --on '@ruby' --verbose --show-trace

  kana:
    desc: "éƒ¨ç½² kana èŠ‚ç‚¹"
    cmds:
      - echo "ğŸŒ¸ æ­£åœ¨éƒ¨ç½² kana èŠ‚ç‚¹..."
      - colmena apply --on '@kana' --verbose --show-trace

  # ==================== K3s é›†ç¾¤ç®¡ç† ====================

  upload-k3s-prod:
    desc: "ä¸Šä¼  K3s ç”Ÿäº§ç¯å¢ƒ VM é•œåƒ"
    vars:
      mode: '{{.mode | default "default"}}'
    cmds:
      - echo "ğŸš€ æ­£åœ¨ä¸Šä¼  K3s ç”Ÿäº§ç¯å¢ƒ VM é•œåƒ..."
      - task: upload-vm-template
        vars: {name: "k3s-prod-1-master-1", mode: "{{.mode}}"}
      - task: upload-vm-template
        vars: {name: "k3s-prod-1-master-2", mode: "{{.mode}}"}
      - task: upload-vm-template
        vars: {name: "k3s-prod-1-master-3", mode: "{{.mode}}"}
      - task: upload-vm-template
        vars: {name: "k3s-prod-1-worker-1", mode: "{{.mode}}"}
      - task: upload-vm-template
        vars: {name: "k3s-prod-1-worker-2", mode: "{{.mode}}"}
      - task: upload-vm-template
        vars: {name: "k3s-prod-1-worker-3", mode: "{{.mode}}"}

  upload-k3s-test:
    desc: "ä¸Šä¼  K3s æµ‹è¯•ç¯å¢ƒ VM é•œåƒ"
    vars:
      mode: '{{.mode | default "default"}}'
    cmds:
      - echo "ğŸ§ª æ­£åœ¨ä¸Šä¼  K3s æµ‹è¯•ç¯å¢ƒ VM é•œåƒ..."
      - task: upload-vm-template
        vars: {name: "k3s-test-1-master-1", mode: "{{.mode}}"}
      - task: upload-vm-template
        vars: {name: "k3s-test-1-master-2", mode: "{{.mode}}"}
      - task: upload-vm-template
        vars: {name: "k3s-test-1-master-3", mode: "{{.mode}}"}

  k3s-prod:
    desc: "éƒ¨ç½² K3s ç”Ÿäº§ç¯å¢ƒ"
    cmds:
      - echo "ğŸ­ æ­£åœ¨éƒ¨ç½² K3s ç”Ÿäº§ç¯å¢ƒ..."
      - colmena apply --on '@k3s-prod-*' --verbose --show-trace

  k3s-test:
    desc: "éƒ¨ç½² K3s æµ‹è¯•ç¯å¢ƒ"
    cmds:
      - echo "ğŸ§ª æ­£åœ¨éƒ¨ç½² K3s æµ‹è¯•ç¯å¢ƒ..."
      - colmena apply --on '@k3s-test-*' --verbose --show-trace

  # ==================== Kubernetes å·¥å…· ====================

  del-failed:
    desc: "åˆ é™¤æ‰€æœ‰å¤±è´¥çš„ Pod"
    cmds:
      - echo "ğŸ—‘ï¸ æ­£åœ¨åˆ é™¤æ‰€æœ‰å¤±è´¥çš„ Pod..."
      - kubectl delete pod --all-namespaces --field-selector="status.phase==Failed"

  # ==================== æ‰¹é‡ä»»åŠ¡ ====================

  upload-idols:
    desc: "ä¸Šä¼  idols VM é•œåƒ"
    vars:
      mode: '{{.mode | default "default"}}'
    cmds:
      - echo "ğŸŒŸ æ­£åœ¨ä¸Šä¼  idols VM é•œåƒ..."
      - task: upload-vm-template
        vars: {name: "aquamarine", mode: "{{.mode}}"}
      - task: upload-vm-template
        vars: {name: "ruby", mode: "{{.mode}}"}
      - task: upload-vm-template
        vars: {name: "kana", mode: "{{.mode}}"}