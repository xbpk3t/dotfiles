---

version: '3'

vars:
  # dotfilesæ ¹ç›®å½•
  DOTFILES_ROOT: "$HOME/Desktop/dotfiles"
  # dotfiles lintersç›®å½•
  DOTFILES_LINTERS: "$HOME/Desktop/dotfiles/.github/linters"
  # å½“å‰é¡¹ç›®ç›®å½•
  PROJECT_DIR: "{{.PWD}}"
  # ä¸´æ—¶æ–‡ä»¶
  TMP_FILE: "/tmp/linters_to_process.txt"
  # Taskfileè·¯å¾„
  TASKFILE_PATH: "$HOME/Desktop/dotfiles/taskfile/devops/Taskfile.linters.yml"
  # Taskå‘½ä»¤
  TASK_CMD: "task"
  # GoLandè·¯å¾„
  GOLAND_CMD: "/Applications/GoLand.app/Contents/MacOS/goland"

tasks:
  default:
    desc: åº”ç”¨dotfilesçš„linteré…ç½®åˆ°å½“å‰é¡¹ç›®
    silent: true
    interactive: true
    cmds:
      - echo "ğŸš€ å¼€å§‹åº”ç”¨linteré…ç½®..."
      - task: scan-project
      - task: process-configs
      - echo "âœ… linteré…ç½®åº”ç”¨å®Œæˆ"

  # æ‰«æå½“å‰é¡¹ç›®çš„lintersé…ç½®
  scan-project:
    internal: true
    silent: true
    interactive: true
    desc: æ‰«æå½“å‰é¡¹ç›®çš„linteré…ç½®
    cmds:
      - |
        echo "ğŸ” æ‰«æå½“å‰é¡¹ç›®linteré…ç½®..."
        if [ ! -d "{{.PROJECT_DIR}}/.github/linters" ]; then
          echo "ğŸ“ å½“å‰é¡¹ç›®æ²¡æœ‰.github/lintersç›®å½•ï¼Œå°†åˆ›å»º"
          mkdir -p "{{.PROJECT_DIR}}/.github/linters"
        else
          echo "ğŸ“ å‘ç°ç°æœ‰linteré…ç½®ç›®å½•"
        fi

  # æ‰«ælinteræ–‡ä»¶å¹¶è®¡ç®—äº¤é›†
  scan-linter-files:
    internal: true
    silent: true
    interactive: true
    desc: æ‰«ælinteræ–‡ä»¶å¹¶è®¡ç®—éœ€è¦å¤„ç†çš„äº¤é›†
    cmds:
      - |
        echo "ğŸ” æ‰«æéœ€è¦å¤„ç†çš„linteræ–‡ä»¶..."

        # è·å–dotfilesä¸­çš„linteræ–‡ä»¶ï¼ˆåŒ…å«éšè—æ–‡ä»¶ï¼‰
        DOTFILES_FILES=""
        DOTFILES_DIR="$HOME/Desktop/dotfiles/.github/linters"
        if [ -d "$DOTFILES_DIR" ]; then
          DOTFILES_FILES=$(ls -A "$DOTFILES_DIR" 2>/dev/null | grep -v '^\.\.$' | grep -v '^\.$' | tr '\n' ' ')
        fi

        # è·å–é¡¹ç›®ä¸­çš„linteræ–‡ä»¶ï¼ˆåŒ…å«éšè—æ–‡ä»¶ï¼‰
        PROJECT_FILES=""
        if [ -d "{{.PROJECT_DIR}}/.github/linters" ]; then
          PROJECT_FILES=$(ls -A "{{.PROJECT_DIR}}/.github/linters" 2>/dev/null | grep -v '^\.\.$' | grep -v '^\.$' | tr '\n' ' ')
        fi

        echo "ğŸ“‹ dotfilesä¸­çš„linteræ–‡ä»¶: $DOTFILES_FILES"
        echo "ğŸ“‹ é¡¹ç›®ä¸­çš„linteræ–‡ä»¶: $PROJECT_FILES"

        # è®¡ç®—äº¤é›†ï¼šåªæœ‰å½“é¡¹ç›®ä¸­å­˜åœ¨ä¸”dotfilesä¸­ä¹Ÿæœ‰å¯¹åº”é…ç½®æ—¶æ‰å¤„ç†
        LINTERS_TO_PROCESS=""
        for proj_file in $PROJECT_FILES; do
          for dot_file in $DOTFILES_FILES; do
            if [ "$proj_file" = "$dot_file" ]; then
              LINTERS_TO_PROCESS="$LINTERS_TO_PROCESS $proj_file"
              break
            fi
          done
        done

        # ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶
        echo "$LINTERS_TO_PROCESS" | tr ' ' '\n' | grep -v '^$' > "{{.TMP_FILE}}"

        echo "âœ… éœ€è¦å¤„ç†çš„linteræ–‡ä»¶ (äº¤é›†): $(cat {{.TMP_FILE}} | tr '\n' ' ')"

  # å¤„ç†æ‰€æœ‰é…ç½®æ–‡ä»¶
  process-configs:
    internal: true
    interactive: true
    silent: true
    desc: å¤„ç†æ‰€æœ‰linteré…ç½®æ–‡ä»¶
    deps: [scan-linter-files]
    cmds:
      - |
        echo "âš™ï¸  å¤„ç†é…ç½®æ–‡ä»¶..."
        if [ ! -f "{{.TMP_FILE}}" ]; then
          echo "âŒ æ²¡æœ‰æ‰¾åˆ°éœ€è¦å¤„ç†çš„linteræ–‡ä»¶åˆ—è¡¨"
          exit 1
        fi

        while IFS= read -r linter_file; do
          if [ -n "$linter_file" ] && [ "$linter_file" != "" ]; then
            echo "ğŸ“„ å¤„ç† $linter_file..."
            {{.TASK_CMD}} --taskfile {{.TASKFILE_PATH}} process-single-config LINTER_FILE="$linter_file"
          fi
        done < "{{.TMP_FILE}}"



  process-single-config:
    silent: true
    interactive: true
    desc: å¤„ç†å•ä¸ªlinteré…ç½®æ–‡ä»¶
    vars:
      DOTFILES_DIR: "$HOME/Desktop/dotfiles/.github/linters"
      DOTFILES_CONFIG: "{{.DOTFILES_DIR}}/{{.LINTER_FILE}}"
      PROJECT_CONFIG: "{{.PROJECT_DIR}}/.github/linters/{{.LINTER_FILE}}"
    cmds:
      - |
        echo "ğŸ“„ å¤„ç† {{.LINTER_FILE}}..."

        # æ£€æŸ¥dotfilesä¸­æ˜¯å¦å­˜åœ¨è¯¥é…ç½®æ–‡ä»¶
        if [ ! -f "{{.DOTFILES_CONFIG}}" ]; then
          echo "âš ï¸  è·³è¿‡: dotfilesä¸­ä¸å­˜åœ¨ {{.LINTER_FILE}}"
        else
          # æ£€æŸ¥é¡¹ç›®ä¸­æ˜¯å¦å·²å­˜åœ¨è¯¥é…ç½®æ–‡ä»¶
          if [ -f "{{.PROJECT_CONFIG}}" ]; then
            # æ–‡ä»¶å­˜åœ¨ï¼Œæ£€æŸ¥æ˜¯å¦ç›¸åŒ
            if diff -q "{{.DOTFILES_CONFIG}}" "{{.PROJECT_CONFIG}}" >/dev/null 2>&1; then
              echo "âœ… {{.LINTER_FILE}} å·²åŒæ­¥ï¼Œè·³è¿‡"
            else
              echo "âš ï¸  {{.LINTER_FILE}} å­˜åœ¨å·®å¼‚"
              {{.TASK_CMD}} --taskfile {{.TASKFILE_PATH}} handle-conflict LINTER_FILE="{{.LINTER_FILE}}"
            fi
          else
            # æ–‡ä»¶ä¸å­˜åœ¨ï¼Œç›´æ¥å¤åˆ¶
            echo "ğŸ“‹ å¤åˆ¶ {{.LINTER_FILE}} åˆ°é¡¹ç›®"
            cp "{{.DOTFILES_CONFIG}}" "{{.PROJECT_CONFIG}}"
            echo "âœ… {{.LINTER_FILE}} å·²å¤åˆ¶"
          fi
        fi

  handle-conflict:
    silent: true
    interactive: true
    desc: å¤„ç†é…ç½®æ–‡ä»¶å†²çª
    vars:
      DOTFILES_DIR: "$HOME/Desktop/dotfiles/.github/linters"
      DOTFILES_CONFIG: "{{.DOTFILES_DIR}}/{{.LINTER_FILE}}"
      PROJECT_CONFIG: "{{.PROJECT_DIR}}/.github/linters/{{.LINTER_FILE}}"
    cmds:
      - |
        echo ""
        echo "ğŸ”„ {{.LINTER_FILE}} å­˜åœ¨å†²çªï¼Œè¯·é€‰æ‹©æ“ä½œ:"
        echo ""

        # ä½¿ç”¨gumæä¾›äº¤äº’é€‰æ‹©
        CHOICE=$(gum choose \
          "è¦†ç›–é¡¹ç›®é…ç½® (ä½¿ç”¨dotfilesç‰ˆæœ¬)" \
          "æŸ¥çœ‹å·®å¼‚ (ä½¿ç”¨GoLand)" \
          "è·³è¿‡æ­¤æ–‡ä»¶" \
          --header="é€‰æ‹©æ“ä½œ:")

        case "$CHOICE" in
          "è¦†ç›–é¡¹ç›®é…ç½® (ä½¿ç”¨dotfilesç‰ˆæœ¬)")
            echo "ğŸ“‹ è¦†ç›– {{.LINTER_FILE}}"
            cp "{{.DOTFILES_CONFIG}}" "{{.PROJECT_CONFIG}}"
            echo "âœ… {{.LINTER_FILE}} å·²è¦†ç›–"
            ;;
          "æŸ¥çœ‹å·®å¼‚ (ä½¿ç”¨GoLand)")
            echo "ğŸ” æ‰“å¼€GoLandæŸ¥çœ‹å·®å¼‚..."
            {{.GOLAND_CMD}} diff "{{.PROJECT_CONFIG}}" "{{.DOTFILES_CONFIG}}"
            echo "â„¹ï¸  è¯·æ‰‹åŠ¨å¤„ç†å·®å¼‚åé‡æ–°è¿è¡Œä»»åŠ¡"
            ;;
          "è·³è¿‡æ­¤æ–‡ä»¶")
            echo "â­ï¸  è·³è¿‡ {{.LINTER_FILE}}"
            ;;
          *)
            echo "âŒ æ— æ•ˆé€‰æ‹©ï¼Œè·³è¿‡ {{.LINTER_FILE}}"
            ;;
        esac

  list:
    internal: true
    silent: true
    interactive: true
    desc: åˆ—å‡ºå½“å‰é¡¹ç›®çš„linteré…ç½®æ–‡ä»¶
    cmds:
      - echo "ğŸ“ å½“å‰é¡¹ç›®linteré…ç½®æ–‡ä»¶:"
      - ls -la {{.PROJECT_DIR}}/.github/linters/ 2>/dev/null || echo "âŒ .github/lintersç›®å½•ä¸å­˜åœ¨"

  list-dotfiles:
    internal: true
    silent: true
    interactive: true
    desc: åˆ—å‡ºdotfilesä¸­çš„linteré…ç½®æ–‡ä»¶
    cmds:
      - |
        echo "ğŸ“ dotfiles linteré…ç½®æ–‡ä»¶:"
        DOTFILES_DIR="$HOME/Desktop/dotfiles/.github/linters"
        ls -la "$DOTFILES_DIR"/

  # éªŒè¯é…ç½®
  validate:
    internal: true
    silent: true
    interactive: true
    desc: éªŒè¯linteré…ç½®æ–‡ä»¶
    cmds:
      - echo "ğŸ” éªŒè¯é…ç½®æ–‡ä»¶..."
      - task: validate-dotfiles
      - task: validate-project
      - echo "âœ… éªŒè¯å®Œæˆ"

  validate-dotfiles:
    internal: true
    silent: true
    interactive: true
    cmds:
      - |
        echo "ğŸ“‹ éªŒè¯dotfilesé…ç½®..."
        DOTFILES_DIR="$HOME/Desktop/dotfiles/.github/linters"
        if [ ! -d "$DOTFILES_DIR" ]; then
          echo "âŒ dotfiles lintersç›®å½•ä¸å­˜åœ¨: $DOTFILES_DIR"
          exit 1
        fi
        # åŠ¨æ€è·å–dotfilesä¸­çš„æ‰€æœ‰linteræ–‡ä»¶
        DOTFILES_FILES=$(ls -A "$DOTFILES_DIR" 2>/dev/null | grep -v '^\.\.$' | grep -v '^\.$')
        for linter in $DOTFILES_FILES; do
          echo "âœ… $linter å­˜åœ¨"
        done

  validate-project:
    internal: true
    silent: true
    interactive: true
    cmds:
      - |
        echo "ğŸ“‹ éªŒè¯é¡¹ç›®é…ç½®..."
        PROJECT_DIR="{{.PROJECT_DIR}}/.github/linters"
        if [ ! -d "$PROJECT_DIR" ]; then
          echo "âš ï¸  é¡¹ç›®lintersç›®å½•ä¸å­˜åœ¨"
        else
          # åŠ¨æ€è·å–é¡¹ç›®ä¸­çš„æ‰€æœ‰linteræ–‡ä»¶
          PROJECT_FILES=$(ls -A "$PROJECT_DIR" 2>/dev/null | grep -v '^\.\.$' | grep -v '^\.$')
          for linter in $PROJECT_FILES; do
            echo "âœ… $linter å­˜åœ¨"
          done
        fi
