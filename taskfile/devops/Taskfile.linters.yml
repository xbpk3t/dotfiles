---

version: '3'

vars:
  # dotfilesä¸­çš„lintersé…ç½®è·¯å¾„ (ä½¿ç”¨ç»å¯¹è·¯å¾„)
  DOTFILES_LINTERS_DIR: "/Users/lhgtqb7bll/Desktop/dotfiles/.github/linters"
  # å½“å‰é¡¹ç›®çš„å·¥ä½œç›®å½•
  CURRENT_PROJECT_DIR: "{{.PWD}}"
  # æ”¯æŒçš„linteré…ç½®æ–‡ä»¶åˆ—è¡¨
  SUPPORTED_LINTERS:
    - golangci-lint.yml
    - markdownlint.yml
    - yamllint.yml
    - cs-fixer.php

tasks:
  default:
    desc: åº”ç”¨dotfilesçš„linteré…ç½®åˆ°å½“å‰é¡¹ç›®
    cmds:
      - echo "ğŸš€ å¼€å§‹åº”ç”¨linteré…ç½®..."
      - task: scan-project
      - task: process-configs
      - echo "âœ… linteré…ç½®åº”ç”¨å®Œæˆ"
    silent: true
    interactive: true

  # æ‰«æå½“å‰é¡¹ç›®çš„lintersé…ç½®
  scan-project:
    internal: true
    desc: æ‰«æå½“å‰é¡¹ç›®çš„linteré…ç½®
    vars:
      PROJECT_LINTERS_DIR: "{{.CURRENT_PROJECT_DIR}}/.github/linters"
    cmds:
      - |
        echo "ğŸ” æ‰«æå½“å‰é¡¹ç›®linteré…ç½®..."
        if [ ! -d "{{.PROJECT_LINTERS_DIR}}" ]; then
          echo "ğŸ“ å½“å‰é¡¹ç›®æ²¡æœ‰.github/lintersç›®å½•ï¼Œå°†åˆ›å»º"
          mkdir -p "{{.PROJECT_LINTERS_DIR}}"
        else
          echo "ğŸ“ å‘ç°ç°æœ‰linteré…ç½®ç›®å½•"
        fi

  # å¤„ç†æ‰€æœ‰é…ç½®æ–‡ä»¶
  process-configs:
    internal: true
    desc: å¤„ç†æ‰€æœ‰linteré…ç½®æ–‡ä»¶
    deps: [scan-project]
    cmds:
      - task: process-golangci-lint
      - task: process-markdownlint
      - task: process-yamllint
      - task: process-cs-fixer

  # å¤„ç†golangci-linté…ç½®æ–‡ä»¶
  process-golangci-lint:
    internal: true
    desc: å¤„ç†golangci-linté…ç½®æ–‡ä»¶
    vars:
      DOTFILES_CONFIG: "{{.DOTFILES_LINTERS_DIR}}/golangci-lint.yml"
      PROJECT_CONFIG: "{{.CURRENT_PROJECT_DIR}}/.github/linters/golangci-lint.yml"
    cmds:
      - task: process-single-config
        vars:
          LINTER_FILE: golangci-lint.yml

  # å¤„ç†markdownlinté…ç½®æ–‡ä»¶
  process-markdownlint:
    internal: true
    desc: å¤„ç†markdownlinté…ç½®æ–‡ä»¶
    cmds:
      - task: process-single-config
        vars:
          LINTER_FILE: markdownlint.yml

  # å¤„ç†yamllinté…ç½®æ–‡ä»¶
  process-yamllint:
    internal: true
    desc: å¤„ç†yamllinté…ç½®æ–‡ä»¶
    cmds:
      - task: process-single-config
        vars:
          LINTER_FILE: yamllint.yml

  # å¤„ç†cs-fixeré…ç½®æ–‡ä»¶
  process-cs-fixer:
    internal: true
    desc: å¤„ç†cs-fixeré…ç½®æ–‡ä»¶
    cmds:
      - task: process-single-config
        vars:
          LINTER_FILE: cs-fixer.php

  # å¤„ç†å•ä¸ªé…ç½®æ–‡ä»¶
  process-single-config:
    internal: true
    desc: å¤„ç†å•ä¸ªlinteré…ç½®æ–‡ä»¶
    vars:
      DOTFILES_CONFIG: "{{.DOTFILES_LINTERS_DIR}}/{{.LINTER_FILE}}"
      PROJECT_CONFIG: "{{.CURRENT_PROJECT_DIR}}/.github/linters/{{.LINTER_FILE}}"
    cmds:
      - |
        echo "ğŸ“„ å¤„ç† {{.LINTER_FILE}}..."

        # æ£€æŸ¥dotfilesä¸­æ˜¯å¦å­˜åœ¨è¯¥é…ç½®æ–‡ä»¶
        if [ ! -f "{{.DOTFILES_CONFIG}}" ]; then
          echo "âš ï¸  è·³è¿‡: dotfilesä¸­ä¸å­˜åœ¨ {{.LINTER_FILE}}"
        else
          # æ£€æŸ¥é¡¹ç›®ä¸­æ˜¯å¦å·²å­˜åœ¨è¯¥é…ç½®æ–‡ä»¶
          if [ -f "{{.PROJECT_CONFIG}}" ]; then
            # æ–‡ä»¶å­˜åœ¨ï¼Œæ£€æŸ¥æ˜¯å¦ç›¸åŒ
            if diff -q "{{.DOTFILES_CONFIG}}" "{{.PROJECT_CONFIG}}" >/dev/null 2>&1; then
              echo "âœ… {{.LINTER_FILE}} å·²åŒæ­¥ï¼Œè·³è¿‡"
            else
              echo "âš ï¸  {{.LINTER_FILE}} å­˜åœ¨å·®å¼‚"
              /run/current-system/sw/bin/task --taskfile /Users/lhgtqb7bll/Desktop/dotfiles/taskfile/devops/Taskfile.linters.yml handle-conflict LINTER_FILE="{{.LINTER_FILE}}"
            fi
          else
            # æ–‡ä»¶ä¸å­˜åœ¨ï¼Œç›´æ¥å¤åˆ¶
            echo "ğŸ“‹ å¤åˆ¶ {{.LINTER_FILE}} åˆ°é¡¹ç›®"
            cp "{{.DOTFILES_CONFIG}}" "{{.PROJECT_CONFIG}}"
            echo "âœ… {{.LINTER_FILE}} å·²å¤åˆ¶"
          fi
        fi

  # å¤„ç†æ–‡ä»¶å†²çª
  handle-conflict:
    desc: å¤„ç†é…ç½®æ–‡ä»¶å†²çª
    vars:
      DOTFILES_CONFIG: "{{.DOTFILES_LINTERS_DIR}}/{{.LINTER_FILE}}"
      PROJECT_CONFIG: "{{.CURRENT_PROJECT_DIR}}/.github/linters/{{.LINTER_FILE}}"
    cmds:
      - |
        echo ""
        echo "ğŸ”„ {{.LINTER_FILE}} å­˜åœ¨å†²çªï¼Œè¯·é€‰æ‹©æ“ä½œ:"
        echo ""

        # ä½¿ç”¨gumæä¾›äº¤äº’é€‰æ‹©
        CHOICE=$(gum choose \
          "è¦†ç›–é¡¹ç›®é…ç½® (ä½¿ç”¨dotfilesç‰ˆæœ¬)" \
          "æŸ¥çœ‹å·®å¼‚ (ä½¿ç”¨GoLand)" \
          "è·³è¿‡æ­¤æ–‡ä»¶" \
          --header="é€‰æ‹©æ“ä½œ:")

        case "$CHOICE" in
          "è¦†ç›–é¡¹ç›®é…ç½® (ä½¿ç”¨dotfilesç‰ˆæœ¬)")
            echo "ğŸ“‹ è¦†ç›– {{.LINTER_FILE}}"
            cp "{{.DOTFILES_CONFIG}}" "{{.PROJECT_CONFIG}}"
            echo "âœ… {{.LINTER_FILE}} å·²è¦†ç›–"
            ;;
          "æŸ¥çœ‹å·®å¼‚ (ä½¿ç”¨GoLand)")
            echo "ğŸ” æ‰“å¼€GoLandæŸ¥çœ‹å·®å¼‚..."
            /Applications/GoLand.app/Contents/MacOS/goland diff "{{.PROJECT_CONFIG}}" "{{.DOTFILES_CONFIG}}"
            echo "â„¹ï¸  è¯·æ‰‹åŠ¨å¤„ç†å·®å¼‚åé‡æ–°è¿è¡Œä»»åŠ¡"
            ;;
          "è·³è¿‡æ­¤æ–‡ä»¶")
            echo "â­ï¸  è·³è¿‡ {{.LINTER_FILE}}"
            ;;
          *)
            echo "âŒ æ— æ•ˆé€‰æ‹©ï¼Œè·³è¿‡ {{.LINTER_FILE}}"
            ;;
        esac

  # åˆ—å‡ºå½“å‰é¡¹ç›®çš„linteré…ç½®
  list:
    desc: åˆ—å‡ºå½“å‰é¡¹ç›®çš„linteré…ç½®æ–‡ä»¶
    cmds:
      - echo "ğŸ“ å½“å‰é¡¹ç›®linteré…ç½®æ–‡ä»¶:"
      - ls -la {{.CURRENT_PROJECT_DIR}}/.github/linters/ 2>/dev/null || echo "âŒ .github/lintersç›®å½•ä¸å­˜åœ¨"
    interactive: true

  # åˆ—å‡ºdotfilesä¸­çš„linteré…ç½®
  list-dotfiles:
    desc: åˆ—å‡ºdotfilesä¸­çš„linteré…ç½®æ–‡ä»¶
    cmds:
      - echo "ğŸ“ dotfiles linteré…ç½®æ–‡ä»¶:"
      - ls -la {{.DOTFILES_LINTERS_DIR}}/
    interactive: true

  # éªŒè¯é…ç½®
  validate:
    desc: éªŒè¯linteré…ç½®æ–‡ä»¶
    cmds:
      - echo "ğŸ” éªŒè¯é…ç½®æ–‡ä»¶..."
      - task: validate-dotfiles
      - task: validate-project
      - echo "âœ… éªŒè¯å®Œæˆ"

  validate-dotfiles:
    internal: true
    cmds:
      - |
        echo "ğŸ“‹ éªŒè¯dotfilesé…ç½®..."
        if [ ! -d "{{.DOTFILES_LINTERS_DIR}}" ]; then
          echo "âŒ dotfiles lintersç›®å½•ä¸å­˜åœ¨: {{.DOTFILES_LINTERS_DIR}}"
          exit 1
        fi
        for linter in {{join " " .SUPPORTED_LINTERS}}; do
          if [ -f "{{.DOTFILES_LINTERS_DIR}}/$linter" ]; then
            echo "âœ… $linter å­˜åœ¨"
          else
            echo "âš ï¸  $linter ä¸å­˜åœ¨"
          fi
        done

  validate-project:
    internal: true
    cmds:
      - |
        echo "ğŸ“‹ éªŒè¯é¡¹ç›®é…ç½®..."
        PROJECT_DIR="{{.CURRENT_PROJECT_DIR}}/.github/linters"
        if [ ! -d "$PROJECT_DIR" ]; then
          echo "âš ï¸  é¡¹ç›®lintersç›®å½•ä¸å­˜åœ¨"
        else
          for linter in {{join " " .SUPPORTED_LINTERS}}; do
            if [ -f "$PROJECT_DIR/$linter" ]; then
              echo "âœ… $linter å­˜åœ¨"
            else
              echo "âš ï¸  $linter ä¸å­˜åœ¨"
            fi
          done
        fi
