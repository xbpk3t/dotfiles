---

version: '3'

vars:
  # dotfilesæ ¹ç›®å½•
  DOTFILES_ROOT: "$HOME/Desktop/dotfiles"
  # dotfiles lintersç›®å½•
  DOTFILES_LINTERS: "$HOME/Desktop/dotfiles/.github/linters"
  # å½“å‰é¡¹ç›®ç›®å½•
  PROJECT_DIR: "{{.PWD}}"
  # ä¸´æ—¶æ–‡ä»¶
  TMP_FILE: "/tmp/linters_to_process.txt"
  # Taskfileè·¯å¾„
  TASKFILE_PATH: "$HOME/Desktop/dotfiles/taskfile/devops/Taskfile.linters.yml"
  # Taskå‘½ä»¤
  TASK_CMD: "task"
  # GoLandè·¯å¾„
  GOLAND_CMD: "/Applications/GoLand.app/Contents/MacOS/goland"
  # éœ€è¦å¤„ç†çš„linteræ–‡ä»¶åˆ—è¡¨
  LINTERS_TO_PROCESS:
    sh: |
      # è·å–dotfilesä¸­çš„linteræ–‡ä»¶ï¼ˆåŒ…å«éšè—æ–‡ä»¶ï¼‰
      DOTFILES_FILES=""
      DOTFILES_DIR="$HOME/Desktop/dotfiles/.github/linters"
      if [ -d "$DOTFILES_DIR" ]; then
        DOTFILES_FILES=$(ls -A "$DOTFILES_DIR" 2>/dev/null | grep -v '^\.\.\$' | grep -v '^\.\$' | tr '\n' ' ')
      fi

      # è·å–é¡¹ç›®ä¸­çš„linteræ–‡ä»¶ï¼ˆåŒ…å«éšè—æ–‡ä»¶ï¼‰
      PROJECT_FILES=""
      if [ -d "{{.PROJECT_DIR}}/.github/linters" ]; then
        PROJECT_FILES=$(ls -A "{{.PROJECT_DIR}}/.github/linters" 2>/dev/null | grep -v '^\.\.\$' | grep -v '^\.\$' | tr '\n' ' ')
      fi

      # è®¡ç®—äº¤é›†ï¼šåªæœ‰å½“é¡¹ç›®ä¸­å­˜åœ¨ä¸”dotfilesä¸­ä¹Ÿæœ‰å¯¹åº”é…ç½®æ—¶æ‰å¤„ç†
      LINTERS_TO_PROCESS=""
      for proj_file in $PROJECT_FILES; do
        for dot_file in $DOTFILES_FILES; do
          if [ "$proj_file" = "$dot_file" ]; then
            LINTERS_TO_PROCESS="$LINTERS_TO_PROCESS $proj_file"
            break
          fi
        done
      done

      echo "$LINTERS_TO_PROCESS" | tr ' ' '\n' | grep -v '^$' | tr '\n' ' ' | sed 's/[[:space:]]*$//'

tasks:
  default:
    desc: åº”ç”¨dotfilesçš„linteré…ç½®åˆ°å½“å‰é¡¹ç›®
    silent: true
    interactive: true
    cmds:
      - echo "ğŸš€ å¼€å§‹åº”ç”¨linteré…ç½®..."
      - task: scan-project
      - task: process-configs
      - echo "âœ… linteré…ç½®åº”ç”¨å®Œæˆ"

  # æ‰«æå½“å‰é¡¹ç›®çš„lintersé…ç½®
  scan-project:
    internal: true
    silent: true
    interactive: true
    desc: æ‰«æå½“å‰é¡¹ç›®çš„linteré…ç½®
    cmds:
      - |
        echo "ğŸ” æ‰«æå½“å‰é¡¹ç›®linteré…ç½®..."
        if [ ! -d "{{.PROJECT_DIR}}/.github/linters" ]; then
          echo "ğŸ“ å½“å‰é¡¹ç›®æ²¡æœ‰.github/lintersç›®å½•ï¼Œå°†åˆ›å»º"
          mkdir -p "{{.PROJECT_DIR}}/.github/linters"
        else
          echo "ğŸ“ å‘ç°ç°æœ‰linteré…ç½®ç›®å½•"
        fi


  # å¤„ç†æ‰€æœ‰é…ç½®æ–‡ä»¶
  process-configs:
    internal: true
    interactive: true
    silent: true
    desc: å¤„ç†æ‰€æœ‰linteré…ç½®æ–‡ä»¶
    deps: [scan-project]
    preconditions:
      - sh: test -d "{{.DOTFILES_LINTERS}}"
        msg: "âŒ dotfiles lintersç›®å½•ä¸å­˜åœ¨: {{.DOTFILES_LINTERS}}"
      - sh: test -d "{{.PROJECT_DIR}}/.github/linters"
        msg: "âŒ é¡¹ç›®lintersç›®å½•ä¸å­˜åœ¨"
    vars:
      LINTERS_LIST:
        sh: echo "{{.LINTERS_TO_PROCESS}}"
    cmds:
      - echo "âš™ï¸ å¤„ç†é…ç½®æ–‡ä»¶..."
      - |
        LINTERS="{{.LINTERS_LIST}}"
        if [ -z "$LINTERS" ]; then
          echo "âš ï¸  æ²¡æœ‰æ‰¾åˆ°éœ€è¦å¤„ç†çš„linteræ–‡ä»¶"
          exit 0
        fi
      - for:
          var: LINTERS_LIST
          split: ' '
          as: LINTER_FILE
        task: process-single-linter
        vars:
          LINTER_FILE: '{{.LINTER_FILE}}'



  process-single-linter:
    internal: true
    silent: true
    interactive: true
    desc: å¤„ç†å•ä¸ªlinteré…ç½®æ–‡ä»¶
    preconditions:
      - sh: test -n "{{.LINTER_FILE}}"
        msg: "âŒ LINTER_FILE å‚æ•°ä¸ºç©º"
      - sh: test -f "{{.DOTFILES_LINTERS}}/{{.LINTER_FILE}}"
        msg: "âš ï¸  è·³è¿‡: dotfilesä¸­ä¸å­˜åœ¨ {{.LINTER_FILE}}"
    vars:
      DOTFILES_CONFIG: "{{.DOTFILES_LINTERS}}/{{.LINTER_FILE}}"
      PROJECT_CONFIG: "{{.PROJECT_DIR}}/.github/linters/{{.LINTER_FILE}}"
    cmds:
      - echo "ğŸ“„ å¤„ç† {{.LINTER_FILE}}..."
      - |
        # æ£€æŸ¥é¡¹ç›®ä¸­æ˜¯å¦å·²å­˜åœ¨è¯¥é…ç½®æ–‡ä»¶
        if [ -f "{{.PROJECT_CONFIG}}" ]; then
          # æ–‡ä»¶å­˜åœ¨ï¼Œæ£€æŸ¥æ˜¯å¦ç›¸åŒ
          if diff -q "{{.DOTFILES_CONFIG}}" "{{.PROJECT_CONFIG}}" >/dev/null 2>&1; then
            echo "âœ… {{.LINTER_FILE}} å·²åŒæ­¥ï¼Œè·³è¿‡"
          else
            echo "âš ï¸  {{.LINTER_FILE}} å­˜åœ¨å·®å¼‚"
            echo ""
            echo "ğŸ”„ {{.LINTER_FILE}} å­˜åœ¨å†²çªï¼Œè¯·é€‰æ‹©æ“ä½œ:"
            echo ""

            # ä½¿ç”¨gumæä¾›äº¤äº’é€‰æ‹©
            CHOICE=$(gum choose \
              "è¦†ç›–é¡¹ç›®é…ç½® (ä½¿ç”¨dotfilesç‰ˆæœ¬)" \
              "æŸ¥çœ‹å·®å¼‚ (ä½¿ç”¨GoLand)" \
              "è·³è¿‡æ­¤æ–‡ä»¶" \
              --header="é€‰æ‹©æ“ä½œ:")

            case "$CHOICE" in
              "è¦†ç›–é¡¹ç›®é…ç½® (ä½¿ç”¨dotfilesç‰ˆæœ¬)")
                echo "ğŸ“‹ è¦†ç›– {{.LINTER_FILE}}"
                cp "{{.DOTFILES_CONFIG}}" "{{.PROJECT_CONFIG}}"
                echo "âœ… {{.LINTER_FILE}} å·²è¦†ç›–"
                ;;
              "æŸ¥çœ‹å·®å¼‚ (ä½¿ç”¨GoLand)")
                echo "ğŸ” æ‰“å¼€GoLandæŸ¥çœ‹å·®å¼‚..."
                {{.GOLAND_CMD}} diff "{{.PROJECT_CONFIG}}" "{{.DOTFILES_CONFIG}}"
                echo "â„¹ï¸  è¯·æ‰‹åŠ¨å¤„ç†å·®å¼‚åé‡æ–°è¿è¡Œä»»åŠ¡"
                ;;
              "è·³è¿‡æ­¤æ–‡ä»¶")
                echo "â­ï¸  è·³è¿‡ {{.LINTER_FILE}}"
                ;;
              *)
                echo "âŒ æ— æ•ˆé€‰æ‹©ï¼Œè·³è¿‡ {{.LINTER_FILE}}"
                ;;
            esac
          fi
        else
          # æ–‡ä»¶ä¸å­˜åœ¨ï¼Œç›´æ¥å¤åˆ¶
          echo "ğŸ“‹ å¤åˆ¶ {{.LINTER_FILE}} åˆ°é¡¹ç›®"
          cp "{{.DOTFILES_CONFIG}}" "{{.PROJECT_CONFIG}}"
          echo "âœ… {{.LINTER_FILE}} å·²å¤åˆ¶"
        fi

  process-single-config:
    silent: true
    interactive: true
    internal: true
    desc: å¤„ç†å•ä¸ªlinteré…ç½®æ–‡ä»¶
    preconditions:
      - sh: test -n "{{.LINTER_FILE}}"
        msg: "âŒ LINTER_FILE å‚æ•°ä¸ºç©º"
      - sh: test -f "{{.DOTFILES_LINTERS}}/{{.LINTER_FILE}}"
        msg: "âš ï¸  è·³è¿‡: dotfilesä¸­ä¸å­˜åœ¨ {{.LINTER_FILE}}"
    vars:
      DOTFILES_CONFIG: "{{.DOTFILES_LINTERS}}/{{.LINTER_FILE}}"
      PROJECT_CONFIG: "{{.PROJECT_DIR}}/.github/linters/{{.LINTER_FILE}}"
    cmds:
      - echo "ğŸ“„ å¤„ç† {{.LINTER_FILE}}..."
      - |
        # æ£€æŸ¥é¡¹ç›®ä¸­æ˜¯å¦å·²å­˜åœ¨è¯¥é…ç½®æ–‡ä»¶
        if [ -f "{{.PROJECT_CONFIG}}" ]; then
          # æ–‡ä»¶å­˜åœ¨ï¼Œæ£€æŸ¥æ˜¯å¦ç›¸åŒ
          if diff -q "{{.DOTFILES_CONFIG}}" "{{.PROJECT_CONFIG}}" >/dev/null 2>&1; then
            echo "âœ… {{.LINTER_FILE}} å·²åŒæ­¥ï¼Œè·³è¿‡"
          else
            echo "âš ï¸  {{.LINTER_FILE}} å­˜åœ¨å·®å¼‚"
            task handle-conflict LINTER_FILE="{{.LINTER_FILE}}"
          fi
        else
          # æ–‡ä»¶ä¸å­˜åœ¨ï¼Œç›´æ¥å¤åˆ¶
          echo "ğŸ“‹ å¤åˆ¶ {{.LINTER_FILE}} åˆ°é¡¹ç›®"
          cp "{{.DOTFILES_CONFIG}}" "{{.PROJECT_CONFIG}}"
          echo "âœ… {{.LINTER_FILE}} å·²å¤åˆ¶"
        fi

  handle-conflict:
    interactive: true
    desc: å¤„ç†é…ç½®æ–‡ä»¶å†²çª
    preconditions:
      - sh: test -n "{{.LINTER_FILE}}"
        msg: "âŒ LINTER_FILE å‚æ•°ä¸ºç©º"
      - sh: test -f "{{.DOTFILES_LINTERS}}/{{.LINTER_FILE}}"
        msg: "âŒ dotfilesä¸­ä¸å­˜åœ¨ {{.LINTER_FILE}}"
      - sh: test -f "{{.PROJECT_DIR}}/.github/linters/{{.LINTER_FILE}}"
        msg: "âŒ é¡¹ç›®ä¸­ä¸å­˜åœ¨ {{.LINTER_FILE}}"
    vars:
      DOTFILES_CONFIG: "{{.DOTFILES_LINTERS}}/{{.LINTER_FILE}}"
      PROJECT_CONFIG: "{{.PROJECT_DIR}}/.github/linters/{{.LINTER_FILE}}"
    cmds:
      - echo "ğŸ”„ {{.LINTER_FILE}} å­˜åœ¨å†²çªï¼Œè¯·é€‰æ‹©æ“ä½œ:"
      - |
        # ä½¿ç”¨gumæä¾›äº¤äº’é€‰æ‹©
        CHOICE=$(gum choose \
          "è¦†ç›–é¡¹ç›®é…ç½® (ä½¿ç”¨dotfilesç‰ˆæœ¬)" \
          "æŸ¥çœ‹å·®å¼‚ (ä½¿ç”¨GoLand)" \
          "è·³è¿‡æ­¤æ–‡ä»¶" \
          --header="é€‰æ‹©æ“ä½œ:")

        case "$CHOICE" in
          "è¦†ç›–é¡¹ç›®é…ç½® (ä½¿ç”¨dotfilesç‰ˆæœ¬)")
            echo "ğŸ“‹ è¦†ç›– {{.LINTER_FILE}}"
            cp "{{.DOTFILES_CONFIG}}" "{{.PROJECT_CONFIG}}"
            echo "âœ… {{.LINTER_FILE}} å·²è¦†ç›–"
            ;;
          "æŸ¥çœ‹å·®å¼‚ (ä½¿ç”¨GoLand)")
            echo "ğŸ” æ‰“å¼€GoLandæŸ¥çœ‹å·®å¼‚..."
            {{.GOLAND_CMD}} diff "{{.PROJECT_CONFIG}}" "{{.DOTFILES_CONFIG}}"
            echo "â„¹ï¸  è¯·æ‰‹åŠ¨å¤„ç†å·®å¼‚åé‡æ–°è¿è¡Œä»»åŠ¡"
            ;;
          "è·³è¿‡æ­¤æ–‡ä»¶")
            echo "â­ï¸  è·³è¿‡ {{.LINTER_FILE}}"
            ;;
          *)
            echo "âŒ æ— æ•ˆé€‰æ‹©ï¼Œè·³è¿‡ {{.LINTER_FILE}}"
            ;;
        esac

  list:
    internal: true
    silent: true
    interactive: true
    desc: åˆ—å‡ºå½“å‰é¡¹ç›®çš„linteré…ç½®æ–‡ä»¶
    vars:
      PROJECT_LINTERS_DIR: "{{.PROJECT_DIR}}/.github/linters"
    cmds:
      - echo "ğŸ“ å½“å‰é¡¹ç›®linteré…ç½®æ–‡ä»¶:"
      - |
        if [ -d "{{.PROJECT_LINTERS_DIR}}" ]; then
          ls -la "{{.PROJECT_LINTERS_DIR}}/"
        else
          echo "âŒ .github/lintersç›®å½•ä¸å­˜åœ¨"
        fi

  list-dotfiles:
    internal: true
    silent: true
    interactive: true
    desc: åˆ—å‡ºdotfilesä¸­çš„linteré…ç½®æ–‡ä»¶
    preconditions:
      - sh: test -d "{{.DOTFILES_LINTERS}}"
        msg: "âŒ dotfiles lintersç›®å½•ä¸å­˜åœ¨: {{.DOTFILES_LINTERS}}"
    cmds:
      - echo "ğŸ“ dotfiles linteré…ç½®æ–‡ä»¶:"
      - ls -la "{{.DOTFILES_LINTERS}}/"

  # éªŒè¯é…ç½®
  validate:
    silent: true
    interactive: true
    desc: éªŒè¯linteré…ç½®æ–‡ä»¶
    cmds:
      - echo "ğŸ” éªŒè¯é…ç½®æ–‡ä»¶..."
      - task: validate-dotfiles
      - task: validate-project
      - echo "âœ… éªŒè¯å®Œæˆ"

  validate-dotfiles:
    internal: true
    silent: true
    interactive: true
    preconditions:
      - sh: test -d "{{.DOTFILES_LINTERS}}"
        msg: "âŒ dotfiles lintersç›®å½•ä¸å­˜åœ¨: {{.DOTFILES_LINTERS}}"
    vars:
      DOTFILES_FILES:
        sh: ls -A "{{.DOTFILES_LINTERS}}" 2>/dev/null | grep -v '^\.\.$' | grep -v '^\.$' | tr '\n' ' ' | sed 's/[[:space:]]*$//' || echo ""
    cmds:
      - echo "ğŸ“‹ éªŒè¯dotfilesé…ç½®..."
      - |
        DOTFILES_LIST="{{.DOTFILES_FILES}}"
        if [ -z "$DOTFILES_LIST" ]; then
          echo "âš ï¸  dotfilesä¸­æ²¡æœ‰linteræ–‡ä»¶"
          exit 0
        fi
      - for:
          var: DOTFILES_FILES
          split: ' '
          as: LINTER_FILE
        cmd: echo "âœ… {{.LINTER_FILE}} å­˜åœ¨"

  validate-project:
    internal: true
    silent: true
    interactive: true
    preconditions:
      - sh: test -d "{{.PROJECT_LINTERS_DIR}}"
        msg: "âš ï¸  é¡¹ç›®lintersç›®å½•ä¸å­˜åœ¨"
    vars:
      PROJECT_LINTERS_DIR: "{{.PROJECT_DIR}}/.github/linters"
      PROJECT_FILES:
        sh: |
          if [ -d "{{.PROJECT_DIR}}/.github/linters" ]; then
            ls -A "{{.PROJECT_DIR}}/.github/linters" 2>/dev/null | grep -v '^\.\.$' | grep -v '^\.$' | tr '\n' ' ' | sed 's/[[:space:]]*$//' || echo ""
          else
            echo ""
          fi
    cmds:
      - echo "ğŸ“‹ éªŒè¯é¡¹ç›®é…ç½®..."
      - |
        PROJECT_LIST="{{.PROJECT_FILES}}"
        if [ -z "$PROJECT_LIST" ]; then
          echo "âš ï¸  é¡¹ç›®ä¸­æ²¡æœ‰linteræ–‡ä»¶"
          exit 0
        fi
      - for:
          var: PROJECT_FILES
          split: ' '
          as: LINTER_FILE
        cmd: echo "âœ… {{.LINTER_FILE}} å­˜åœ¨"
