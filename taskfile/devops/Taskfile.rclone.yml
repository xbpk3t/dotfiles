---
version: '3'

vars:
  RCLONE: "rclone"
  RCLONE_REMOTE: "r2"                     # rclone.conf ä¸­çš„å­˜å‚¨é…ç½®å
  BUCKET: "docs"                      # é»˜è®¤å­˜å‚¨æ¡¶å
  LOCAL_PATH: "{{.USER_WORKING_DIR}}/docs" # é»˜è®¤æœ¬åœ°è·¯å¾„ï¼ˆè‡ªåŠ¨è·å–å½“å‰ç›®å½•ï¼‰
  DOCS_IMAGES_PATH: "{{.HOME}}/Desktop/docs-images"
  DRY_RUN_FLAG: "--dry-run"               # é»˜è®¤å¯ç”¨æ¨¡æ‹Ÿæ‰§è¡Œ


tasks:
  # ä¸Šä¼ ç›¸å…³============
  default:
    desc: ä¸Šä¼ æœ¬åœ°æ–‡ä»¶åˆ°è¿œç¨‹
    cmds:
      - task: "{{.TASK}}"
    vars:
      TASK:
        sh: gum choose upload-docs
        msg: é€‰æ‹©å¾…ä¸Šä¼ çš„bucket

  upload-docs:
    internal: true
    aliases: [docs, ud]
    cmds:
      - task: upload
    defer:
      - task: verify
    vars:
      LOCAL_PATH: "~/Desktop/docs-images"
      RCLONE_REMOTE: "r2"
      BUCKET: docs
      DRY_RUN_FLAG: ""

  upload:
    interactive: true
    internal: true
    desc: ä¸Šä¼ æ–‡ä»¶åˆ°è¿œç¨‹ï¼ˆé»˜è®¤å¯ç”¨æ¨¡æ‹Ÿæ‰§è¡Œï¼‰ # æ³¨æ„è¿™é‡Œä½¿ç”¨ syncï¼Œè€Œécopyï¼Œå› ä¸ºæˆ‘éœ€è¦localå’Œremoteå®Œå…¨ä¸€è‡´ã€‚copyåªä¼šæŠŠlocalæ–°å¢å’Œä¿®æ”¹çš„æ–‡ä»¶ä¸Šä¼ åˆ°remoteï¼Œä½†æ˜¯ä¸åˆ é™¤remoteåŸæ–‡ä»¶ã€‚
    cmds:
      - '{{.RCLONE}} sync --update --checksum --fast-list --transfers 30 --s3-upload-concurrency 30 {{.DOCS_IMAGES_PATH}} {{.RCLONE_REMOTE}}:{{.BUCKET}} --verbose --progress {{.DRY_RUN_FLAG}}'
    vars:
      REMOTE_PATH: ""  # å¯é€‰ï¼šæŒ‡å®šè¿œç¨‹å­ç›®å½•

  verify:
    internal: true
    desc: æ ¡éªŒæœ¬åœ°ä¸è¿œç¨‹æ–‡ä»¶ä¸€è‡´æ€§
    cmds:
      - '{{.RCLONE}} check {{.LOCAL_PATH}} {{.RCLONE_REMOTE}}:{{.BUCKET}}/{{if .REMOTE_PATH}}{{.REMOTE_PATH}}{{else}}docs{{end}} --size-only --one-way {{.DRY_RUN_FLAG}}'



  # é…ç½®ç›¸å…³===========
  config:
    desc: æŸ¥çœ‹ rclone ç›¸å…³é…ç½®
    interactive: true
    silent: true
    cmds:
      - echo "rclone é…ç½®æ–‡ä»¶è·¯å¾„"
      - '{{.RCLONE}} config file'
      - echo "ç»Ÿè®¡è¿œç¨‹å­˜å‚¨ä½¿ç”¨é‡"
      - '{{.RCLONE}} size {{.RCLONE_REMOTE}}:{{.BUCKET}}'
      - echo "åˆ—å‡ºæ‰€æœ‰é…ç½®çš„è¿œç¨‹å­˜å‚¨"
      - '{{.RCLONE}} listremotes'
      - echo "åˆ—å‡ºè¿œç¨‹æ–‡ä»¶è¯¦æƒ…ï¼ˆå«å¤§å°/æ—¶é—´ï¼‰" # åˆ—å‡ºæŒ‡å®šè·¯å¾„ä¸‹çš„æ‰€æœ‰çš„æ–‡ä»¶ä»¥åŠæ–‡ä»¶å¤§å°å’Œè·¯å¾„ï¼Œå¹¶ä¸”æ˜¾ç¤ºä¸Šä¼ æ—¶é—´
      - '{{.RCLONE}} lsl {{.RCLONE_REMOTE}}:{{.BUCKET}}/{{.TARGET_PATH}}'


  # ä¸‹è½½æ“ä½œ ====================================================
  download:
    desc: "âš ï¸ åŒæ­¥è¿œç¨‹æ–‡ä»¶åˆ°æœ¬åœ°ï¼ˆä¼šåˆ é™¤æœ¬åœ°å¤šä½™æ–‡ä»¶ï¼‰"
    cmds:
      - '{{.RCLONE}} sync {{.RCLONE_REMOTE}}:{{.BUCKET}}/{{.REMOTE_PATH}} {{.LOCAL_PATH}} {{.DRY_RUN_FLAG}}'
    vars:
      REMOTE_PATH: "docs"  # æŒ‡å®šè¿œç¨‹è·¯å¾„

  download-safe:
    desc: å¤åˆ¶ä¸‹è½½ï¼ˆä¸åˆ é™¤æœ¬åœ°æ–‡ä»¶ï¼‰
    cmds:
      - '{{.RCLONE}} copy {{.RCLONE_REMOTE}}:{{.BUCKET}}/{{.REMOTE_PATH}} {{.LOCAL_PATH}} --progress'
    vars:
      REMOTE_PATH: "docs"

  # åˆ é™¤æ“ä½œ ====================================================
  delete-dir:
    desc: "ğŸ”¥ åˆ é™¤è¿œç¨‹æ–‡ä»¶å¤¹å†…å®¹ï¼ˆé»˜è®¤æ¨¡æ‹Ÿæ‰§è¡Œï¼‰"
    cmds:
      - '{{.RCLONE}} delete {{.RCLONE_REMOTE}}:{{.BUCKET}}/{{.TARGET_PATH}} {{.DRY_RUN_FLAG}}'
    vars:
      TARGET_PATH: "x"  # éœ€åˆ é™¤çš„è·¯å¾„

  purge-dir:
    desc: "ğŸ”¥ å½»åº•åˆ é™¤è¿œç¨‹æ–‡ä»¶å¤¹ï¼ˆåŒ…æ‹¬ç›®å½•æœ¬èº«ï¼‰"
    cmds:
      - '{{.RCLONE}} purge {{.RCLONE_REMOTE}}:{{.BUCKET}}/{{.TARGET_PATH}} {{.DRY_RUN_FLAG}}'


  remove-empty-dirs:
    desc: åˆ é™¤æ‰€æœ‰ç©ºç›®å½•
    cmds:
      - '{{.RCLONE}} rmdirs {{.RCLONE_REMOTE}}:{{.BUCKET}}/{{.BASE_PATH}} -v'
