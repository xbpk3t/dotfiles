---
version: '3'

# å…¨å±€å˜é‡é…ç½®
vars:
  RCLONE_REMOTE: "r2"                     # rclone.conf ä¸­çš„å­˜å‚¨é…ç½®å
  BUCKET: "hhacking"                      # é»˜è®¤å­˜å‚¨æ¡¶å
  LOCAL_PATH: "{{.USER_WORKING_DIR}}/docs" # é»˜è®¤æœ¬åœ°è·¯å¾„ï¼ˆè‡ªåŠ¨è·å–å½“å‰ç›®å½•ï¼‰
  DOCS_IMAGES_PATH: "{{.HOME}}/Desktop/docs-images"
  DRY_RUN_FLAG: "--dry-run"               # é»˜è®¤å¯ç”¨æ¨¡æ‹Ÿæ‰§è¡Œ



#- rclone config file
#- rclone copy <local-path> r2:<bucket>/<r2-path> --progress --dry-run # rclone copy docs r2:hhacking/docs --progress ä¸Šä¼ åˆ°ç›®æ ‡æ–‡ä»¶å¤¹
#- rclone check <local-path> r2:<bucket>/<r2-path> --dry-run --size-only --one-way # rclone check docs r2:hhacking/docs --size-only --one-way ä¸Šä¼ å®Œæˆå check æ–‡ä»¶æ˜¯å¦å…¨éƒ¨ä¸Šä¼ 
#- rclone sync r2:<bucket> <local-path> # ç”¨æ¥ä¸‹è½½è¿œç¨‹ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å› ä¸ºsyncå‘½ä»¤çš„æœ¬è´¨æ˜¯mappingï¼Œæ‰€ä»¥ä¼šåˆ æ‰è¯¥æ–‡ä»¶å¤¹ä¸‹å…¶ä»–æ–‡ä»¶ï¼Œä¸€å®šè¦æ³¨æ„ã€‚å¦å¤–ï¼Œä¸Šé¢çš„r2æŒ‡çš„æ˜¯rclone.confä¸­çš„group key
#- rclone delete --dry-run r2:hhacking/x # ç”¨æ¥åˆ é™¤æŒ‡å®šæ–‡ä»¶å¤¹ï¼Œcloudflareä¸æ”¯æŒè¯¥æ“ä½œ
#- rclone purge æ¸…ç©ºæ•´ä¸ªbucket
#- rclone mkdir
#- rclone rmdir
#- rclone rmdirs
#- rclone lsl # åˆ—å‡ºæŒ‡å®šè·¯å¾„ä¸‹çš„æ‰€æœ‰çš„æ–‡ä»¶ä»¥åŠæ–‡ä»¶å¤§å°å’Œè·¯å¾„ï¼Œå¹¶ä¸”æ˜¾ç¤ºä¸Šä¼ æ—¶é—´



tasks:
  # åŸºç¡€å‘½ä»¤ ====================================================
  config-path:
    desc: æ˜¾ç¤º rclone é…ç½®æ–‡ä»¶è·¯å¾„
    cmds:
      - rclone config file
    silent: true

  remote-list:
    desc: åˆ—å‡ºæ‰€æœ‰é…ç½®çš„è¿œç¨‹å­˜å‚¨
    cmds:
      - rclone listremotes

  # ä¸Šä¼ æ“ä½œ ====================================================
  upload:
    desc: ä¸Šä¼ æ–‡ä»¶åˆ°è¿œç¨‹ï¼ˆé»˜è®¤å¯ç”¨æ¨¡æ‹Ÿæ‰§è¡Œï¼‰ # æ³¨æ„è¿™é‡Œä½¿ç”¨ syncï¼Œè€Œécopyï¼Œå› ä¸ºæˆ‘éœ€è¦localå’Œremoteå®Œå…¨ä¸€è‡´ã€‚copyåªä¼šæŠŠlocalæ–°å¢å’Œä¿®æ”¹çš„æ–‡ä»¶ä¸Šä¼ åˆ°remoteï¼Œä½†æ˜¯ä¸åˆ é™¤remoteåŸæ–‡ä»¶ã€‚
    cmds:
      - rclone sync --update --checksum {{.DOCS_IMAGES_PATH}} {{.RCLONE_REMOTE}}:{{.BUCKET}} --verbose --progress {{.DRY_RUN_FLAG}}
    vars:
      REMOTE_PATH: ""  # å¯é€‰ï¼šæŒ‡å®šè¿œç¨‹å­ç›®å½•
    interactive: true


  upload-force:
    desc: "âš ï¸ å®é™…æ‰§è¡Œä¸Šä¼ ï¼ˆç¦ç”¨æ¨¡æ‹Ÿæ‰§è¡Œï¼‰"
    cmds:
      - task: upload
        vars: {DRY_RUN_FLAG: ""}

  upload-docs:
    aliases: [docs, ud]
    cmds:
      - task: upload
        vars: {LOCAL_PATH: "~/Desktop/docs-images", RCLONE_REMOTE: "r2", BUCKET: docs, DRY_RUN_FLAG: ""}

  # éªŒè¯æ“ä½œ ====================================================
  verify:
    desc: æ ¡éªŒæœ¬åœ°ä¸è¿œç¨‹æ–‡ä»¶ä¸€è‡´æ€§
    cmds:
      - rclone check {{.LOCAL_PATH}} {{.RCLONE_REMOTE}}:{{.BUCKET}}/{{if .REMOTE_PATH}}{{.REMOTE_PATH}}{{else}}docs{{end}} --size-only --one-way {{.DRY_RUN_FLAG}}

  # ä¸‹è½½æ“ä½œ ====================================================
  download:
    desc: "âš ï¸ åŒæ­¥è¿œç¨‹æ–‡ä»¶åˆ°æœ¬åœ°ï¼ˆä¼šåˆ é™¤æœ¬åœ°å¤šä½™æ–‡ä»¶ï¼‰"
    cmds:
      - rclone sync {{.RCLONE_REMOTE}}:{{.BUCKET}}/{{.REMOTE_PATH}} {{.LOCAL_PATH}} {{.DRY_RUN_FLAG}}
    vars:
      REMOTE_PATH: "docs"  # æŒ‡å®šè¿œç¨‹è·¯å¾„

  download-safe:
    desc: å¤åˆ¶ä¸‹è½½ï¼ˆä¸åˆ é™¤æœ¬åœ°æ–‡ä»¶ï¼‰
    cmds:
      - rclone copy {{.RCLONE_REMOTE}}:{{.BUCKET}}/{{.REMOTE_PATH}} {{.LOCAL_PATH}} --progress
    vars:
      REMOTE_PATH: "docs"

  # åˆ é™¤æ“ä½œ ====================================================
  delete-dir:
    desc: "ğŸ”¥ åˆ é™¤è¿œç¨‹æ–‡ä»¶å¤¹å†…å®¹ï¼ˆé»˜è®¤æ¨¡æ‹Ÿæ‰§è¡Œï¼‰"
    cmds:
      - rclone delete {{.RCLONE_REMOTE}}:{{.BUCKET}}/{{.TARGET_PATH}} {{.DRY_RUN_FLAG}}
    vars:
      TARGET_PATH: "x"  # éœ€åˆ é™¤çš„è·¯å¾„

  purge-dir:
    desc: "ğŸ”¥ å½»åº•åˆ é™¤è¿œç¨‹æ–‡ä»¶å¤¹ï¼ˆåŒ…æ‹¬ç›®å½•æœ¬èº«ï¼‰"
    cmds:
      - rclone purge {{.RCLONE_REMOTE}}:{{.BUCKET}}/{{.TARGET_PATH}} {{.DRY_RUN_FLAG}}

  # ç›®å½•ç®¡ç† ====================================================
  make-dir:
    desc: åˆ›å»ºè¿œç¨‹ç›®å½•
    cmds:
      - rclone mkdir {{.RCLONE_REMOTE}}:{{.BUCKET}}/{{.NEW_DIR}}
    vars:
      NEW_DIR: "new_folder"

  remove-empty-dirs:
    desc: åˆ é™¤æ‰€æœ‰ç©ºç›®å½•
    cmds:
      - rclone rmdirs {{.RCLONE_REMOTE}}:{{.BUCKET}}/{{.BASE_PATH}} -v

  # æŸ¥çœ‹æ“ä½œ ====================================================
  list-remote:
    desc: åˆ—å‡ºè¿œç¨‹æ–‡ä»¶è¯¦æƒ…ï¼ˆå«å¤§å°/æ—¶é—´ï¼‰
    cmds:
      - rclone lsl {{.RCLONE_REMOTE}}:{{.BUCKET}}/{{.TARGET_PATH}}
    vars:
      TARGET_PATH: "docs"

  size-report:
    desc: ç»Ÿè®¡è¿œç¨‹å­˜å‚¨ä½¿ç”¨é‡
    cmds:
      - rclone size {{.RCLONE_REMOTE}}:{{.BUCKET}}
