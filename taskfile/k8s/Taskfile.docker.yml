---
version: "3"

#- docker image run
#- docker stats --no-stream <container> # æŸ¥çœ‹ docker å®¹å™¨çš„å†…å­˜å ç”¨ï¼Œåªè¿”å›å½“å‰çŠ¶æ€
#- docker stats --format 'table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}' <container> # æŸ¥çœ‹ docker å®¹å™¨çš„å†…å­˜å ç”¨ï¼Œæ ¼å¼åŒ–è¾“å‡º
#- docker inspect --format='{{.Name}} - {{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' $(docker ps -aq) # æŸ¥çœ‹æ‰€æœ‰dockerå®¹å™¨çš„ip
#- docker inspect --format='{{.LogPath}}' <container-name> # æ¸…ç†æŸä¸ªå®¹å™¨çš„è¿è¡Œæ—¥å¿—
#- docker inspect <container-id> --format='{{.State.ExitCode}}' # æŸ¥çœ‹æŸä¸ªå®¹å™¨çš„é€€å‡ºç ã€‚é€€å‡ºç å¿…é¡»åœ¨ 0-255 ä¹‹é—´ï¼Œ0 è¡¨ç¤ºæ­£å¸¸é€€å‡ºã€‚å¤–ç•Œå°†ç¨‹åºä¸­æ–­é€€å‡ºï¼ŒçŠ¶æ€ç åœ¨ 129-255ã€‚ç¨‹åºè‡ªèº«å¼‚å¸¸é€€å‡ºï¼ŒçŠ¶æ€ç ä¸€èˆ¬åœ¨ 1-128ã€‚
#- docker ps --format 'table {{.Names}}\t{{.Image}}\t{{.Ports}}\t{{.ID}}\t{{.Status}}' # æ ¼å¼åŒ–æŸ¥çœ‹ docker ps
#- docker network prune # æ¸…ç†æ‰€æœ‰æ²¡ç”¨çš„å®¹å™¨ç½‘ç»œ
#- docker volume ls/inspect/rm/prune # prune, åˆ é™¤æ‰€æœ‰ç°åœ¨æ²¡æœ‰ä½¿ç”¨çš„æ•°æ®å·(ç±»ä¼¼imageçš„prune)
#- docker search <formulae> # ä»å®˜æ–¹ä»“åº“æœç´¢image
#- docker pull # æ‹‰åˆ°æœ¬åœ°
#- docker system df # æŸ¥çœ‹images, containers, volumesæ‰€å ç”¨çš„ç©ºé—´
#- docker commit # æäº¤é•œåƒ
#- docker history <nginx:latest> # æŸ¥çœ‹æœ¬åœ°é•œåƒçš„å†å²æäº¤è®°å½•
#- docker diff <container name/id>
#- docker exec -it <container name/id> /bin/bash # è¿›å…¥å®¹å™¨ä½¿ç”¨execï¼Œè€Œä¸æ˜¯attchï¼Œå› ä¸ºattché€€å‡ºåä¼šå¯¼è‡´å®¹å™¨åœæ­¢
#- docker export/import # å¯¼å‡º/å¯¼å…¥ å®¹å™¨
#- docker image rm $(docker image ls -q <image name>) # åˆ é™¤é•œåƒåä¸­å«æœ‰<image name>çš„é•œåƒ
#- docker image prune -a # æ¸…é™¤æ‰€æœ‰æ²¡æœ‰ä½¿ç”¨çš„é•œåƒ(ä¸ä»…æ˜¯dangling images)
#- docker image prune # åˆ é™¤æ‰€æœ‰dangling images(å°±æ˜¯æ²¡æœ‰tagçš„é•œåƒï¼Œæ¯”å¦‚è¯´äºŒé˜¶æ®µæäº¤åé—å¼ƒçš„ä¸€é˜¶æ®µé•œåƒ)
#- docker image prune -a -f && docker container prune -f && docker rmi $(docker images | grep "^<none>" | awk "{print $3}") # åˆ é™¤æ‚¬ç©ºé•œåƒã€ä¸ç”¨çš„å®¹å™¨ã€æ‰¹é‡åˆ é™¤tagä¸ºnoneçš„é•œåƒ
#- docker inspect --format '{{ .State.Pid }}' <CONTAINER ID or NAME> # è·å–æŸä¸ªå®¹å™¨çš„PIDä¿¡æ¯
#- docker inspect --format '{{ .NetworkSettings.IPAddress }}' <CONTAINER ID or NAME> # è·å–æŸä¸ªå®¹å™¨çš„IPåœ°å€
#- docker container prune # Remove all stopped containers. æ¸…ç†æ‰€æœ‰stoppedçš„å®¹å™¨
#- docker system prune # Remove unused data. æ¸…ç†æ‰€æœ‰çš„stoppedçš„å®¹å™¨ã€æ‰€æœ‰danglingçŠ¶æ€çš„imageã€æ— ç”¨ç½‘ç»œ
#- docker rm -fv <containerID> # åœæ­¢åˆ é™¤å®¹å™¨ï¼Œå¹¶åˆ é™¤volume
#- docker container stop/rm $(docker ps -aq) # åœæ­¢/æ¸…é™¤ æ‰€æœ‰å®¹å™¨
#- docker manifest inspect --verbose <image> # æŸ¥çœ‹manifest (RepoTags, Config, Layers)ä¿¡æ¯ï¼Œå¦‚æœéœ€è¦æ›´ç®€è¦çš„è¾“å‡ºï¼Œå°±å»æ‰--verbose
#- docker image inspect <image> # æ¯”å¦‚ docker image inspect <debian>
#- docker exec -it $(docker ps -ql) sh # æŸ¥çœ‹docker iptables rules
#- docker info | grep Storage
#- docker run --rm -v docker-mariadb_db-mariadb:/data -v $(pwd):/backup ubuntu tar cvf /backup/backup.tar /data # è®¾ç½®äº†å…·åvolumeï¼Œæ ¹æ®dockerå®‰å…¨ç­–ç•¥æ˜¯æ— æ³•æ‰¾åˆ°volumeå¯¹åº”çš„ç‰©ç†æ–‡ä»¶çš„ï¼Œé‚£æ€ä¹ˆå¯¼å‡ºè¿™äº›sqlå‘¢ï¼Ÿ



#- url: https://github.com/lavie/runlike
#  des: ç±»ä¼¼chrome ä¹‹äº copy as curlï¼Œç”¨æ¥ä¸€é”®ç”Ÿæˆéå¸¸å¤æ‚çš„docker runå‘½ä»¤ã€‚å¿«é€Ÿè·å– Docker å®¹å™¨å¯åŠ¨å‘½ä»¤çš„å·¥å…·ã€‚è¿™æ˜¯ä¸€ä¸ªç”¨äºè§£æè¿è¡Œä¸­å®¹å™¨çš„å·¥å…·ï¼Œå¯è‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„ docker run å¯åŠ¨å‘½ä»¤ã€‚å®ƒèƒ½å¤Ÿæå–å®¹å™¨çš„é…ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç«¯å£ç»‘å®šã€æ˜ å°„å·ã€ç¯å¢ƒå˜é‡ã€ç½‘ç»œè®¾ç½®ç­‰ï¼Œé€‚ç”¨äºå¤åˆ¶ã€è°ƒè¯•æˆ–è¿ç§»å®¹å™¨çš„åœºæ™¯ã€‚ # å…·ä½“æƒ…å†µå¦‚ä¸‹ï¼Œäº‹æƒ…è¦ä»ä¸Šå‘¨çš„ä¸€æ¬¡äº‹æ•…è¯´èµ·ï¼Œæˆ‘ä»¬ç”¨ docker éƒ¨ç½²çš„ç¨‹åºæœ‰ä¸€ç‚¹é—®é¢˜ï¼Œè¦é©¬ä¸Šå›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ã€‚è¿™ä¸ª docker æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„å’Œ BPF æœ‰å…³çš„ç¨‹åºï¼Œå¯åŠ¨æ—¶å€™éœ€è¦è®¾ç½®å¾ˆå¤š mount å’Œ environmentsï¼Œdocker run çš„å‘½ä»¤ç‰¹åˆ«é•¿ã€‚æ‰€ä»¥æˆ‘ç”¨ Ansible æ¥é…ç½®å¥½è¿™äº›å˜é‡ï¼Œç„¶åå¯åŠ¨ dockerï¼Œä¸€ä¸ªå®ä¾‹è¦èŠ±è´¹ 3ï½5 åˆ†é’Ÿæ‰èƒ½å¯åŠ¨ã€‚åŒäº‹çªç„¶è¯´ï¼ŒæŸå®ä¾‹ä»–æ‰‹åŠ¨å¯åŠ¨äº†ï¼Œå½“æ—¶æˆ‘å°±éœ‡æƒŠäº†ï¼Œæ€ä¹ˆæ‰‹é€Ÿè¿™ä¹ˆå¿«ï¼Ÿï¼è¯·æ•™äº†ä¸€ä¸‹ï¼ŒåŸæ¥æ˜¯ç”¨çš„ runlike å·¥å…·ã€‚è¿™ä¸ªå·¥å…·çš„åŸç†æ˜¯ï¼Œ`docker inspect <container-name> | runlike --stdin` ï¼Œå°±ä¼šç”Ÿæˆè¿™ä¸ªå®¹å™¨çš„ docker run å‘½ä»¤ã€‚


#- url: https://github.com/containers/skopeo
#  des: ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºåœ¨ä¸åŒçš„å®¹å™¨é•œåƒä»“åº“ä¹‹é—´å¤åˆ¶ã€æ£€æŸ¥å’Œåˆ é™¤å®¹å™¨é•œåƒ

vars:
  IMAGE_NAME: "my-app"
  IMAGE_TAG: "latest"
  DOCKERFILE: "Dockerfile"



tasks:

  # ========================
  # å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
  # ========================
  run-container:
    desc: å¯åŠ¨å®¹å™¨ï¼ˆåå°æ¨¡å¼ï¼‰
    cmds:
      - docker run -d --name {{.APP_NAME}} -p {{.PORT}}:80 {{.IMAGE}}

  stop-container:
    desc: åœæ­¢æŒ‡å®šå®¹å™¨
    cmds:
      - docker stop {{.CONTAINER}}

  rm-container:
    desc: åˆ é™¤å®¹å™¨ï¼ˆå¼ºåˆ¶åˆ é™¤è¿è¡Œä¸­å®¹å™¨ï¼‰
    cmds:
      - docker rm -f {{.CONTAINER}}

  # ========================
  # å®¹å™¨ç›‘æ§ä¸è¯Šæ–­
  # ========================
  container-stats:
    desc: æŸ¥çœ‹å®¹å™¨èµ„æºå ç”¨ï¼ˆæ ¼å¼åŒ–è¾“å‡ºï¼‰
    cmds:
      - docker stats --no-stream --format 'table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}' {{.CONTAINER}}

  container-logs:
    desc: å®æ—¶è·Ÿè¸ªå®¹å™¨æ—¥å¿—
    cmds:
      - docker logs -f {{.CONTAINER}}

  inspect-ip:
    desc: æŸ¥çœ‹æ‰€æœ‰å®¹å™¨IPåœ°å€
    cmds:
      - docker inspect --format='{{.Name}} - {{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' $(docker ps -aq)

  exit-code:
    desc: æ£€æŸ¥å®¹å™¨é€€å‡ºç 
    cmds:
      - docker inspect --format='{{.State.ExitCode}}' {{.CONTAINER}}

  # ========================
  # ç³»ç»Ÿæ¸…ç†ä¸ä¼˜åŒ–
  # ========================
  system-clean:
    desc: ç»¼åˆæ¸…ç†ï¼ˆå®¹å™¨/é•œåƒ/å·/ç½‘ç»œï¼‰
    cmds:
      - docker system prune -af
      - docker volume prune -f
      - docker network prune -f

  image-clean:
    desc: åˆ é™¤æ‚¬ç©ºé•œåƒå’ŒæŒ‡å®šé•œåƒ
    cmds:
      - docker image prune -a -f
      - docker rmi $(docker images -q {{.IMAGE}})

  log-clean:
    desc: æ¸…ç†å®¹å™¨æ—¥å¿—ï¼ˆéœ€é‡å¯å®¹å™¨ç”Ÿæ•ˆï¼‰
    cmds:
      - truncate -s 0 $(docker inspect --format='{{.LogPath}}' {{.CONTAINER}})

  # ========================
  # é•œåƒä¸å­˜å‚¨ç®¡ç†
  # ========================
  image-backup:
    desc: å¤‡ä»½å…·åå·æ•°æ®
    cmds:
      - docker run --rm -v {{.VOLUME}}:/data -v $(pwd):/backup alpine tar cvf /backup/backup.tar /data

  image-history:
    desc: æŸ¥çœ‹é•œåƒæ„å»ºå†å²
    cmds:
      - docker history {{.IMAGE}}




  #- url: https://github.com/bcicen/ctop
  #  des: top in containers
  ctop:
    cmds:


  #- url: https://github.com/hadolint/hadolint
  #- url: https://github.com/aquasecurity/trivy
  #  des: docker çš„é•œåƒå®‰å…¨æ£€æµ‹å·¥å…·ï¼ŒæŸ¥æ‰¾ docker å®¹å™¨ã€k8s ä¸­æ˜¯å¦æœ‰é”™è¯¯é…ç½®ã€å¯†é’¥ã€SBOM ä»¥åŠæ¼æ´ã€‚ï¼ˆdesktop å†…ç½®äº†ï¼Œä½†æ˜¯è¿™ä¸ªçœ‹èµ·æ¥æ›´ç›´è§‚ï¼‰, better than quay/clair and anchore/grype
  #- url: https://github.com/slimtoolkit/slim
  #  des: ä¼˜åŒ–å’Œç¼©å° docker é•œåƒå¤§å°. å…¶å®æ²¡å•¥ç”¨ï¼Œå¹¶ä¸”ä¸å¥½ç”¨
  #- url: https://github.com/wagoodman/dive
  #  des: image layer. é•œåƒåˆ†æå·¥å…·ï¼ŒæŸ¥çœ‹å„å±‚ä¿¡æ¯
  zzz:
    desc: "å®Œæ•´é•œåƒä¼˜åŒ–æµç¨‹"
    cmds:
      - task: lint
      - task: build
      - task: scan
      - task: analyze
      - task: optimize
        if: {{eq .OPTIMIZE "true"}}
      - task: verify

  lint:
    desc: "æ£€æŸ¥ Dockerfile è§„èŒƒ"
    cmds:
      - hadolint {{.DOCKERFILE}}
    silent: true

  build:
    desc: "æ„å»º Docker é•œåƒ"
    cmds:
      - docker build -t {{.IMAGE_NAME}}:{{.IMAGE_TAG}} -f {{.DOCKERFILE}} .

  scan:
    desc: "å®‰å…¨æ¼æ´æ‰«æ"
    cmds:
      - trivy image --ignore-unfixed --severity CRITICAL {{.IMAGE_NAME}}:{{.IMAGE_TAG}}

  analyze:
    desc: "åˆ†æé•œåƒå±‚ç»“æ„"
    cmds:
      - dive {{.IMAGE_NAME}}:{{.IMAGE_TAG}}

  optimize:
    desc: "ä¼˜åŒ–é•œåƒå¤§å°"
    cmds:
      - slim build --target {{.IMAGE_NAME}}:{{.IMAGE_TAG}} --tag {{.IMAGE_NAME}}:slim-{{.IMAGE_TAG}}
    postcmds:
      - docker tag {{.IMAGE_NAME}}:slim-{{.IMAGE_TAG}} {{.IMAGE_NAME}}:{{.IMAGE_TAG}}

  # [goldmann/docker-squashï¼šDocker é•œåƒå‹ç¼©å·¥å…· --- goldmann/docker-squash: Docker image squashing tool](https://github.com/goldmann/docker-squash)
  squash:
    desc: ã€åˆå¹¶å±‚ã€‘å‡å°‘å±‚æ•°ï¼Œå»é™¤å±‚ä¹‹é—´çš„å†—ä½™æ–‡ä»¶


  verify:
    desc: "éªŒè¯æœ€ç»ˆé•œåƒ"
    cmds:
      - docker images {{.IMAGE_NAME}}
      - echo "ä¼˜åŒ–åé•œåƒå¤§å°:"
      - docker inspect {{.IMAGE_NAME}}:{{.IMAGE_TAG}} --format='{{"{{.Size}}"}}' | numfmt --to=iec

  # [composerize/composerizeï¼šğŸƒâ†’ ğŸ¼ docker è¿è¡Œ asdlksjfksdf > docker-composerize up --- composerize/composerize: ğŸƒâ†’ğŸ¼ docker run asdlksjfksdf > docker-composerize up](https://github.com/composerize/composerize)
  composerize:
    desc: æŠŠ Dockerfile è½¬ä¸º dc




  # å®¹å™¨å†…å­˜å ç”¨æŸ¥çœ‹ä»»åŠ¡
  # å¦‚ä½•æŸ¥çœ‹ docker å®¹å™¨çš„å†…å­˜å ç”¨ï¼Ÿ
  check-mem:
    silent: true
    desc: æŸ¥çœ‹æŒ‡å®šå®¹å™¨çš„å†…å­˜å ç”¨è¯¦æƒ…
    cmd: |
      CONTAINER_NAME={{.CLI_ARGS}}
      if [ -z "$CONTAINER_NAME" ]; then
        echo "é”™è¯¯ï¼šè¯·æä¾›å®¹å™¨åç§°ä½œä¸ºå‚æ•°"
        exit 1
      fi

      # è·å–å®¹å™¨å®Œæ•´ID
      CONTAINER_ID=$(docker inspect -f '{{.Id}}' $CONTAINER_NAME)

      # å†…å­˜æŒ‡æ ‡è·¯å¾„
      MEM_PATH="/sys/fs/cgroup/memory/docker/$CONTAINER_ID"

      # è¯»å–å†…å­˜æŒ‡æ ‡
      USED_BYTES=$(cat $MEM_PATH/memory.usage_in_bytes)
      LIMIT_BYTES=$(cat $MEM_PATH/memory.limit_in_bytes)
      MAX_USED=$(cat $MEM_PATH/memory.max_usage_in_bytes)

      # è½¬æ¢ä¸ºå¯è¯»æ ¼å¼
      USED_READABLE=$(numfmt --to=iec-i --suffix=B $USED_BYTES)
      LIMIT_READABLE=$(numfmt --to=iec-i --suffix=B $LIMIT_BYTES)
      MAX_READABLE=$(numfmt --to=iec-i --suffix=B $MAX_USED)
      PERCENT=$(awk "BEGIN {printf \"%.1f\", $USED_BYTES/$LIMIT_BYTES*100}")

      echo "å®¹å™¨: $CONTAINER_NAME (ID: ${CONTAINER_ID:0:12})"
      echo "å½“å‰ç”¨é‡: $USED_READABLE"
      echo "å³°å€¼ç”¨é‡: $MAX_READABLE"
      echo "å†…å­˜é™åˆ¶: $LIMIT_READABLE"
      echo "ä½¿ç”¨ç‡: $PERCENT%"



  # å®¹å™¨CPUåˆ©ç”¨ç‡è®¡ç®—ä»»åŠ¡
  # [å¦‚ä½•æ­£ç¡®è·å–å®¹å™¨çš„CPUåˆ©ç”¨ç‡ï¼Ÿ - å¼€å‘å†…åŠŸä¿®ç‚¼@å¼ å½¦é£ - åˆ†äº«æˆ‘çš„æŠ€æœ¯æ—¥å¸¸æ€è€ƒï¼Œå’Œå¤§ä¼™å„¿ä¸€èµ·å…±åŒæˆé•¿ï¼](https://kfngxl.cn/index.php/archives/642/) è¿™ä¸ªé—®é¢˜æœ‰ä¸¤ä¸ªè§£å†³æ€è·¯ã€‚æ€è·¯ä¹‹ä¸€æ˜¯ä½¿ç”¨ lxcfsï¼Œå°†å®¹å™¨ä¸­çš„ /proc/stat æ›¿æ¢æ‰ã€‚è¿™æ · top ç­‰å‘½ä»¤å°±ä¸å†æ˜¾ç¤ºçš„æ˜¯å®¿ä¸»æœºçš„ cpu åˆ©ç”¨ç‡äº†ï¼Œè€Œæ˜¯å®¹å™¨çš„ã€‚æ€è·¯ä¹‹äºŒæ˜¯ç›´æ¥ä½¿ç”¨ cgroup æä¾›çš„ä¼ªæ–‡ä»¶æ¥è¿›è¡Œç»Ÿè®¡ï¼Œè¿™äº›ä¼ªæ–‡ä»¶ä¸€èˆ¬ä½äº /sys/fs/cgroup/... è·¯å¾„ã€‚kubelet ä¸­é›†æˆçš„ cadvisor å°±æ˜¯é‡‡ç”¨ä¸Šè¿°æ–¹æ¡ˆæ¥ä¸ŠæŠ¥å®¹å™¨ cpu åˆ©ç”¨ç‡çš„æ‰“ç‚¹ä¿¡æ¯çš„ã€‚
  # å®¹å™¨ cpu ä½¿ç”¨ç‡çš„æŒ‡æ ‡é¡¹ä¸ºä»€ä¹ˆæ¯”ç‰©ç†æœºä¸Šå°‘äº† nice/irq/softirqï¼Ÿ # è¿™ä¸ªé—®é¢˜çš„æ ¹æœ¬åŸå› æ˜¯å®¹å™¨ cpu åˆ©ç”¨ç‡çš„æŒ‡æ ‡é¡¹ userã€system å’Œå®¿ä¸»æœºçš„åŒåæŒ‡æ ‡é¡¹æ ¹æœ¬å°±ä¸æ˜¯ä¸€ä¸ªä¸œè¥¿ã€‚å®¹å™¨å°†æ‰€æœ‰ç”¨æˆ·æ€æ—¶é—´éƒ½è®°å½•åˆ°äº† user æŒ‡æ ‡é¡¹ï¼Œç³»ç»Ÿæ€æ—¶é—´éƒ½è®°å½•åˆ°äº† systemã€‚å®¹å™¨ä¸­çš„ user æŒ‡æ ‡ï¼šåœ¨æŒ‡æ ‡å«ä¹‰ä¸Šç­‰åŒäºå®¿ä¸»æœºçš„ user + nice å®¹å™¨ä¸­çš„ system æŒ‡æ ‡ï¼šåœ¨æŒ‡æ ‡å«ä¹‰ä¸Šç­‰åŒäºå®¿ä¸»æœºçš„ system + irq + softirq
  check-cpu:
    silent: true
    desc: è®¡ç®—å®¹å™¨CPUåˆ©ç”¨ç‡ï¼ˆé‡‡æ ·1ç§’ï¼‰
    cmd: |
      CONTAINER_NAME={{.CLI_ARGS}}
      if [ -z "$CONTAINER_NAME" ]; then
        echo "é”™è¯¯ï¼šè¯·æä¾›å®¹å™¨åç§°ä½œä¸ºå‚æ•°"
        exit 1
      fi

      # è·å–å®¹å™¨å®Œæ•´ID
      CONTAINER_ID=$(docker inspect -f '{{.Id}}' $CONTAINER_NAME)

      # CPUæŒ‡æ ‡è·¯å¾„
      CPU_PATH="/sys/fs/cgroup/cpu/docker/$CONTAINER_ID"

      # è·å–ç³»ç»ŸCPUæ ¸å¿ƒæ•°
      CPU_CORES=$(nproc)

      # è®°å½•èµ·å§‹CPUæ—¶é—´
      START_CPU=$(cat $CPU_PATH/cpuacct.usage)
      sleep 1
      END_CPU=$(cat $CPU_PATH/cpuacct.usage)

      # è®¡ç®—å·®å€¼ï¼ˆçº³ç§’ï¼‰
      CPU_DELTA=$((END_CPU - START_CPU))

      # è®¡ç®—å…¬å¼ï¼š((Î”CPUæ—¶é—´ / 1000000000) / CPUæ ¸å¿ƒæ•°) * 100%
      USAGE_PERCENT=$(awk "BEGIN {printf \"%.1f\", ($CPU_DELTA / 1000000000 / $CPU_CORES) * 100}")

      echo "å®¹å™¨: $CONTAINER_NAME (ID: ${CONTAINER_ID:0:12})"
      echo "é‡‡æ ·å‘¨æœŸ: 1 ç§’"
      echo "CPU æ ¸å¿ƒ: $CPU_CORES"
      echo "CPU åˆ©ç”¨ç‡: $USAGE_PERCENT%"


  # docker é‡Œæ€ä¹ˆæŠ“åŒ…ï¼Ÿ # ä¸‰æ¡å‘½ä»¤ï¼Œå…ˆdocker inspectè·å–å®¹å™¨idï¼Œç„¶å nsenterè¿›å…¥å®¹å™¨ç©ºé—´ï¼Œæœ€åç”¨tcpdumpæŠ“åŒ…æŒ‡å®šç½‘å¡
  capture:
    desc: åœ¨Dockerå®¹å™¨ç½‘ç»œå‘½åç©ºé—´ä¸­æŠ“åŒ…
    env:
      # é»˜è®¤æŠ“åŒ…å‚æ•°ï¼Œå¯è¢«è¦†ç›–
      TCPDUMP_ARGS: '-i eth0 -w capture.pcap'
    cmds:
      # è·å–å®¹å™¨PID
      - |
        set -e
        if ! docker inspect "{{.CONTAINER}}" &>/dev/null; then
          echo "é”™è¯¯ï¼šå®¹å™¨ '{{.CONTAINER}}' ä¸å­˜åœ¨æˆ–æœªè¿è¡Œ"
          exit 1
        fi
        export PID=$(docker inspect -f '{{.State.Pid}}' "{{.CONTAINER}}")

      # æ‰§è¡ŒæŠ“åŒ…
      - |
        echo "åœ¨å®¹å™¨ {{.CONTAINER}} çš„ç½‘ç»œç©ºé—´æŠ“åŒ…(CTRL+Cåœæ­¢)..."
        echo "å‚æ•°: {{.TCPDUMP_ARGS}}"
        nsenter -t $PID -n tcpdump {{.TCPDUMP_ARGS}}
    silent: true
    sources:
      # æ·»åŠ ç¯å¢ƒæ–‡ä»¶æ”¯æŒ
      - .env


    # æ£€æŸ¥å®¹å™¨çŠ¶æ€çš„è¾…åŠ©ä»»åŠ¡
    check:
      desc: æ£€æŸ¥å®¹å™¨æ˜¯å¦å­˜åœ¨
      cmds:
        - docker inspect {{.CONTAINER}}
