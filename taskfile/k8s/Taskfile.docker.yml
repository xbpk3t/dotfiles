---
version: "3"

#- docker image run
#- docker stats --no-stream <container> # æŸ¥çœ‹ docker å®¹å™¨çš„å†…å­˜å ç”¨ï¼Œåªè¿”å›å½“å‰çŠ¶æ€
#- docker stats --format 'table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}' <container> # æŸ¥çœ‹ docker å®¹å™¨çš„å†…å­˜å ç”¨ï¼Œæ ¼å¼åŒ–è¾“å‡º
#- docker inspect --format='{{.Name}} - {{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' $(docker ps -aq) # æŸ¥çœ‹æ‰€æœ‰dockerå®¹å™¨çš„ip
#- docker inspect --format='{{.LogPath}}' <container-name> # æ¸…ç†æŸä¸ªå®¹å™¨çš„è¿è¡Œæ—¥å¿—
#- docker inspect <container-id> --format='{{.State.ExitCode}}' # æŸ¥çœ‹æŸä¸ªå®¹å™¨çš„é€€å‡ºç ã€‚é€€å‡ºç å¿…é¡»åœ¨ 0-255 ä¹‹é—´ï¼Œ0 è¡¨ç¤ºæ­£å¸¸é€€å‡ºã€‚å¤–ç•Œå°†ç¨‹åºä¸­æ–­é€€å‡ºï¼ŒçŠ¶æ€ç åœ¨ 129-255ã€‚ç¨‹åºè‡ªèº«å¼‚å¸¸é€€å‡ºï¼ŒçŠ¶æ€ç ä¸€èˆ¬åœ¨ 1-128ã€‚
#- docker ps --format 'table {{.Names}}\t{{.Image}}\t{{.Ports}}\t{{.ID}}\t{{.Status}}' # æ ¼å¼åŒ–æŸ¥çœ‹ docker ps
#- docker network prune # æ¸…ç†æ‰€æœ‰æ²¡ç”¨çš„å®¹å™¨ç½‘ç»œ
#- docker volume ls/inspect/rm/prune # prune, åˆ é™¤æ‰€æœ‰ç°åœ¨æ²¡æœ‰ä½¿ç”¨çš„æ•°æ®å·(ç±»ä¼¼imageçš„prune)
#- docker search <formulae> # ä»å®˜æ–¹ä»“åº“æœç´¢image
#- docker pull # æ‹‰åˆ°æœ¬åœ°
#- docker system df # æŸ¥çœ‹images, containers, volumesæ‰€å ç”¨çš„ç©ºé—´
#- docker commit # æäº¤é•œåƒ
#- docker history <nginx:latest> # æŸ¥çœ‹æœ¬åœ°é•œåƒçš„å†å²æäº¤è®°å½•
#- docker diff <container name/id>
#- docker exec -it <container name/id> /bin/bash # è¿›å…¥å®¹å™¨ä½¿ç”¨execï¼Œè€Œä¸æ˜¯attchï¼Œå› ä¸ºattché€€å‡ºåä¼šå¯¼è‡´å®¹å™¨åœæ­¢
#- docker export/import # å¯¼å‡º/å¯¼å…¥ å®¹å™¨
#- docker image rm $(docker image ls -q <image name>) # åˆ é™¤é•œåƒåä¸­å«æœ‰<image name>çš„é•œåƒ
#- docker image prune -a # æ¸…é™¤æ‰€æœ‰æ²¡æœ‰ä½¿ç”¨çš„é•œåƒ(ä¸ä»…æ˜¯dangling images)
#- docker image prune # åˆ é™¤æ‰€æœ‰dangling images(å°±æ˜¯æ²¡æœ‰tagçš„é•œåƒï¼Œæ¯”å¦‚è¯´äºŒé˜¶æ®µæäº¤åé—å¼ƒçš„ä¸€é˜¶æ®µé•œåƒ)
#- docker image prune -a -f && docker container prune -f && docker rmi $(docker images | grep "^<none>" | awk "{print $3}") # åˆ é™¤æ‚¬ç©ºé•œåƒã€ä¸ç”¨çš„å®¹å™¨ã€æ‰¹é‡åˆ é™¤tagä¸ºnoneçš„é•œåƒ
#- docker inspect --format '{{ .State.Pid }}' <CONTAINER ID or NAME> # è·å–æŸä¸ªå®¹å™¨çš„PIDä¿¡æ¯
#- docker inspect --format '{{ .NetworkSettings.IPAddress }}' <CONTAINER ID or NAME> # è·å–æŸä¸ªå®¹å™¨çš„IPåœ°å€
#- docker container prune # Remove all stopped containers. æ¸…ç†æ‰€æœ‰stoppedçš„å®¹å™¨
#- docker system prune # Remove unused data. æ¸…ç†æ‰€æœ‰çš„stoppedçš„å®¹å™¨ã€æ‰€æœ‰danglingçŠ¶æ€çš„imageã€æ— ç”¨ç½‘ç»œ
#- docker rm -fv <containerID> # åœæ­¢åˆ é™¤å®¹å™¨ï¼Œå¹¶åˆ é™¤volume
#- docker container stop/rm $(docker ps -aq) # åœæ­¢/æ¸…é™¤ æ‰€æœ‰å®¹å™¨
#- docker manifest inspect --verbose <image> # æŸ¥çœ‹manifest (RepoTags, Config, Layers)ä¿¡æ¯ï¼Œå¦‚æœéœ€è¦æ›´ç®€è¦çš„è¾“å‡ºï¼Œå°±å»æ‰--verbose
#- docker image inspect <image> # æ¯”å¦‚ docker image inspect <debian>
#- docker exec -it $(docker ps -ql) sh # æŸ¥çœ‹docker iptables rules
#- docker info | grep Storage
#- docker run --rm -v docker-mariadb_db-mariadb:/data -v $(pwd):/backup ubuntu tar cvf /backup/backup.tar /data # è®¾ç½®äº†å…·åvolumeï¼Œæ ¹æ®dockerå®‰å…¨ç­–ç•¥æ˜¯æ— æ³•æ‰¾åˆ°volumeå¯¹åº”çš„ç‰©ç†æ–‡ä»¶çš„ï¼Œé‚£æ€ä¹ˆå¯¼å‡ºè¿™äº›sqlå‘¢ï¼Ÿ



#- url: https://github.com/lavie/runlike
#  des: ç±»ä¼¼chrome ä¹‹äº copy as curlï¼Œç”¨æ¥ä¸€é”®ç”Ÿæˆéå¸¸å¤æ‚çš„docker runå‘½ä»¤ã€‚å¿«é€Ÿè·å– Docker å®¹å™¨å¯åŠ¨å‘½ä»¤çš„å·¥å…·ã€‚è¿™æ˜¯ä¸€ä¸ªç”¨äºè§£æè¿è¡Œä¸­å®¹å™¨çš„å·¥å…·ï¼Œå¯è‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„ docker run å¯åŠ¨å‘½ä»¤ã€‚å®ƒèƒ½å¤Ÿæå–å®¹å™¨çš„é…ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç«¯å£ç»‘å®šã€æ˜ å°„å·ã€ç¯å¢ƒå˜é‡ã€ç½‘ç»œè®¾ç½®ç­‰ï¼Œé€‚ç”¨äºå¤åˆ¶ã€è°ƒè¯•æˆ–è¿ç§»å®¹å™¨çš„åœºæ™¯ã€‚ # å…·ä½“æƒ…å†µå¦‚ä¸‹ï¼Œäº‹æƒ…è¦ä»ä¸Šå‘¨çš„ä¸€æ¬¡äº‹æ•…è¯´èµ·ï¼Œæˆ‘ä»¬ç”¨ docker éƒ¨ç½²çš„ç¨‹åºæœ‰ä¸€ç‚¹é—®é¢˜ï¼Œè¦é©¬ä¸Šå›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ã€‚è¿™ä¸ª docker æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„å’Œ BPF æœ‰å…³çš„ç¨‹åºï¼Œå¯åŠ¨æ—¶å€™éœ€è¦è®¾ç½®å¾ˆå¤š mount å’Œ environmentsï¼Œdocker run çš„å‘½ä»¤ç‰¹åˆ«é•¿ã€‚æ‰€ä»¥æˆ‘ç”¨ Ansible æ¥é…ç½®å¥½è¿™äº›å˜é‡ï¼Œç„¶åå¯åŠ¨ dockerï¼Œä¸€ä¸ªå®ä¾‹è¦èŠ±è´¹ 3ï½5 åˆ†é’Ÿæ‰èƒ½å¯åŠ¨ã€‚åŒäº‹çªç„¶è¯´ï¼ŒæŸå®ä¾‹ä»–æ‰‹åŠ¨å¯åŠ¨äº†ï¼Œå½“æ—¶æˆ‘å°±éœ‡æƒŠäº†ï¼Œæ€ä¹ˆæ‰‹é€Ÿè¿™ä¹ˆå¿«ï¼Ÿï¼è¯·æ•™äº†ä¸€ä¸‹ï¼ŒåŸæ¥æ˜¯ç”¨çš„ runlike å·¥å…·ã€‚è¿™ä¸ªå·¥å…·çš„åŸç†æ˜¯ï¼Œ`docker inspect <container-name> | runlike --stdin` ï¼Œå°±ä¼šç”Ÿæˆè¿™ä¸ªå®¹å™¨çš„ docker run å‘½ä»¤ã€‚


#- url: https://github.com/containers/skopeo
#  des: ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºåœ¨ä¸åŒçš„å®¹å™¨é•œåƒä»“åº“ä¹‹é—´å¤åˆ¶ã€æ£€æŸ¥å’Œåˆ é™¤å®¹å™¨é•œåƒ

vars:
  IMAGE_NAME: "my-app"
  IMAGE_TAG: "latest"
  DOCKERFILE: "Dockerfile"



tasks:

  # ========================
  # å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
  # ========================
  run-container:
    desc: å¯åŠ¨å®¹å™¨ï¼ˆåå°æ¨¡å¼ï¼‰
    cmds:
      - docker run -d --name {{.APP_NAME}} -p {{.PORT}}:80 {{.IMAGE}}

  stop-container:
    desc: åœæ­¢æŒ‡å®šå®¹å™¨
    cmds:
      - docker stop {{.CONTAINER}}

  rm-container:
    desc: åˆ é™¤å®¹å™¨ï¼ˆå¼ºåˆ¶åˆ é™¤è¿è¡Œä¸­å®¹å™¨ï¼‰
    cmds:
      - docker rm -f {{.CONTAINER}}

  # ========================
  # å®¹å™¨ç›‘æ§ä¸è¯Šæ–­
  # ========================
  container-stats:
    desc: æŸ¥çœ‹å®¹å™¨èµ„æºå ç”¨ï¼ˆæ ¼å¼åŒ–è¾“å‡ºï¼‰
    cmds:
      - docker stats --no-stream --format 'table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}' {{.CONTAINER}}

  container-logs:
    desc: å®æ—¶è·Ÿè¸ªå®¹å™¨æ—¥å¿—
    cmds:
      - docker logs -f {{.CONTAINER}}

  inspect-ip:
    desc: æŸ¥çœ‹æ‰€æœ‰å®¹å™¨IPåœ°å€
    cmds:
      - docker inspect --format='{{.Name}} - {{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' $(docker ps -aq)

  exit-code:
    desc: æ£€æŸ¥å®¹å™¨é€€å‡ºç 
    cmds:
      - docker inspect --format='{{.State.ExitCode}}' {{.CONTAINER}}

  # ========================
  # ç³»ç»Ÿæ¸…ç†ä¸ä¼˜åŒ–
  # ========================
  system-clean:
    desc: ç»¼åˆæ¸…ç†ï¼ˆå®¹å™¨/é•œåƒ/å·/ç½‘ç»œï¼‰
    cmds:
      - docker system prune -af
      - docker volume prune -f
      - docker network prune -f

  image-clean:
    desc: åˆ é™¤æ‚¬ç©ºé•œåƒå’ŒæŒ‡å®šé•œåƒ
    cmds:
      - docker image prune -a -f
      - docker rmi $(docker images -q {{.IMAGE}})

  log-clean:
    desc: æ¸…ç†å®¹å™¨æ—¥å¿—ï¼ˆéœ€é‡å¯å®¹å™¨ç”Ÿæ•ˆï¼‰
    cmds:
      - truncate -s 0 $(docker inspect --format='{{.LogPath}}' {{.CONTAINER}})

  # ========================
  # é•œåƒä¸å­˜å‚¨ç®¡ç†
  # ========================
  image-backup:
    desc: å¤‡ä»½å…·åå·æ•°æ®
    cmds:
      - docker run --rm -v {{.VOLUME}}:/data -v $(pwd):/backup alpine tar cvf /backup/backup.tar /data

  image-history:
    desc: æŸ¥çœ‹é•œåƒæ„å»ºå†å²
    cmds:
      - docker history {{.IMAGE}}




  #- url: https://github.com/bcicen/ctop
  #  des: top in containers
  ctop:
    cmds:


  #- url: https://github.com/hadolint/hadolint
  #- url: https://github.com/aquasecurity/trivy
  #  des: docker çš„é•œåƒå®‰å…¨æ£€æµ‹å·¥å…·ï¼ŒæŸ¥æ‰¾ docker å®¹å™¨ã€k8s ä¸­æ˜¯å¦æœ‰é”™è¯¯é…ç½®ã€å¯†é’¥ã€SBOM ä»¥åŠæ¼æ´ã€‚ï¼ˆdesktop å†…ç½®äº†ï¼Œä½†æ˜¯è¿™ä¸ªçœ‹èµ·æ¥æ›´ç›´è§‚ï¼‰, better than quay/clair and anchore/grype
  #- url: https://github.com/slimtoolkit/slim
  #  des: ä¼˜åŒ–å’Œç¼©å° docker é•œåƒå¤§å°. å…¶å®æ²¡å•¥ç”¨ï¼Œå¹¶ä¸”ä¸å¥½ç”¨
  #- url: https://github.com/wagoodman/dive
  #  des: image layer. é•œåƒåˆ†æå·¥å…·ï¼ŒæŸ¥çœ‹å„å±‚ä¿¡æ¯
  zzz:
    desc: "å®Œæ•´é•œåƒä¼˜åŒ–æµç¨‹"
    cmds:
      - task: lint
      - task: build
      - task: scan
      - task: analyze
      - task: optimize
        if: {{eq .OPTIMIZE "true"}}
      - task: verify

  lint:
    desc: "æ£€æŸ¥ Dockerfile è§„èŒƒ"
    cmds:
      - hadolint {{.DOCKERFILE}}
    silent: true

  build:
    desc: "æ„å»º Docker é•œåƒ"
    cmds:
      - docker build -t {{.IMAGE_NAME}}:{{.IMAGE_TAG}} -f {{.DOCKERFILE}} .

  scan:
    desc: "å®‰å…¨æ¼æ´æ‰«æ"
    cmds:
      - trivy image --ignore-unfixed --severity CRITICAL {{.IMAGE_NAME}}:{{.IMAGE_TAG}}

  analyze:
    desc: "åˆ†æé•œåƒå±‚ç»“æ„"
    cmds:
      - dive {{.IMAGE_NAME}}:{{.IMAGE_TAG}}

  optimize:
    desc: "ä¼˜åŒ–é•œåƒå¤§å°"
    cmds:
      - slim build --target {{.IMAGE_NAME}}:{{.IMAGE_TAG}} --tag {{.IMAGE_NAME}}:slim-{{.IMAGE_TAG}}
    postcmds:
      - docker tag {{.IMAGE_NAME}}:slim-{{.IMAGE_TAG}} {{.IMAGE_NAME}}:{{.IMAGE_TAG}}

  # [goldmann/docker-squashï¼šDocker é•œåƒå‹ç¼©å·¥å…· --- goldmann/docker-squash: Docker image squashing tool](https://github.com/goldmann/docker-squash)
  squash:
    desc: ã€åˆå¹¶å±‚ã€‘å‡å°‘å±‚æ•°ï¼Œå»é™¤å±‚ä¹‹é—´çš„å†—ä½™æ–‡ä»¶


  verify:
    desc: "éªŒè¯æœ€ç»ˆé•œåƒ"
    cmds:
      - docker images {{.IMAGE_NAME}}
      - echo "ä¼˜åŒ–åé•œåƒå¤§å°:"
      - docker inspect {{.IMAGE_NAME}}:{{.IMAGE_TAG}} --format='{{"{{.Size}}"}}' | numfmt --to=iec

  # [composerize/composerizeï¼šğŸƒâ†’ ğŸ¼ docker è¿è¡Œ asdlksjfksdf > docker-composerize up --- composerize/composerize: ğŸƒâ†’ğŸ¼ docker run asdlksjfksdf > docker-composerize up](https://github.com/composerize/composerize)
  composerize:
    desc: æŠŠ Dockerfile è½¬ä¸º dc
