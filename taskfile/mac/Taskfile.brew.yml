version: "3"

#- brew commands
#- brew update -vvv # 更新homebrew
#- brew upgrade # 用来升级brew的formula（不支持cask）
#- brew services list/run/start/stop/restart/cleanup
#- brew tap # 查看所有已经tapped的repo
#- brew tap/untap <user/repo> # 添加/移除 新tap
#- brew tap --repair
#- brew info <service> # brew info --github <service>
#- brew pin/unpin <service@version> # 锁定/解锁 不想更新的包
#- brew link/unlink <service>
#- brew deps/uses <pkg> --tree --installed # 查看 pkg 的上游包（依赖包）/ 下游包（被依赖包）
#- brew leaves # 列出不被任何包依赖的包

#- brew graph --installed | fdp -Tpng -ograph.png
#- des: brew graph提供的依赖关系不是可视化的，怎么可视化查看homebrew的formulae之间的依赖关系?
#  url: https://github.com/martido/homebrew-graph

vars:
  BREWFILE: $HOME/Desktop/dotfiles/Brewfile


tasks:
  default:
    cmds:
      - task: upgrade
      - task: cleanup
      - task: info
      - brew doctor

  install:
    internal: true
    desc: check, if not then install
    cmds:
      - echo "⚠️  正在安装 Homebrew..."
      - /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    preconditions:
      - sh: '[ "$(uname)" = "Darwin" ]'
        msg: "此任务仅支持 macOS 系统"
      - sh: '! command -v brew &> /dev/null'
        msg: "Homebrew 已安装，无需重复安装"

  ensure:
    internal: true
    desc: 确保 Homebrew 已安装（如果未安装则自动安装）
    cmds:
      - |
        if ! command -v brew &> /dev/null; then
          echo "⚠️  Homebrew 未安装，正在安装..."
          task install
        else
          echo "✅ Homebrew 已安装"
        fi


  check-size:
    cmds:
      - git count-objects -v
      - du -sh * | sort -h
      - du -sh docs/* | sort -h

  upgrade:
    internal: true
    desc: upgrade brew and outdated formulae
    cmds:
      - brew update -vvv
      - brew upgrade
      - brew outdated # 更新homebrew
      - task: cask-upgrade

  info:
    internal: true
    cmds:
      - brew config
      - git -C "$(brew --repo)" remote -v # 查看brew镜像源
      - brew --prefix # 用来查看bin path和cask path


  cleanup:
    desc: 清除所有brew本地缓存
    cmds:
      - brew cleanup -n
      - brew cleanup -s # 清理
      - brew services cleanup
      - brew autoremove # Uninstall formulae that were only installed as a dependency of another formula and are now no longer needed


  #- des: brew upgrade只能升级formulae，不支持cask。那怎么才能upgrade cask呢?
  #  url: https://github.com/buo/homebrew-cask-upgrade
  cask-upgrade:
    internal: true
    desc: 更新cask（也就是所有app）
    cmd: brew cu -facy
    preconditions:
      - brew tap buo/cask-upgrade


  deps:
    desc: Show dependency tree for a package (provide package name)
    cmds:
      - brew deps {{.CLI_ARGS}} --tree --installed
    silent: true

  uses:
    desc: Show reverse dependency tree for a package (provide package name)
    cmds:
      - brew uses {{.CLI_ARGS}} --tree --installed
    silent: true



  bundle-backup:
    internal: true
    cmd: brew bundle dump --describe --force --file={{.BREWFILE}}
    desc: backup brew formulae and cask to Brewfile

  bundle-restore:
    internal: true
    cmd: brew bundle install --file="{{.BREWFILE}}"
    desc: install
