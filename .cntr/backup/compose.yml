---
# PLAN [2025-11-27] 技术选型：container 数据备份方案选择
# https://docs.duplicati.com/detailed-descriptions/using-duplicati-from-docker
# https://mynixos.com/nixpkgs/options/services.duplicati


# https://github.com/Minituff/nautical-backup
# https://minituff.github.io/nautical-backup/labels/



# ### 其他类似 Duplicati 的 Docker 容器数据备份工具推荐
#
#是的，除了 Duplicati，还有不少工具专门用于备份 Docker 容器里的数据（主要是 volumes 和 bind mounts），这些工具支持自动化、加密、增量备份，并能处理数据库一致性问题（如停止容器备份）。我基于 2025 年的最新工具和最佳实践，挑选了一些开源/免费的选项（优先 Docker 原生或容器化工具），适合个人或小型自托管环境。企业级如 Commvault Cloud 或 Kasten K10 更复杂且付费，这里重点推荐易用的。
#
#我将它们分类并用表格比较，便于查看。每个推荐包括简要描述、安装/使用方式，以及一个备份 Alist 数据（SQLite DB）的简单例子（类似之前 Duplicati 的场景）。这些工具都能备份 DB，但推荐用脚本确保一致性（如 dump DB）。
#
##### 推荐工具比较
#
#| 工具名称 | 开源/免费 | 主要特性 | 适合场景 | 缺点 | 安装复杂度 |
#|----------|-----------|----------|----------|------|------------|
#| **offen/docker-volume-backup** | 是 | 停止容器备份 volumes，支持 S3/WebDAV/本地；轻量 (<25MB)；定时 cron。 | Docker Compose 项目，需一致性（如 DB）。 | 需要添加标签到容器。 | 低（Docker 镜像）。 |
#| **restic** | 是 | 增量、去重、加密；支持 Docker 卷；多后端（S3、SFTP 等）。 | 高效长期备份，非 Docker 专用但集成好。 | 需脚本集成 Docker。 | 中（二进制 + 脚本）。 |
#| **Nautical** | 是 | 逐容器停止/备份 volumes + 配置；支持 compose 文件备份；通知。 | 多容器栈（如 Unraid），自动化强。 | 较新，社区小。 | 低（Docker 镜像）。 |
#| **Kopia** | 是 | 快照式备份、加密、Web UI；Docker 卷支持；云集成。 | 日常备份，本地/远程。 | UI 需额外容器。 | 低（Docker）。 |
#| **docker-backup** (muesli) | 是 | 备份容器元数据 + volumes 到 tar；易迁移主机。 | 完整容器克隆/迁移。 | 无内置调度。 | 中（Go 二进制）。 |
#
##### 详细推荐与使用例子
#
#1. **offen/docker-volume-backup**
#   最接近 Duplicati 的 Docker 专用工具：作为伴侣容器运行，自动停止容器备份 volumes 到远程存储。支持 DB（通过停止容器）。
#   **安装**：在你的 `docker-compose.yml` 中添加服务（假设 Alist 已运行）：
#   ```yaml
#   services:
#     alist:  # 你的 Alist 服务
#       image: xhofe/alist:latest
#       volumes:
#         - ./alist-data:/opt/alist/data
#       labels:
#         - "offen-docker-volume-backup.stop-during-backup=true"  # 停止备份确保一致
#
#     backup:
#       image: offen/docker-volume-backup:latest
#       volumes:
#         - /var/run/docker.sock:/var/run/docker.sock:ro  # 访问 Docker
#         - ./backup-dest:/archive  # 本地备份路径
#         - ./alist-data:/backup/alist:ro  # 指定卷
#       environment:
#         - DOCKER_VOLUME_BACKUP_ARCHIVE=alist-backup-%Y%m%d.tar.gz
#         - DOCKER_VOLUME_BACKUP_CRON="0 2 * * *"  # 每天凌晨 2 点
#         - BACKUP_DESTINATION=s3://your-bucket  # 或本地 /archive
#       restart: unless-stopped
#   ```
#   运行 `docker-compose up -d`。它会 tar 卷并上传。
#   **Alist 例子**：备份 `./alist-data`（含 alist.db）。标签确保停止 Alist 备份（一致 DB）。恢复：解压 tar 到新主机，重建卷。日志：`docker logs backup`。
#
#2. **restic**
#   通用备份工具，像 Duplicati 但更快、更去重。Docker 中运行，备份 volumes。支持 DB dump 脚本。
#   **安装**：用 Docker 运行（或主机二进制）。初始化仓库：`docker run --rm -v restic-repo:/repo restic/restic:latest init -r /repo`。
#   **使用**：备份命令：
#   ```bash
#   docker run --rm \
#     -v /var/run/docker.sock:/var/run/docker.sock \
#     -v ./alist-data:/data \
#     -v restic-repo:/repo \
#     restic/restic:latest \
#     backup /data --repo /repo --password-file <(echo "your-pass")
#   ```
#   定时用 cron：`0 2 * * * docker run ...`。
#   **Alist 例子**：预脚本 dump DB（SQLite）：`sqlite3 /data/alist.db .dump > /data/dump.sql`，然后备份 `/data`。恢复：`restic restore latest --target /new-data --repo /repo`。高效，增量只传变化。
#
#3. **Nautical**
#   2025 新兴工具，专为 Docker Compose 设计：逐个停止容器备份 volumes + compose.yml，支持邮件通知。
#   **安装**：Docker 镜像。`docker-compose.yml` 示例：
#   ```yaml
#   services:
#     nautical:
#       image: ghcr.io/nauticalhq/nautical:latest
#       volumes:
#         - /var/run/docker.sock:/var/run/docker.sock:ro
#         - ./compose:/compose  # 你的 compose 文件
#         - ./backup-dest:/backups
#       environment:
#         - NAUTICAL_EMAIL=your@email.com  # 通知
#         - NAUTICAL_RETENTION=7d  # 保留 7 天
#       restart: unless-stopped
#   ```
#   运行后，它扫描 compose 文件自动备份。
#   **Alist 例子**：放 Alist compose 到 `./compose/alist.yml`，Nautical 会停止 Alist、备份 `./alist-data`，重启。恢复：从备份重建 compose + 卷。适合多栈。
#
#4. **Kopia**
#   现代快照工具，有 Web UI，像 Duplicati 但更快。Docker 友好，支持卷快照。
#   **安装**：运行 UI 容器：`docker run --rm -p 51515:51515 -v kopia:/config kopia/kopia-server`。浏览器访问 localhost:51515 配置仓库。
#   **使用**：CLI 备份：
#   ```bash
#   docker run --rm \
#     -v ./alist-data:/data \
#     -v kopia-repo:/repo \
#     kopia/kopia:latest \
#     snapshot create /data --repo=/repo --password=your-pass
#   ```
#   定时 cron 类似。
#   **Alist 例子**：备份前 dump DB 到 `/data/dump.sql`，Kopia 快照整个卷。恢复：`kopia restore --target /new-data`。UI 易管理策略。
#
#5. **docker-backup (muesli)**
#   简单工具：生成 tar 含容器元数据 + volumes，易迁移。结合 restic 等用。
#   **安装**：下载 Go 二进制：`go install github.com/muesli/docker-backup@latest`。
#   **使用**：`docker-backup backup alist-container -o alist-backup.tar`（替换 alist-container 为容器名）。
#   **Alist 例子**：备份 Alist 容器（含 volumes）。tar 内有 JSON 元数据 + 卷文件。恢复：`docker-backup restore alist-backup.tar` 到新主机。无调度，适合手动/脚本。
#
##### 通用建议
#- **DB 备份**：所有工具都支持，但加预脚本（如 `docker stop alist; sqlite3 alist.db .dump > dump.sql`）确保一致。恢复时先导入 dump。
#- **最佳实践**：用 named volumes（非 bind mounts）；测试恢复；结合 Git 备份 compose.yml。云存储如 S3 防主机故障。
#- **选择依据**：offen/restic 最简单上手；Nautical/Kopia 自动化强。如果你用 Kubernetes，试 Velero（开源，但更重）。
#
#如果需要某个工具的详细脚本或 Docker Compose 示例，再说！





name: nautical

services:
  nautical-backup:
    image: minituff/nautical-backup:2
    container_name: nautical-backup
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /config:/config
      - /source:/app/source:ro
      - /destination:/app/destination
    environment: # Optional variables
      - TZ=America/Los_Angeles
      - CRON_SCHEDULE=0 4 * * *
      - SKIP_CONTAINERS=example1,example2,example3
