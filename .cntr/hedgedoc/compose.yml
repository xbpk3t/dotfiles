---
# https://docs.hedgedoc.org/setup/docker/
# https://docs.hedgedoc.org/guides/reverse-proxy/

# https://mynixos.com/nixpkgs/options/services.hedgedoc


name: hedgedoc

services:
  database:
    image: postgres:17-alpine
    environment:
      - POSTGRES_USER=hedgedoc
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=hedgedoc
    volumes:
      - database:/var/lib/postgresql/data
    restart: always

  app:
    # Make sure to use the latest release from https://hedgedoc.org/latest-release
    image: quay.io/hedgedoc/hedgedoc:latest
    environment:
      - CMD_DB_URL=postgres://hedgedoc:password@database:5432/hedgedoc

      # 对外访问的域名
      - CMD_DOMAIN=md.lucc.dev

      # 在反向代理后面跑：外面是 https://md.lucc.dev
      - CMD_URL_ADDPORT=false          # 对外 URL 不要带 :3000
      - CMD_PROTOCOL_USESSL=true       # 外面是 https
      - CMD_TRUST_PROXY=true           # 有反向代理必须开

      # ⭐ 邮箱登录（本地账号）
      # 需要直接使用 /hedgedoc/bin/mana
      - CMD_EMAIL=true                 # 允许 email 登录（默认是 true，但这里手动写死，避免被别的配置覆盖）
      - CMD_ALLOW_EMAIL_REGISTER=false # 禁止新用户自己注册（我们已经用 CLI 建好你这一个号）

      # ⭐ 匿名访问控制（只给你自己用）
      - CMD_ALLOW_ANONYMOUS=false      # 未登录不能创建笔记
      - CMD_ALLOW_ANONYMOUS_EDITS=false

      # ⭐ 强烈建议加一个固定的 session secret（不然每次重启全员下线）
      - CMD_SESSION_SECRET=some-long-random-string-please-change-me
    volumes:
      - uploads:/hedgedoc/public/uploads
    ports:
      - "3010:3000"
    restart: always
    depends_on:
      - database

volumes:
  database:
  uploads:
