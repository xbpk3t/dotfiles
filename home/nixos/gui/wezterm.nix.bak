{
  config,
  lib,
  ...
}:
with lib; let
  cfg = config.custom.gui.wezterm;
in {
  options.custom.gui.wezterm = {
    enable = mkEnableOption "wezterm terminal";
  };

  config = mkIf cfg.enable {
    # https://mynixos.com/home-manager/options/programs.wezterm
    # 几乎完美的wezterm配置
    # 这里需要注意，使用stylix时，会自动配置wezterm的主配置文件 wezterm.lua，具体参考
    # https://github.com/nix-community/stylix/blob/master/modules/wezterm/hm.nix
    # 所以如果直接 xdg.configFile就会覆盖掉stylix生成的。因此要通过extraConfig来自定义配置项的集成
    programs.wezterm = {
      enable = true;
      enableZshIntegration = true;

      # Stylix 将通过 extraConfig 应用用户的自定义配置
      extraConfig = ''
        -- 键位绑定配置
        config.keys = {
          { key = 'Enter',      mods = 'CTRL',  action = wezterm.action.ToggleFullScreen },
          { key = 'Enter',      mods = 'ALT',   action = wezterm.action.DisableDefaultAssignment },
          { key = 't',          mods = 'ALT',   action = wezterm.action.SpawnTab("DefaultDomain") },
          { key = 'm',          mods = 'ALT',   action = wezterm.action.ShowTabNavigator },
          { key = 'w',          mods = 'ALT',   action = wezterm.action.CloseCurrentPane { confirm = true } },
          { key = 'n',          mods = 'SUPER', action = wezterm.action.SpawnWindow },
          { key = 'd',          mods = 'ALT',   action = wezterm.action.SplitHorizontal { domain = "CurrentPaneDomain" } },
          { key = 'D',          mods = 'ALT',   action = wezterm.action.SplitVertical { domain = "CurrentPaneDomain" } },
          { key = 'h',          mods = 'ALT',   action = wezterm.action.ActivatePaneDirection("Left") },
          { key = 'j',          mods = 'ALT',   action = wezterm.action.ActivatePaneDirection("Down") },
          { key = 'k',          mods = 'ALT',   action = wezterm.action.ActivatePaneDirection("Up") },
          { key = 'l',          mods = 'ALT',   action = wezterm.action.ActivatePaneDirection("Right") },
          { key = 'LeftArrow',  mods = 'ALT',   action = wezterm.action.AdjustPaneSize { "Left", 5 } },
          { key = 'DownArrow',  mods = 'ALT',   action = wezterm.action.AdjustPaneSize { "Down", 5 } },
          { key = 'UpArrow',    mods = 'ALT',   action = wezterm.action.AdjustPaneSize { "Up", 5 } },
          { key = 'RightArrow', mods = 'ALT',   action = wezterm.action.AdjustPaneSize { "Right", 5 } },
          { key = 'L',          mods = 'ALT',   action = wezterm.action.ActivateTabRelative(1) },
          { key = 'H',          mods = 'ALT',   action = wezterm.action.ActivateTabRelative(-1) },

        -- 字体大小
          { key = '+', mods = 'CTRL', action = wezterm.action.IncreaseFontSize },
          { key = '-', mods = 'CTRL', action = wezterm.action.DecreaseFontSize },
          { key = '0', mods = 'CTRL', action = wezterm.action.ResetFontSize },

        -- 复制粘贴
          { key = 'c', mods = 'CTRL|SHIFT', action = wezterm.action.CopyTo('Clipboard') },
          { key = 'v', mods = 'CTRL|SHIFT', action = wezterm.action.PasteFrom('Clipboard') },
        }

        -- 状态栏配置
        local bar = wezterm.plugin.require("https://github.com/adriankarlen/bar.wezterm")
        bar.apply_to_config(config, {
          modules = {
            spotify = {
              enabled = false,
            },
          },
        })
      '';
    };
  };
}
