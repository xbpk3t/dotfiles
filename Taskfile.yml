version: '3'

includes:
  sk:
    taskfile: ./secrets/Taskfile.yml
    dir: ./secrets
  linux: Taskfile.linux.yml
  darwin: Taskfile.darwin.yml
  homelab: Taskfile.homelab.yml


# Nix-Darwin management tasks
# Converted from rich-demo Justfile with additional migration functionality

vars:
  NIX_DIR: './nix'
  HOSTNAME:
    sh: scutil --get ComputerName | tr ' ' '-' | tr '[:upper:]' '[:lower:]'
  SYSTEM:
    sh: |
      if [[ $(uname -m) == "arm64" ]]; then
        echo "aarch64-darwin"
      else
        echo "x86_64-darwin"
      fi
  OS:
    sh: uname
  USERNAME:
    sh: whoami
  # Default cleanup days for maintenance tasks
  CLEANUP_DAYS: '{{.CLEANUP_DAYS | default "7"}}'
  # Nix store path
  NIX_STORE_PATH: '/nix/store'
  # System profile path
  SYSTEM_PROFILE: '/nix/var/nix/profiles/system'
  # GitHub token pulled from gh CLI for GitHub API rate limits
  GITHUB_TOKEN:
    sh: gh auth token 2>/dev/null || echo ""
  # Dynamic rebuild command based on OS
  REBUILD_CMD:
    sh: |
      if [[ "{{.OS}}" == "Darwin" ]]; then
        echo "darwin-rebuild"
      else
        echo "nixos-rebuild"
      fi
  # Dynamic build target based on OS
  BUILD_TARGET:
    sh: |
      if [[ "{{.OS}}" == "Darwin" ]]; then
        echo "darwinConfigurations.{{.HOSTNAME}}.system"
      else
        echo "nixosConfigurations.{{.HOSTNAME}}.config.system.build.toplevel"
      fi

env:
  NIX_CONFIG: 'access-tokens = github.com={{.GITHUB_TOKEN}}'


tasks:
  default:
    desc: æ„å»ºå¹¶åˆ‡æ¢åˆ°å½“å‰ç³»ç»Ÿé…ç½®
    cmds:
      - task: update
      - task: build-switch
      - task: prune



  # sudo env http_proxy=http://127.0.0.1:7890 https_proxy=http://127.0.0.1:7890 nixos-rebuild switch
  #--flake .#intel
  build:
    desc: "æ„å»ºç³»ç»Ÿé…ç½®ï¼ˆä¸åˆ‡æ¢ï¼‰"
    cmds:
      - echo "æ­£åœ¨ä¸º {{.HOSTNAME}} ({{.SYSTEM}}) æ„å»º {{.OS}} é…ç½®..."
      - nix build ./nix#{{.BUILD_TARGET}} --extra-experimental-features 'nix-command flakes'
      - echo "æ„å»ºå®Œæˆï¼"



  build-switch:
    desc: "æ„å»ºå¹¶åˆ‡æ¢åˆ°æ–°é…ç½®"
    cmds:
      - echo "æ­£åœ¨æ„å»ºå¹¶åˆ‡æ¢ {{.OS}} é…ç½®..."
      #      - sudo {{.REBUILD_CMD}} switch --flake .#{{.HOSTNAME}}
      - sudo {{.REBUILD_CMD}} switch --flake .#macos-ws --show-trace # FIXME
      - echo "åˆ‡æ¢åˆ°æ–°é…ç½®å®Œæˆï¼"


  darwin:
    desc: "æ„å»ºå¹¶åˆ‡æ¢åˆ° nix-darwin é…ç½®"
    cmds:
      - echo "ğŸš€ æ­£åœ¨ä¸º {{.HOSTNAME}} ({{.SYSTEM}}) æ„å»º nix-darwin é…ç½®..."
      - nix build ./nix#{{.BUILD_TARGET}} --extra-experimental-features 'nix-command flakes'
      - echo "ğŸ”„ æ­£åœ¨åˆ‡æ¢åˆ°æ–°é…ç½®..."
      - sudo {{.REBUILD_CMD}} switch --flake ./nix#{{.HOSTNAME}}
      - echo "âœ… nix-darwin é…ç½®åº”ç”¨æˆåŠŸï¼"


  # FIXME å…¶å®å¯ä»¥ç›´æ¥ä½¿ç”¨ åµŒå¥—taskï¼Œç›´æ¥å¤ç”¨buildå°±å¯ä»¥äº†ï¼Œåé¢ç›´æ¥æ·»åŠ å‚æ•° --show-trace
  darwin-debug:
    desc: "ä½¿ç”¨è¯¦ç»†è¾“å‡ºæ„å»ºå¹¶åˆ‡æ¢ï¼ˆç”¨äºè°ƒè¯•ï¼‰"
    cmds:
      - echo "ğŸ› æ­£åœ¨ä½¿ç”¨è°ƒè¯•è¾“å‡ºæ„å»º {{.OS}} é…ç½®..."
      - nix build ./nix#{{.BUILD_TARGET}} --show-trace --verbose --extra-experimental-features 'nix-command flakes'
      - echo "ğŸ”„ æ­£åœ¨ä½¿ç”¨è°ƒè¯•è¾“å‡ºåˆ‡æ¢..."
      - sudo {{.REBUILD_CMD}} switch --flake ./nix#{{.HOSTNAME}} --show-trace --verbose

  # Nix related commands
  update:
    desc: "æ›´æ–°æ‰€æœ‰ flake åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œå¹¶æŸ¥çœ‹æ›´æ–°å†…å®¹"
    cmds:
      # - task: upgrade
      - nix flake update # nix flake update --flake ./nix
      - nix flake show

  upgrade:
    cmds:
      - sudo nix upgrade-nix

  update-input:
    desc: "Update specific flake input (usage: task nix:update-input INPUT=nixpkgs)"
    cmds:
      - nix flake lock --update-input "{{.INPUT}}" ./nix
    requires:
      vars: [INPUT]

  history:
    desc: "List all generations of the system profile"
    cmds:
      - nix profile history --profile /nix/var/nix/profiles/system

  repl:
    desc: "Open a nix repl with the flake"
    cmds:
      - bash -lc 'cd nix && nix repl -f flake:nixpkgs'

  check-config:
    internal: true
    desc: "Check nix-darwin configuration syntax"
    cmds:
      - echo "ğŸ” Checking configuration syntax..."
      - nix flake check .
      - echo "âœ… Configuration syntax is valid"


  prune:
    desc: clean + gc
    cmds:
      - task: clean
      - task: clean-home
      - task: gc


  clean:
    internal: true
    interactive: true
    silent: true
    desc: æ¸…ç† system generationsï¼Œæ³¨æ„ä¸ä¼šç«‹å³åˆ é™¤è½¯ä»¶åŒ…æœ¬èº«
    cmds:
      - echo "ğŸ§¹ Cleaning old system generations (older than {{.CLEANUP_DAYS}} days)..."
      - sudo nix profile wipe-history --profile "{{.SYSTEM_PROFILE}}" --older-than "{{.CLEANUP_DAYS}}d"
      - echo "âœ… System generations cleaned"

  clean-home:
    internal: true
    interactive: true
    silent: true
    desc: æ¸…ç† home-manager generationsï¼ŒåŒæ ·ä¸ä¼šç«‹å³åˆ é™¤è½¯ä»¶åŒ…æœ¬èº«
    cmds:
      - echo "ğŸ§¹ Cleaning home-manager generations..."
      - nix profile wipe-history --profile ~/.local/state/nix/profiles/home-manager --older-than "{{.CLEANUP_DAYS}}d" 2>/dev/null || echo "No home-manager profile found"

  gc:
    internal: true
    interactive: true
    silent: true
    desc: çœŸæ­£åˆ é™¤æ‰€æœ‰æœªè¢«å¼•ç”¨çš„è½¯ä»¶åŒ…ï¼ˆstore pathsï¼‰ï¼Œé‡Šæ”¾ç£ç›˜ç©ºé—´ã€‚ # åªæœ‰è¢« profile å¼•ç”¨çš„åŒ…æ‰ä¼šè¢«è®¤ä¸ºæ˜¯â€œä½¿ç”¨ä¸­â€
    cmds:
      - echo "ğŸ—‘ï¸  Running garbage collection (older than {{.CLEANUP_DAYS}} days)..."
      # - sudo nix-collect-garbage --delete-older-than "{{.CLEANUP_DAYS}}d"
      - nix-collect-garbage --delete-older-than "{{.CLEANUP_DAYS}}d"
      - echo "âœ… Garbage collection completed"


  pin:
    cmds:
      - nix profile list # å·²ç» pin çš„åŒ…
      # nix profile add nixpkgs#<package-name>

  syntax-verify:
    desc: åˆ¤æ–­nixè¯­æ³•æ˜¯å¦æ­£ç¡® # nix-instantiate --parse /Users/luck/Desktop/dotfiles/nix/home/bash.nix > /dev/null && echo "Bash.nix syntax is valid
    cmd: nix-instantiate --parse {{.CLI_ARGS}} > /dev/null && echo "Bash.nix syntax is valid


  rollback:
    desc: å›æ»šåˆ°ä¸Šä¸€ä¸ªgeneration
    cmd: sudo nixos-rebuild switch --rollback #  sudo nixos-rebuild switch --generation 149 # sudo darwin-rebuild switch --switch-generation 72

  # ä» Justfile ç§»æ¤çš„é€šç”¨ Nix ä»»åŠ¡
  test:
    desc: "è¿è¡Œ eval æµ‹è¯•"
    cmds:
      - echo "ğŸ§ª æ­£åœ¨è¿è¡Œ eval æµ‹è¯•..."
      - nix eval .#evalTests --show-trace --print-build-logs --verbose

  repair-store:
    desc: "ä¿®å¤ Nix Store å¯¹è±¡"
    vars:
      paths: '{{.paths}}'
    cmds:
      - 'echo "ğŸ”§ æ­£åœ¨ä¿®å¤ Nix Store å¯¹è±¡: {{.paths}}"'
      - nix store repair {{.paths}}

  up-nix:
    desc: "æ›´æ–°æ‰€æœ‰ Nixpkgs è¾“å…¥"
    cmds:
      - echo "ğŸ“¦ æ­£åœ¨æ›´æ–°æ‰€æœ‰ Nixpkgs è¾“å…¥..."
      - nix flake update nixpkgs nixpkgs-stable nixpkgs-unstable nixpkgs-darwin nixpkgs-ollama
      - echo "âœ… æ‰€æœ‰ Nixpkgs è¾“å…¥æ›´æ–°å®Œæˆ"

  # ä» Justfile ç§»æ¤çš„æ ¼å¼åŒ–ä»»åŠ¡
  fmt:
    desc: "æ ¼å¼åŒ–æ‰€æœ‰ Nix æ–‡ä»¶"
    cmds:
      - echo "ğŸ¨ æ­£åœ¨æ ¼å¼åŒ– Nix æ–‡ä»¶..."
      - find . -name "*.nix" -exec nixfmt {} \;
      - echo "âœ… æ‰€æœ‰ Nix æ–‡ä»¶æ ¼å¼åŒ–å®Œæˆ"

  dev-shell:
    desc: "è¿›å…¥å¼€å‘ç¯å¢ƒ shell"
    cmds:
      - echo "ğŸš æ­£åœ¨è¿›å…¥å¼€å‘ç¯å¢ƒ..."
      - |
        if [[ "{{.OS}}" == "Darwin" ]]; then
          nix shell nixpkgs#git nixpkgs#neovim
        else
          nix shell nixpkgs#git nixpkgs#neovim nixpkgs#colmena
        fi

  verify-store:
    desc: "éªŒè¯ Nix Store å®Œæ•´æ€§ï¼Œæ£€æŸ¥æŸåçš„ store å¯¹è±¡"
    cmds:
      - echo "ğŸ” æ­£åœ¨éªŒè¯ Nix Store å®Œæ•´æ€§..."
      - nix store verify --all
      - echo "âœ… Nix Store éªŒè¯å®Œæˆ"

  gcroot:
    desc: "æ˜¾ç¤ºæ‰€æœ‰è‡ªåŠ¨ GC æ ¹ç›®å½•"
    cmds:
      - echo "ğŸ“‚ Nix Store è‡ªåŠ¨ GC æ ¹ç›®å½•ï¼š"
      - ls -al /nix/var/nix/gcroots/auto/

  reset-launchpad:
    desc: "é‡ç½® Launchpad å¼ºåˆ¶é‡æ–°ç´¢å¼•åº”ç”¨ç¨‹åº"
    platforms: [darwin]
    cmds:
      - echo "ğŸ”„ æ­£åœ¨é‡ç½® Launchpad..."
      - defaults write com.apple.dock ResetLaunchPad -bool true
      - killall Dock
      - echo "âœ… Launchpad é‡ç½®å®Œæˆ"




#  status:
#    desc: "Show comprehensive system status"
#    silent: true
#    cmds:
#      - task: info
#      - task: disk-usage
#      - echo "Recent system generations:"
#      - nix profile history --profile "{{.SYSTEM_PROFILE}}" | head -10 || echo "  Could not read system profile history"



# ssh -t luck@192.168.92.194 "sudo nix-store --delete $(readlink -f /nix/store/zc9s68h7rmbkm23ara98mjzwa2p1jdcl-source) --ignore-liveness"
# é‡åˆ°ä¸€ä¸ª nix/store cacheé—®é¢˜ï¼Œå¯¼è‡´
