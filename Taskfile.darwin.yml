version: '3'

# macOS ä¸“ç”¨ä»»åŠ¡

vars:
  HOSTNAME:
    sh: scutil --get ComputerName | tr ' ' '-' | tr '[:upper:]' '[:lower:]'

tasks:
  # ==================== macOS æ¨¡æ¿ä»»åŠ¡ ====================

  darwin-build-template:
    desc: "macOS æ„å»ºæ¨¡æ¿ä»»åŠ¡"
    vars:
      name: '{{.name}}'
      mode: '{{.mode | default "default"}}'
    cmds:
      - echo "darwin-build '{{.name}}' in '{{.mode}}' mode..."
      - echo "$(printf '=%.0s' {1..50})"
      - |
        TARGET="./nix#darwinConfigurations.{{.name}}.system"
        if [[ "{{.mode}}" == "debug" ]]; then
          nom build $TARGET --extra-experimental-features "nix-command flakes" --show-trace --verbose
        else
          nix build $TARGET --extra-experimental-features "nix-command flakes"
        fi

  darwin-switch-template:
    desc: "macOS åˆ‡æ¢æ¨¡æ¿ä»»åŠ¡"
    vars:
      name: '{{.name}}'
      mode: '{{.mode | default "default"}}'
    cmds:
      - echo "darwin-switch '{{.name}}' in '{{.mode}}' mode..."
      - echo "$(printf '=%.0s' {1..50})"
      - |
        if [[ "{{.mode}}" == "debug" ]]; then
          sudo -E ./result/sw/bin/darwin-rebuild switch --flake "./nix#{{.name}}" --show-trace --verbose
        else
          sudo -E ./result/sw/bin/darwin-rebuild switch --flake "./nix#{{.name}}"
        fi

  darwin-rollback-template:
    desc: "macOS å›æ»šæ¨¡æ¿ä»»åŠ¡"
    cmds:
      - ./result/sw/bin/darwin-rebuild --rollback

  # ==================== macOS å®ç”¨ä»»åŠ¡ ====================

  darwin-set-proxy:
    desc: "è®¾ç½®ç³»ç»Ÿä»£ç†"
    cmds:
      - echo "ğŸŒ æ­£åœ¨è®¾ç½®ç³»ç»Ÿä»£ç†..."
      - sudo python3 scripts/darwin_set_proxy.py
      - sleep 1

  darwin-rollback:
    desc: "macOS ç³»ç»Ÿå›æ»š"
    cmds:
      - task: darwin-rollback-template

  local:
    desc: "æœ¬åœ°éƒ¨ç½² macOS é…ç½®"
    vars:
      mode: '{{.mode | default "default"}}'
    cmds:
      - echo "ğŸš€ æ­£åœ¨æœ¬åœ°éƒ¨ç½² macOS é…ç½®..."
      - task: darwin-build-template
        vars: {name: "{{.HOSTNAME}}", mode: "{{.mode}}"}
      - task: darwin-switch-template
        vars: {name: "{{.HOSTNAME}}", mode: "{{.mode}}"}
