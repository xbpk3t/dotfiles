---
# æœ¬é¡¹ç›®Taskfile.ymlé»˜è®¤ä½œä¸ºNixOSçš„task
# darwin taskéœ€è¦includesè¿›å»

version: '3'

vars:
  REBUILD_CMD: darwin-rebuild
  ZZZ: nix profile history --profile /nix/var/nix/profiles/system
  ROLLBACK: sudo darwin-rebuild switch --rollback
  REPL_WITH_FLAKE: "bash -lc 'cd nix && nix repl -f flake:nixpkgs'"


tasks:

  # sudo env http_proxy=http://127.0.0.1:7890 https_proxy=http://127.0.0.1:7890 nixos-rebuild switch
  #--flake .#intel
  build:
    desc: "æ„å»ºç³»ç»Ÿé…ç½®ï¼ˆä¸åˆ‡æ¢ï¼‰"
    cmds:
      - echo "æ­£åœ¨ä¸º {{.HOSTNAME}} ({{.SYSTEM}}) æ„å»º {{.OS}} é…ç½®..."
      - nix build ./nix#{{.BUILD_TARGET}} --extra-experimental-features 'nix-command flakes'
      - echo "æ„å»ºå®Œæˆï¼"


  build-switch:
    desc: "æ„å»ºå¹¶åˆ‡æ¢åˆ°æ–°é…ç½®"
    cmds:
      - echo "æ­£åœ¨æ„å»ºå¹¶åˆ‡æ¢ {{.OS}} é…ç½®..."
      #      - sudo {{.REBUILD_CMD}} switch --flake .#{{.HOSTNAME}}
      - sudo {{.REBUILD_CMD}} switch --flake .#macos-ws --show-trace # FIXME:
      - echo "åˆ‡æ¢åˆ°æ–°é…ç½®å®Œæˆï¼"


  darwin:
    desc: "æ„å»ºå¹¶åˆ‡æ¢åˆ° nix-darwin é…ç½®"
    cmds:
      - echo "ğŸš€ æ­£åœ¨ä¸º {{.HOSTNAME}} ({{.SYSTEM}}) æ„å»º nix-darwin é…ç½®..."
      - nix build ./nix#{{.BUILD_TARGET}} --extra-experimental-features 'nix-command flakes'
      - echo "ğŸ”„ æ­£åœ¨åˆ‡æ¢åˆ°æ–°é…ç½®..."
      - sudo {{.REBUILD_CMD}} switch --flake ./nix#{{.HOSTNAME}}
      - echo "âœ… nix-darwin é…ç½®åº”ç”¨æˆåŠŸï¼"


  # FIXME: å…¶å®å¯ä»¥ç›´æ¥ä½¿ç”¨ åµŒå¥—taskï¼Œç›´æ¥å¤ç”¨buildå°±å¯ä»¥äº†ï¼Œåé¢ç›´æ¥æ·»åŠ å‚æ•° --show-trace
  darwin-debug:
    desc: "ä½¿ç”¨è¯¦ç»†è¾“å‡ºæ„å»ºå¹¶åˆ‡æ¢ï¼ˆç”¨äºè°ƒè¯•ï¼‰"
    cmds:
      - echo "ğŸ› æ­£åœ¨ä½¿ç”¨è°ƒè¯•è¾“å‡ºæ„å»º {{.OS}} é…ç½®..."
      - nix build ./nix#{{.BUILD_TARGET}} --show-trace --verbose --extra-experimental-features 'nix-command flakes'
      - echo "ğŸ”„ æ­£åœ¨ä½¿ç”¨è°ƒè¯•è¾“å‡ºåˆ‡æ¢..."
      - sudo {{.REBUILD_CMD}} switch --flake ./nix#{{.HOSTNAME}} --show-trace --verbose

  deploy-list:
    desc: "åˆ—å‡º deploy-rs èŠ‚ç‚¹"
    cmds:
      - 'nix eval --raw .#deploy.nodes --apply "x: builtins.concatStringsSep \"\\n\" (builtins.attrNames x)"'

  deploy:
    desc: "deploy-rs éƒ¨ç½²ï¼ˆé»˜è®¤ system profileï¼‰"
    vars:
      HOST:
        sh: 'nix eval --raw .#deploy.nodes --apply "x: builtins.concatStringsSep \"\\n\" (builtins.attrNames x)" | gum choose --header "é€‰æ‹©èŠ‚ç‚¹"'
    cmds:
      - nix run github:serokell/deploy-rs -- .#{{.HOST}}

  deploy-profile:
    desc: "deploy-rs éƒ¨ç½²æŒ‡å®š profile"
    vars:
      HOST:
        sh: 'nix eval --raw .#deploy.nodes --apply "x: builtins.concatStringsSep \"\\n\" (builtins.attrNames x)" | gum choose --header "é€‰æ‹©èŠ‚ç‚¹"'
      PROFILE:
        sh: 'gum input --prompt "Profile åç§° (é»˜è®¤ system): "'
    cmds:
      - |
        profile="{{.PROFILE}}"
        if [[ -z "$profile" ]]; then
          nix run github:serokell/deploy-rs -- .#{{.HOST}}
        else
          nix run github:serokell/deploy-rs -- .#{{.HOST}}."$profile"
        fi
