---
# flake ç›¸å…³ä»»åŠ¡ï¼ˆè·¨å¹³å°ï¼‰

version: '3'



tasks:
  rm:
    desc: "ç”¨æ¥ç§»é™¤æŒ‡å®šflakeåŒ…"
    summary: "task -g rm"
    interactive: true
    cmds:
      - gum confirm "æ˜¯å¦å·²ç»åœ¨flake.nixç§»é™¤æŒ‡å®šflakeåŒ…äº†?"
      - nix flake lock
      - nix flake check
      - nix flake metadata

  update:
    desc: "æ›´æ–°æ‰€æœ‰ flake åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œå¹¶æŸ¥çœ‹æ›´æ–°å†…å®¹"
    summary: "task -g update"
    cmds:
      # - task: upgrade
      - nix flake update # nix flake update --flake ./nix
      - nix flake show


  update-input:
    desc: "Update specific flake input (usage: task nix:update-input INPUT=nixpkgs)"
    summary: "task -g update-input INPUT=<name>"
    vars:
      INPUT: ''
    cmds:
      - nix flake lock --update-input "{{.INPUT}}" ./nix
    requires:
      vars: [INPUT]


  check-config:
    internal: true
    desc: "Check nix-darwin configuration syntax"
    cmds:
      - echo "ğŸ” Checking configuration syntax..."
      - nix flake check .
      - echo "âœ… Configuration syntax is valid"


  # ssh -t luck@192.168.92.194 "sudo nix-store --delete $(readlink -f /nix/store/zc9s68h7rmbkm23ara98mjzwa2p1jdcl-source) --ignore-liveness"
  # é‡åˆ°ä¸€ä¸ª nix/store cacheé—®é¢˜ï¼Œå¯¼è‡´
  why:
    desc: "å®šä½å¤±è´¥ pkgï¼šé€‰æ‹©é…ç½®ç±»å‹/Host + å¤±è´¥ drvï¼Œç„¶åè·‘ why-depends"
    summary: "task -g why"
    interactive: true
    vars:
      KIND:
        sh: 'd="$(nix eval --raw .#darwinConfigurations --apply "x: builtins.toString (builtins.length (builtins.attrNames x))" 2>/dev/null || echo 0)"; n="$(nix eval --raw .#nixosConfigurations --apply "x: builtins.toString (builtins.length (builtins.attrNames x))" 2>/dev/null || echo 0)"; { [ "$d" != "0" ] && echo darwin; [ "$n" != "0" ] && echo nixos; } | gum choose --header "é€‰æ‹©é…ç½®ç±»å‹"'
      HOST:
        sh: 'nix eval --raw ".#{{.KIND}}Configurations" --apply "x: builtins.concatStringsSep \\\"\\n\\\" (builtins.attrNames x)" | gum choose --header "é€‰æ‹© Host"'
      FAILED_DRV:
        sh: 'gum input --prompt "å¤±è´¥ .drv è·¯å¾„: "'
      SYSTEM_DRV:
        sh: 'test "{{.KIND}}" = "darwin" && nix eval --raw ".#darwinConfigurations.{{.HOST}}.system.drvPath" || nix eval --raw ".#nixosConfigurations.{{.HOST}}.config.system.build.toplevel.drvPath"'
    cmds:
      - 'gum style --bold "SYSTEM_DRV: {{.SYSTEM_DRV}}"'
      - 'gum style --bold "FAILED_DRV: {{.FAILED_DRV}}"'
      - 'nix why-depends --all --derivation "{{.SYSTEM_DRV}}" "{{.FAILED_DRV}}" 2>&1 | gum pager'
      - 'gum confirm "çœ‹ nix logï¼Ÿ" && nix log "{{.FAILED_DRV}}" 2>&1 | gum pager || true'
