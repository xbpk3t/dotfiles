version: '3'

vars:
  # 配置：SOPS 源文件路径（可通过调用时传入 SOPS_FILE 覆盖）
  SOPS_FILE: '{{.SOPS_FILE | default (printf "%s/secrets/secrets.yaml" .USER_WORKING_DIR)}}'
  # 配置：age 私钥文件路径（可通过调用时传入 AGE_KEY_FILE 覆盖）
  # 优先使用系统级 sops key（macOS/Linux），否则回退到项目内 age.key
  AGE_KEY_FILE:
    sh: |
      if [ -n "${AGE_KEY_FILE:-}" ]; then
        printf "%s" "$AGE_KEY_FILE"
      elif [ -f "$HOME/Library/Application Support/sops/age/keys.txt" ]; then
        printf "%s" "$HOME/Library/Application Support/sops/age/keys.txt"
      elif [ -f "$HOME/.config/sops/age/keys.txt" ]; then
        printf "%s" "$HOME/.config/sops/age/keys.txt"
      else
        printf "%s" "{{.USER_WORKING_DIR}}/age.key"
      fi
  # 配置：Kubernetes Secret 名称
  K8S_SECRET_NAME: cluster-secrets
  # 配置：Kubernetes 命名空间
  K8S_NAMESPACE: flux-system
  # 配置：生成的集群 Secret 输出目录（可通过调用时传入 OUTPUT_DIR 覆盖）
  OUTPUT_DIR: '{{.OUTPUT_DIR | default (printf "%s/manifests/config/secrets" .USER_WORKING_DIR)}}'
  # 配置：生成的集群 Secret 输出文件（可通过调用时传入 OUTPUT_FILE 覆盖）
  OUTPUT_FILE: '{{.OUTPUT_FILE | default (printf "%s/cluster-secrets.sops.yaml" .OUTPUT_DIR)}}'
  # 配置：SOPS 加密字段匹配规则
  SOPS_ENCRYPTED_REGEX: '^(data|stringData)$'

tasks:
  default:
    desc: "生成集群用的 SOPS Secret（入口任务）"
    deps:
      - k8s:generate

  k8s:check:
    desc: "检查 secrets 与 age 私钥是否存在"
    preconditions:
      - sh: test -f "{{.SOPS_FILE}}"
        msg: "找不到 SOPS 文件: {{.SOPS_FILE}}"
      - sh: test -f "{{.AGE_KEY_FILE}}"
        msg: "找不到 age 私钥文件: {{.AGE_KEY_FILE}}（可通过 AGE_KEY_FILE 覆盖）"
      - sh: command -v sops
        msg: "缺少依赖：sops"
      - sh: command -v yq
        msg: "缺少依赖：yq"
      - sh: command -v jq
        msg: "缺少依赖：jq"
      - sh: command -v age-keygen
        msg: "缺少依赖：age-keygen"

  k8s:ensure-output-dir:
    desc: "确保输出目录存在"
    cmds:
      - 'mkdir -p "{{.OUTPUT_DIR}}"'

  k8s:generate:
    desc: "渲染并加密集群 Secret"
    deps:
      - k8s:check
      - k8s:ensure-output-dir
    vars:
      # 配置：由私钥派生的 age 公钥（用于加密输出）
      AGE_PUBLIC_KEY:
        sh: 'age-keygen -y "{{.AGE_KEY_FILE}}"'
    sources:
      - '{{.SOPS_FILE}}'
      - '{{.AGE_KEY_FILE}}'
    generates:
      - '{{.OUTPUT_FILE}}'
    cmds:
      - |
          set -euo pipefail

          SOPS_AGE_KEY_FILE="{{.AGE_KEY_FILE}}" sops -d "{{.SOPS_FILE}}" | \
            yq eval -o=json '.' - | \
            jq -c '
              del(.sops) as $s |
              {
                apiVersion: "v1",
                kind: "Secret",
                metadata: {
                  name: "{{.K8S_SECRET_NAME}}",
                  namespace: "{{.K8S_NAMESPACE}}"
                },
                stringData: (
                  [ $s | paths(scalars) as $p
                    | { ( $p | map(tostring) | join("_") | ascii_upcase ):
                        ( $s | getpath($p) // "" | tostring )
                      }
                  ] | add
                )
              }
            ' | \
            yq eval -o=yaml - | \
            SOPS_CONFIG=/dev/null sops --encrypt --age "{{.AGE_PUBLIC_KEY}}" --encrypted-regex '{{.SOPS_ENCRYPTED_REGEX}}' \
              --input-type yaml --output-type yaml /dev/stdin > "{{.OUTPUT_FILE}}"

          echo "已生成: {{.OUTPUT_FILE}}"
