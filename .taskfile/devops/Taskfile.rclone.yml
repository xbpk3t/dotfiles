---
version: '3'

vars:
  RCLONE: "rclone"
  RCLONE_REMOTE: "r2"                     # rclone.conf ä¸­çš„å­˜å‚¨é…ç½®å



tasks:
  default:
    desc: ä¸Šä¼ æœ¬åœ°æ–‡ä»¶åˆ°è¿œç¨‹
    summary: "task -g default"
    cmds:
      - task: '{{.TASK}}'
    vars:
      TASK:
        sh: gum choose sync-docs-images bisync-scratches
        msg: é€‰æ‹©å¾…ä¸Šä¼ çš„bucket

  sync:
    internal: true
    desc: rclone sync æ“ä½œ
    vars:
      BUCKET: ''
      DRY_RUN_FLAG: ''
      LOCAL_PATH: ''
    requires:
      vars: [BUCKET, LOCAL_PATH]
    cmds:
#      - '{{.RCLONE}} sync --update --checksum --fast-list --transfers 30 --s3-upload-concurrency 30 "{{.LOCAL_PATH}}" "{{.RCLONE_REMOTE}}:{{.BUCKET}}" --stats=10s --progress {{.DRY_RUN_FLAG}}'
      - '{{.RCLONE}} sync --update --checksum --fast-list --transfers 30 --s3-upload-concurrency 30 "{{.LOCAL_PATH}}" "{{.RCLONE_REMOTE}}:{{.BUCKET}}" --stats-one-line -v {{.DRY_RUN_FLAG}}'

  bisync:
    internal: true
    desc: rclone bisync æ“ä½œ
    vars:
      BUCKET: ''
      DRY_RUN_FLAG: ''
      LOCAL_PATH: ''
    cmds:
      - '{{.RCLONE}} bisync "{{.LOCAL_PATH}}" "{{.RCLONE_REMOTE}}:{{.BUCKET}}" --create-empty-src-dirs --resync --stats-one-line -v {{.DRY_RUN_FLAG}}'
    requires:
      vars: [RCLONE, LOCAL_PATH, RCLONE_REMOTE, BUCKET, DRY_RUN_FLAG]


  check:
    internal: true
    desc: rclone check æ“ä½œ
    vars:
      BUCKET: ''
      DRY_RUN_FLAG: ''
      LOCAL_PATH: ''
    cmds:
      - '{{.RCLONE}} check "{{.LOCAL_PATH}}" "{{.RCLONE_REMOTE}}:{{.BUCKET}}" --size-only --one-way {{.DRY_RUN_FLAG}}'
    requires:
      vars: [RCLONE, LOCAL_PATH, RCLONE_REMOTE, BUCKET, DRY_RUN_FLAG]


  sync-docs-images:
    desc: åŒæ­¥ docs-images åˆ°è¿œç¨‹ï¼ˆç”¨äº systemdï¼‰
    summary: "task -g rclone:sync-docs-images"
    cmds:
      - task: sync
        vars:
          DRY_RUN_FLAG: ""
          BUCKET: "docs"
          LOCAL_PATH: "$HOME/Desktop/docs-images"
      - echo "Execute sync-docs task success"
    preconditions:
      - sh: test -d "$HOME/Desktop/docs-images/"
        msg: "Directory $HOME/Desktop/docs-images does not exist"


  bisync-scratches:
    desc: åŒå‘åŒæ­¥ scratches åˆ° R2
    summary: "task -g rclone:bisync-scratches"
    cmds:
      - task: bisync
        vars:
          LOCAL_PATH:
            sh: |
              jb="$HOME/Library/Application Support/JetBrains"
              ls -d "$jb"/*/scratches 2>/dev/null | head -n1
          DRY_RUN_FLAG: ""
          BUCKET: "scratches"
      - echo "Execute bisync-scratches task success"
    preconditions:
      - sh: test -d "$HOME/Library/Application Support/JetBrains"/*/scratches
        msg: "No JetBrains IDE scratches directory found"

  config:
    desc: æŸ¥çœ‹ rclone ç›¸å…³é…ç½®
    summary: "task -g rclone:config BUCKET=bucket [TARGET_PATH=path]"
    interactive: true
    silent: true
    vars:
      BUCKET: ''
      TARGET_PATH: ''
    requires:
      vars: [BUCKET]
    cmds:
      - echo "rclone é…ç½®æ–‡ä»¶è·¯å¾„"
      - '{{.RCLONE}} config file'
      - echo "ç»Ÿè®¡è¿œç¨‹å­˜å‚¨ä½¿ç”¨é‡"
      - '{{.RCLONE}} size {{.RCLONE_REMOTE}}:{{.BUCKET}}'
      - echo "åˆ—å‡ºæ‰€æœ‰é…ç½®çš„è¿œç¨‹å­˜å‚¨"
      - '{{.RCLONE}} listremotes'
      - echo "åˆ—å‡ºè¿œç¨‹æ–‡ä»¶è¯¦æƒ…ï¼ˆå«å¤§å°/æ—¶é—´ï¼‰" # åˆ—å‡ºæŒ‡å®šè·¯å¾„ä¸‹çš„æ‰€æœ‰çš„æ–‡ä»¶ä»¥åŠæ–‡ä»¶å¤§å°å’Œè·¯å¾„ï¼Œå¹¶ä¸”æ˜¾ç¤ºä¸Šä¼ æ—¶é—´
      - '{{.RCLONE}} lsl {{.RCLONE_REMOTE}}:{{.BUCKET}}/{{.TARGET_PATH}}'


  rev-sync:
    alias: [download]
    internal: true
    desc: "âš ï¸ åŒæ­¥è¿œç¨‹æ–‡ä»¶åˆ°æœ¬åœ°ï¼ˆä¼šåˆ é™¤æœ¬åœ°å¤šä½™æ–‡ä»¶ï¼‰"
    cmds:
      - '{{.RCLONE}} sync {{.RCLONE_REMOTE}}:{{.BUCKET}}/{{.REMOTE_PATH}} {{.LOCAL_PATH}} {{.DRY_RUN_FLAG}}'
    vars:
      REMOTE_PATH: "docs"  # æŒ‡å®šè¿œç¨‹è·¯å¾„
      BUCKET: ''
      DRY_RUN_FLAG: ''
      LOCAL_PATH: ''
    requires:
      vars: [BUCKET, LOCAL_PATH]


  delete:
    internal: true
    desc: "ğŸ”¥ åˆ é™¤è¿œç¨‹æ–‡ä»¶å¤¹å†…å®¹ï¼ˆé»˜è®¤æ¨¡æ‹Ÿæ‰§è¡Œï¼‰"
    cmds:
      - '{{.RCLONE}} delete {{.RCLONE_REMOTE}}:{{.BUCKET}}/{{.TARGET_PATH}} {{.DRY_RUN_FLAG}}'
    vars:
      TARGET_PATH: "x"  # éœ€åˆ é™¤çš„è·¯å¾„
      BUCKET: ''
      DRY_RUN_FLAG: ''
    requires:
      vars: [BUCKET, TARGET_PATH]

  purge:
    internal: true
    desc: "ğŸ”¥ å½»åº•åˆ é™¤è¿œç¨‹æ–‡ä»¶å¤¹ï¼ˆåŒ…æ‹¬ç›®å½•æœ¬èº«ï¼‰"
    cmds:
      - '{{.RCLONE}} purge {{.RCLONE_REMOTE}}:{{.BUCKET}}/{{.TARGET_PATH}} {{.DRY_RUN_FLAG}}'
    vars:
      BUCKET: ''
      DRY_RUN_FLAG: ''
      TARGET_PATH: ''
    requires:
      vars: [BUCKET, TARGET_PATH]


  rmdirs:
    internal: true
    desc: åˆ é™¤æ‰€æœ‰ç©ºç›®å½•
    cmds:
      - '{{.RCLONE}} rmdirs {{.RCLONE_REMOTE}}:{{.BUCKET}}/{{.BASE_PATH}} -v'
    vars:
      BASE_PATH: ''
      BUCKET: ''
    requires:
      vars: [BUCKET]
